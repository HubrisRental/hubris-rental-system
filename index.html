<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubris Rental - Sistema Gestionale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .tabs {
            display: flex;
            background: linear-gradient(90deg, #2c5aa0 0%, #1a4480 100%);
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            padding: 20px 25px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Status Indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #4CAF50; }
        .status-syncing { background: #FF9800; animation: pulse 1s infinite; }
        .status-offline { background: #F44336; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Database Styles */
        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title {
            font-size: 28px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        
        .search-box {
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-box:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .filter-select:focus {
            border-color: #ff9800;
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .btn-danger { background: linear-gradient(135deg, #F44336, #D32F2F); color: white; }
        .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
        
        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #2c5aa0, #1a4480);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }
        
        .data-table tr:hover {
            background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
        }
        
        .category-row {
            background: linear-gradient(135deg, #FF9800, #F57C00) !important;
            color: white;
            font-weight: bold;
        }
        
        .category-row:hover {
            background: linear-gradient(135deg, #F57C00, #EF6C00) !important;
        }
        
        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        /* Quote Management */
        .quote-header {
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
        }
        
        .quote-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 15px;
            align-items: end;
        }
        
        .equipment-section {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .equipment-header {
            background: linear-gradient(135deg, #2c5aa0, #1a4480);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .totals-section {
            background: linear-gradient(135deg, #f8f9ff, #e8f5e8);
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            border: 2px solid #e1e5e9;
        }
        
        .totals-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
        }
        
        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
        }
        
        .total-line.final {
            border-top: 2px solid #2c5aa0;
            padding-top: 12px;
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        /* Saved Quotes */
        .quotes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .quote-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quote-card:hover {
            border-color: #2c5aa0;
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .quote-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        
        .quote-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-draft { background: #fff3e0; color: #f57c00; }
        .status-sent { background: #e8f5e8; color: #4caf50; }
        .status-confirmed { background: #e3f2fd; color: #2196f3; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .quote-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
            
            .quotes-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success { background: #4CAF50; }
        .notification.error { background: #F44336; }
        .notification.info { background: #2196F3; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">🎬 HUBRIS PICTURES S.R.L.</div>
            <div class="user-info">
                <span class="status-indicator status-online"></span>
                <span>Online</span>
                <span>|</span>
                <span id="currentUser">Sistema Multi-Utente</span>
                <span>|</span>
                <span id="lastSync">Ultimo sync: ora</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('database')">
                🗄️ Database
            </button>
            <button class="tab" onclick="showTab('quotes')">
                📋 Nuovo Preventivo
            </button>
            <button class="tab" onclick="showTab('saved')">
                💾 Preventivi Salvati
            </button>
            <button class="tab" onclick="showTab('analytics')">
                📊 Analytics
            </button>
        </div>

        <!-- DATABASE TAB -->
        <div id="database" class="tab-content active">
            <div class="section-header">
                <h2 class="section-title">Database Attrezzature</h2>
            </div>
            
            <div class="controls-grid">
                <input type="text" class="search-box" placeholder="🔍 Cerca attrezzatura..." onkeyup="filterDatabase()">
                <select class="filter-select" onchange="filterByCategory()">
                    <option value="">Tutte le categorie</option>
                </select>
                <button class="btn btn-success" onclick="addNewEquipment()">+ Nuova</button>
                <button class="btn btn-warning" onclick="syncDatabase()">
                    <span class="loading" id="syncLoader" style="display: none;"></span>
                    🔄 Sync
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table" id="databaseTable">
                    <thead>
                        <tr>
                            <th>Attrezzatura</th>
                            <th>1 Giorno</th>
                            <th>3 Giorni</th>
                            <th>1 Settimana</th>
                            <th>Valore Assic.</th>
                            <th>Kit/Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="databaseBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                <div class="loading"></div>
                                <div style="margin-top: 10px;">Caricamento database da Google Sheets...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- QUOTES TAB -->
        <div id="quotes" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Nuovo Preventivo</h2>
            </div>
            
            <div class="quote-header">
                <div class="quote-controls">
                    <div class="form-group">
                        <label class="form-label">Nome Preventivo</label>
                        <input type="text" class="form-input" id="quoteName" placeholder="Es: Spot TV Audi Q3">
                    </div>
                    <button class="btn btn-success" onclick="saveQuote()">💾 Salva</button>
                    <button class="btn btn-info" onclick="loadQuote()">📂 Carica</button>
                    <button class="btn btn-warning" onclick="duplicateQuote()">📄 Duplica</button>
                    <button class="btn btn-danger" onclick="resetQuote()">🔄 Reset</button>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <input type="text" class="form-input" id="cliente" placeholder="Nome del cliente">
                </div>
                <div class="form-group">
                    <label class="form-label">Contatti</label>
                    <input type="text" class="form-input" id="contatti" placeholder="Telefono/Email">
                </div>
                <div class="form-group">
                    <label class="form-label">Data Carico</label>
                    <input type="date" class="form-input" id="carico">
                </div>
                <div class="form-group">
                    <label class="form-label">Data Scarico</label>
                    <input type="date" class="form-input" id="scarico">
                </div>
            </div>
            
            <div class="form-grid" style="grid-template-columns: auto auto auto 1fr auto;">
                <div class="form-group">
                    <label class="form-label">Durata (giorni)</label>
                    <input type="number" class="form-input" id="durata" value="1" min="1" max="30" onchange="updateAllPrices()" style="width: 100px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Sconto (%)</label>
                    <input type="number" class="form-input" id="sconto" value="0" min="0" max="50" step="0.1" onchange="updateTotals()" style="width: 100px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-input" id="quoteType">
                        <option value="rental">Noleggio</option>
                        <option value="sale">Vendita</option>
                        <option value="service">Servizio</option>
                    </select>
                </div>
                <div></div>
                <button class="btn btn-primary" onclick="addEquipmentRow()">+ Attrezzatura</button>
            </div>
            
            <div class="equipment-section">
                <div class="equipment-header">
                    <h3>Lista Attrezzature</h3>
                    <div>
                        <button class="btn btn-info" onclick="generatePDF()">📄 PDF</button>
                        <button class="btn btn-warning" onclick="generateInsurance()">🛡️ Assicurazione</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 180px;">Categoria</th>
                            <th style="width: 220px;">Attrezzatura</th>
                            <th style="width: 80px;">Qtà</th>
                            <th style="width: 120px;">Prezzo Unit.</th>
                            <th style="width: 120px;">Totale</th>
                            <th style="width: 80px;">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentRows">
                        <!-- Righe dinamiche -->
                    </tbody>
                </table>
            </div>
            
            <div class="totals-section">
                <div class="totals-grid">
                    <div>
                        <div class="total-line">
                            <span>Subtotale:</span>
                            <span id="subtotale">€ 0.00</span>
                        </div>
                        <div class="total-line">
                            <span>Sconto (<span id="discount-percent">0</span>%):</span>
                            <span id="sconto-amount">€ 0.00</span>
                        </div>
                        <div class="total-line">
                            <span>Imponibile:</span>
                            <span id="imponibile">€ 0.00</span>
                        </div>
                        <div class="total-line">
                            <span>IVA (22%):</span>
                            <span id="iva">€ 0.00</span>
                        </div>
                        <div class="total-line final">
                            <span>TOTALE:</span>
                            <span id="totale">€ 0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAVED QUOTES TAB -->
        <div id="saved" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Preventivi Salvati</h2>
                <button class="btn btn-warning" onclick="syncQuotes()">🔄 Aggiorna Lista</button>
            </div>
            
            <div class="quotes-grid" id="savedQuotes">
                <div class="quote-card">
                    <div class="quote-title">Caricamento...</div>
                    <div class="quote-meta">Sincronizzazione con Google Sheets in corso...</div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Analytics & Statistiche</h2>
            </div>
            
            <div class="form-grid">
                <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                    <h3 style="color: #2c5aa0; margin-bottom: 10px;">Preventivi Questo Mese</h3>
                    <div style="font-size: 36px; font-weight: bold; color: #4CAF50;" id="monthlyQuotes">-</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                    <h3 style="color: #2c5aa0; margin-bottom: 10px;">Fatturato Stimato</h3>
                    <div style="font-size: 36px; font-weight: bold; color: #FF9800;" id="estimatedRevenue">-</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                    <h3 style="color: #2c5aa0; margin-bottom: 10px;">Attrezzature Più Richieste</h3>
                    <div style="font-size: 18px; font-weight: bold; color: #2196F3;" id="topEquipment">-</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                    <h3 style="color: #2c5aa0; margin-bottom: 10px;">Tasso di Conversione</h3>
                    <div style="font-size: 36px; font-weight: bold; color: #9C27B0;" id="conversionRate">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE GOOGLE SHEETS
        const CONFIG = {
            SHEETS_ID: '1SLA0PwsRnQ0ow6TuUZPsZ0d9tcUqpJKR_IFMSKI9g1s',
            API_KEY: 'TUA_API_KEY_QUI', // Da configurare
            DATABASE_RANGE: 'Database!A:G',
            QUOTES_RANGE: 'Preventivi_Salvati!A:Z'
        };

        // STATO GLOBALE
        let equipmentDatabase = {};
        let savedQuotes = [];
        let currentQuote = null;
        let rowCounter = 0;
        let isOnline = true;

        // SIMULAZIONE DATI (per testing senza API)
        const MOCK_DATA = [
            {category: "MACCHINA DA PRESA", name: "Alexa Mini", price1: 0, price3: 0, price7: 0, insurance: 75000, kit: ""},
            {category: "MACCHINA DA PRESA", name: "Red Komodo", price1: 110, price3: 275, price7: 385, insurance: 0, kit: ""},
            {category: "MACCHINA DA PRESA", name: "Blackmagic Pocket 6K", price1: 60, price3: 150, price7: 210, insurance: 2518, kit: "Kit completo con batterie e schede"},
            {category: "LENTI", name: "Zeiss vintage FF", price1: 150, price3: 20, price7: 40, insurance: 0, kit: "Set completo lenti vintage"},
            {category: "LENTI", name: "Leica R (SUMMICRON) (EF)", price1: 80, price3: 200, price7: 280, insurance: 15000, kit: ""},
            {category: "ACCESSORI MDP", name: "Follow Focus", price1: 25, price3: 65, price7: 90, insurance: 0, kit: ""},
            {category: "ACCESSORI MDP", name: "Matte Box", price1: 30, price3: 75, price7: 105, insurance: 0, kit: ""},
            {category: "MONITOR", name: "SmallHD 503", price1: 40, price3: 100, price7: 140, insurance: 0, kit: ""},
            {category: "LIGHT", name: "Aputure 300D", price1: 50, price3: 125, price7: 175, insurance: 0, kit: ""},
            {category: "GRIP", name: "Treppiede Carbon", price1: 25, price3: 65, price7: 90, insurance: 0, kit: ""}
        ];

        // GOOGLE SHEETS INTEGRATION
        async function loadFromGoogleSheets() {
            showNotification('🔄 Sincronizzazione con Google Sheets...', 'info');
            
            try {
                // Qui andrà la vera chiamata API a Google Sheets
                // Per ora usiamo dati mock
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simula loading
                
                processEquipmentData(MOCK_DATA);
                loadMockQuotes();
                
                showNotification('✅ Database aggiornato!', 'success');
                updateSyncStatus('ora');
                
            } catch (error) {
                console.error('Errore sync:', error);
                showNotification('❌ Errore di sincronizzazione', 'error');
                isOnline = false;
                updateConnectionStatus();
            }
        }

        function processEquipmentData(data) {
            equipmentDatabase = {};
            
            data.forEach(item => {
                if (!equipmentDatabase[item.category]) {
                    equipmentDatabase[item.category] = {};
                }
                equipmentDatabase[item.category][item.name] = {
                    price1: item.price1,
                    price3: item.price3,
                    price7: item.price7,
                    insurance: item.insurance,
                    kit: item.kit
                };
            });
            
            renderDatabase(data);
            updateCategoryFilter();
        }

        function renderDatabase(data) {
            const tbody = document.getElementById('databaseBody');
            tbody.innerHTML = '';
            
            let currentCategory = '';
            data.forEach((item, index) => {
                if (item.category !== currentCategory) {
                    const categoryRow = document.createElement('tr');
                    categoryRow.className = 'category-row';
                    categoryRow.innerHTML = `
                        <td colspan="7" style="text-align: center; font-weight: bold;">
                            📁 ${item.category}
                        </td>
                    `;
                    tbody.appendChild(categoryRow);
                    currentCategory = item.category;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${item.name}</td>
                    <td>€ ${item.price1.toFixed(2)}</td>
                    <td>€ ${item.price3.toFixed(2)}</td>
                    <td>€ ${item.price7.toFixed(2)}</td>
                    <td>€ ${item.insurance.toLocaleString()}</td>
                    <td style="font-size: 12px; color: #666; max-width: 200px;">${item.kit}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editEquipment(${index})" style="padding: 6px 12px; font-size: 12px;">✏️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCategoryFilter() {
            const filter = document.querySelector('.filter-select');
            filter.innerHTML = '<option value="">Tutte le categorie</option>';
            
            Object.keys(equipmentDatabase).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filter.appendChild(option);
            });
        }

        function loadMockQuotes() {
            savedQuotes = [
                {
                    id: 1,
                    name: "Spot TV Audi Q3",
                    cliente: "Publicis Italia",
                    contatti: "marco.rossi@publicis.it",
                    carico: "2025-07-25",
                    scarico: "2025-07-27",
                    durata: 3,
                    sconto: 10,
                    createdAt: "19/07/2025, 14:30",
                    status: "sent",
                    total: 2850,
                    equipment: [
                        {category: "MACCHINA DA PRESA", equipment: "Red Komodo", quantity: 1},
                        {category: "LENTI", equipment: "Zeiss vintage FF", quantity: 1}
                    ]
                },
                {
                    id: 2,
                    name: "Videoclip Indie Band",
                    cliente: "Marco Indie",
                    contatti: "+39 348 123456",
                    carico: "2025-07-22",
                    scarico: "2025-07-23",
                    durata: 1,
                    sconto: 0,
                    createdAt: "18/07/2025, 11:20",
                    status: "draft",
                    total: 380,
                    equipment: [
                        {category: "LENTI", equipment: "Zeiss vintage FF", quantity: 1},
                        {category: "LIGHT", equipment: "Aputure 300D", quantity: 2}
                    ]
                },
                {
                    id: 3,
                    name: "Corporate Video BMW",
                    cliente: "BMW Italia S.p.A.",
                    contatti: "produzione@bmw.it",
                    carico: "2025-07-30",
                    scarico: "2025-08-02",
                    durata: 3,
                    sconto: 15,
                    createdAt: "17/07/2025, 09:15",
                    status: "confirmed",
                    total: 4200,
                    equipment: [
                        {category: "MACCHINA DA PRESA", equipment: "Alexa Mini", quantity: 1},
                        {category: "LENTI", equipment: "Leica R (SUMMICRON) (EF)", quantity: 1},
                        {category: "MONITOR", equipment: "SmallHD 503", quantity: 2}
                    ]
                }
            ];
            renderSavedQuotes();
            updateAnalytics();
        }

        // TAB MANAGEMENT
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // QUOTE MANAGEMENT
        function addEquipmentRow() {
            rowCounter++;
            const tbody = document.getElementById('equipmentRows');
            const row = document.createElement('tr');
            row.className = 'equipment-row';
            row.id = `row-${rowCounter}`;
            row.style.background = '#f8f9ff';
            
            row.innerHTML = `
                <td>
                    <select class="form-input" onchange="updateEquipmentOptions(${rowCounter})" id="category-${rowCounter}" style="width: 100%;">
                        <option value="">Seleziona categoria...</option>
                        ${Object.keys(equipmentDatabase).map(cat => 
                            `<option value="${cat}">${cat}</option>`
                        ).join('')}
                    </select>
                </td>
                <td>
                    <select class="form-input" onchange="updateRowData(${rowCounter})" id="equipment-${rowCounter}" style="width: 100%;" disabled>
                        <option value="">Prima seleziona categoria</option>
                    </select>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;" id="kit-${rowCounter}"></div>
                </td>
                <td>
                    <input type="number" class="form-input" value="1" min="1" onchange="updateRowTotal(${rowCounter})" id="qty-${rowCounter}" style="width: 100%; text-align: center;">
                </td>
                <td style="text-align: right; font-weight: bold; color: #2e7d32;" id="price-${rowCounter}">€ 0.00</td>
                <td style="text-align: right; font-weight: bold; color: #2e7d32;" id="total-${rowCounter}">€ 0.00</td>
                <td>
                    <button class="btn btn-danger" onclick="removeRow(${rowCounter})" style="padding: 6px 12px; font-size: 12px;">✕</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        function updateEquipmentOptions(rowId) {
            const categorySelect = document.getElementById(`category-${rowId}`);
            const equipmentSelect = document.getElementById(`equipment-${rowId}`);
            const category = categorySelect.value;
            
            equipmentSelect.innerHTML = '<option value="">Seleziona attrezzatura...</option>';
            
            if (category && equipmentDatabase[category]) {
                equipmentSelect.disabled = false;
                Object.keys(equipmentDatabase[category]).forEach(equipment => {
                    const option = document.createElement('option');
                    option.value = equipment;
                    option.textContent = equipment;
                    equipmentSelect.appendChild(option);
                });
            } else {
                equipmentSelect.disabled = true;
            }
            
            document.getElementById(`kit-${rowId}`).textContent = '';
            document.getElementById(`price-${rowId}`).textContent = '€ 0.00';
            document.getElementById(`total-${rowId}`).textContent = '€ 0.00';
            updateTotals();
        }

        function updateRowData(rowId) {
            const categorySelect = document.getElementById(`category-${rowId}`);
            const equipmentSelect = document.getElementById(`equipment-${rowId}`);
            const category = categorySelect.value;
            const equipment = equipmentSelect.value;
            
            if (category && equipment && equipmentDatabase[category][equipment]) {
                const data = equipmentDatabase[category][equipment];
                const duration = parseInt(document.getElementById('durata').value);
                const price = calculatePrice(data.price1, data.price3, data.price7, duration);
                
                document.getElementById(`price-${rowId}`).textContent = `€ ${price.toFixed(2)}`;
                document.getElementById(`kit-${rowId}`).textContent = data.kit;
                updateRowTotal(rowId);
            }
        }

        function calculatePrice(price1, price3, price7, duration) {
            if (duration === 1) return price1;
            if (duration === 2) return price1 * 2;
            if (duration === 3) return price3;
            if (duration === 4) return price3 + price1;
            if (duration === 5) return price7;
            if (duration === 6) return price7 + price1;
            if (duration === 7) return price7 + (price1 * 2);
            if (duration === 8) return price7 + price3;
            if (duration === 9) return price7 + price3 + price1;
            if (duration >= 10) return price7 * 2;
            return price1;
        }

        function updateRowTotal(rowId) {
            const priceText = document.getElementById(`price-${rowId}`).textContent;
            const quantity = parseInt(document.getElementById(`qty-${rowId}`).value) || 0;
            const price = parseFloat(priceText.replace('€ ', '')) || 0;
            const total = price * quantity;
            
            document.getElementById(`total-${rowId}`).textContent = `€ ${total.toFixed(2)}`;
            updateTotals();
        }

        function updateAllPrices() {
            const rows = document.querySelectorAll('[id^="row-"]');
            rows.forEach(row => {
                const rowId = row.id.split('-')[1];
                updateRowData(rowId);
            });
        }

        function updateTotals() {
            const totalCells = document.querySelectorAll('[id^="total-"]');
            let subtotal = 0;
            
            totalCells.forEach(cell => {
                const value = parseFloat(cell.textContent.replace('€ ', '')) || 0;
                subtotal += value;
            });
            
            const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const imponibile = subtotal - discountAmount;
            const iva = imponibile * 0.22;
            const totale = imponibile + iva;
            
            document.getElementById('subtotale').textContent = `€ ${subtotal.toFixed(2)}`;
            document.getElementById('discount-percent').textContent = discountPercent.toFixed(1);
            document.getElementById('sconto-amount').textContent = `€ ${discountAmount.toFixed(2)}`;
            document.getElementById('imponibile').textContent = `€ ${imponibile.toFixed(2)}`;
            document.getElementById('iva').textContent = `€ ${iva.toFixed(2)}`;
            document.getElementById('totale').textContent = `€ ${totale.toFixed(2)}`;
        }

        function removeRow(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            if (row) {
                row.remove();
                updateTotals();
            }
        }

        function saveQuote() {
            const quoteName = document.getElementById('quoteName').value;
            if (!quoteName) {
                showNotification('❌ Inserisci un nome per il preventivo!', 'error');
                return;
            }

            const quote = {
                id: Date.now(),
                name: quoteName,
                cliente: document.getElementById('cliente').value,
                contatti: document.getElementById('contatti').value,
                carico: document.getElementById('carico').value,
                scarico: document.getElementById('scarico').value,
                durata: document.getElementById('durata').value,
                sconto: document.getElementById('sconto').value,
                equipment: [],
                createdAt: new Date().toLocaleString('it-IT'),
                status: 'draft',
                total: parseFloat(document.getElementById('totale').textContent.replace('€ ', '')) || 0
            };

            document.querySelectorAll('[id^="row-"]').forEach(row => {
                const rowId = row.id.split('-')[1];
                const category = document.getElementById(`category-${rowId}`)?.value;
                const equipment = document.getElementById(`equipment-${rowId}`)?.value;
                const quantity = document.getElementById(`qty-${rowId}`)?.value;
                
                if (category && equipment) {
                    quote.equipment.push({
                        category, equipment, quantity
                    });
                }
            });

            savedQuotes.push(quote);
            renderSavedQuotes();
            updateAnalytics();
            showNotification(`✅ Preventivo "${quoteName}" salvato!`, 'success');
            
            // Simula salvataggio su Google Sheets
            console.log('Salvataggio su Google Sheets:', quote);
        }

        function renderSavedQuotes() {
            const container = document.getElementById('savedQuotes');
            container.innerHTML = '';
            
            if (savedQuotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>Nessun preventivo salvato</h3>
                        <p>Crea il tuo primo preventivo nella sezione "Nuovo Preventivo"</p>
                    </div>
                `;
                return;
            }
            
            savedQuotes.forEach(quote => {
                const div = document.createElement('div');
                div.className = 'quote-card';
                div.innerHTML = `
                    <div class="quote-title">${quote.name}</div>
                    <div class="quote-meta">
                        <strong>Cliente:</strong> ${quote.cliente}<br>
                        <strong>Durata:</strong> ${quote.durata} giorni<br>
                        <strong>Totale:</strong> € ${quote.total.toFixed(2)}<br>
                        <strong>Creato:</strong> ${quote.createdAt}
                    </div>
                    <div style="margin-top: 15px;">
                        <span class="status-badge status-${quote.status}">
                            ${quote.status === 'draft' ? 'Bozza' : 
                              quote.status === 'sent' ? 'Inviato' : 'Confermato'}
                        </span>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="loadQuoteById(${quote.id})" style="padding: 6px 12px; font-size: 12px;">📂 Carica</button>
                            <button class="btn btn-warning" onclick="duplicateQuoteById(${quote.id})" style="padding: 6px 12px; font-size: 12px;">📄 Duplica</button>
                            <button class="btn btn-danger" onclick="deleteQuote(${quote.id})" style="padding: 6px 12px; font-size: 12px;">🗑️</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function loadQuoteById(quoteId) {
            const quote = savedQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            document.getElementById('quoteName').value = quote.name;
            document.getElementById('cliente').value = quote.cliente;
            document.getElementById('contatti').value = quote.contatti;
            document.getElementById('carico').value = quote.carico;
            document.getElementById('scarico').value = quote.scarico;
            document.getElementById('durata').value = quote.durata;
            document.getElementById('sconto').value = quote.sconto;
            
            document.getElementById('equipmentRows').innerHTML = '';
            rowCounter = 0;
            
            quote.equipment.forEach(item => {
                addEquipmentRow();
                document.getElementById(`category-${rowCounter}`).value = item.category;
                updateEquipmentOptions(rowCounter);
                setTimeout(() => {
                    document.getElementById(`equipment-${rowCounter}`).value = item.equipment;
                    updateRowData(rowCounter);
                    document.getElementById(`qty-${rowCounter}`).value = item.quantity;
                    updateRowTotal(rowCounter);
                }, 100);
            });
            
            showTab('quotes');
            document.querySelector('[onclick="showTab(\'quotes\')"]').classList.add('active');
            showNotification(`✅ Preventivo "${quote.name}" caricato!`, 'success');
        }

        function duplicateQuoteById(quoteId) {
            const quote = savedQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            loadQuoteById(quoteId);
            document.getElementById('quoteName').value = quote.name + ' - Copia';
            showNotification(`📄 Preventivo duplicato! Modifica il nome e salva.`, 'info');
        }

        function deleteQuote(quoteId) {
            const quote = savedQuotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            if (confirm(`Sei sicuro di voler eliminare il preventivo "${quote.name}"?`)) {
                savedQuotes = savedQuotes.filter(q => q.id !== quoteId);
                renderSavedQuotes();
                updateAnalytics();
                showNotification(`🗑️ Preventivo eliminato`, 'info');
            }
        }

        function resetQuote() {
            if (confirm('Sei sicuro di voler cancellare tutto il preventivo?')) {
                document.getElementById('equipmentRows').innerHTML = '';
                document.getElementById('cliente').value = '';
                document.getElementById('contatti').value = '';
                document.getElementById('carico').value = '';
                document.getElementById('scarico').value = '';
                document.getElementById('durata').value = '1';
                document.getElementById('sconto').value = '0';
                document.getElementById('quoteName').value = '';
                updateTotals();
                showNotification('🔄 Preventivo resettato', 'info');
            }
        }

        // UTILITY FUNCTIONS
        function filterDatabase() {
            const searchTerm = event.target.value.toLowerCase();
            const rows = document.querySelectorAll('#databaseBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByCategory() {
            const selectedCategory = event.target.value;
            const rows = document.querySelectorAll('#databaseBody tr');
            
            if (!selectedCategory) {
                rows.forEach(row => row.style.display = '');
                return;
            }
            
            let showNextItems = false;
            rows.forEach(row => {
                if (row.classList.contains('category-row')) {
                    const categoryText = row.textContent.trim().replace('📁 ', '');
                    showNextItems = (categoryText === selectedCategory);
                    row.style.display = showNextItems ? '' : 'none';
                } else {
                    row.style.display = showNextItems ? '' : 'none';
                }
            });
        }

        function syncDatabase() {
            const loader = document.getElementById('syncLoader');
            loader.style.display = 'inline-block';
            loadFromGoogleSheets().finally(() => {
                loader.style.display = 'none';
            });
        }

        function syncQuotes() {
            showNotification('🔄 Aggiornamento lista preventivi...', 'info');
            setTimeout(() => {
                renderSavedQuotes();
                showNotification('✅ Lista aggiornata!', 'success');
            }, 1000);
        }

        function updateAnalytics() {
            const thisMonth = savedQuotes.filter(q => {
                const created = new Date(q.createdAt.split(', ')[0].split('/').reverse().join('-'));
                const now = new Date();
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            });
            
            const totalRevenue = thisMonth.reduce((sum, q) => sum + q.total, 0);
            const confirmedQuotes = savedQuotes.filter(q => q.status === 'confirmed').length;
            const conversionRate = savedQuotes.length > 0 ? (confirmedQuotes / savedQuotes.length * 100) : 0;
            
            document.getElementById('monthlyQuotes').textContent = thisMonth.length;
            document.getElementById('estimatedRevenue').textContent = `€ ${totalRevenue.toFixed(0)}`;
            document.getElementById('conversionRate').textContent = `${conversionRate.toFixed(1)}%`;
            
            // Equipment più richiesto
            const equipmentCount = {};
            savedQuotes.forEach(quote => {
                quote.equipment.forEach(item => {
                    equipmentCount[item.equipment] = (equipmentCount[item.equipment] || 0) + 1;
                });
            });
            
            const mostRequested = Object.keys(equipmentCount).reduce((a, b) => 
                equipmentCount[a] > equipmentCount[b] ? a : b, 'N/A'
            );
            document.getElementById('topEquipment').textContent = mostRequested;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateSyncStatus(time) {
            document.getElementById('lastSync').textContent = `Ultimo sync: ${time}`;
        }

        function updateConnectionStatus() {
            const indicator = document.querySelector('.status-indicator');
            const status = document.querySelector('.user-info span');
            
            if (isOnline) {
                indicator.className = 'status-indicator status-online';
                status.textContent = 'Online';
            } else {
                indicator.className = 'status-indicator status-offline';
                status.textContent = 'Offline';
            }
        }

        // PLACEHOLDER FUNCTIONS
        function addNewEquipment() {
            showNotification('🔧 Funzione in sviluppo: Aggiungi nuova attrezzatura', 'info');
        }

        function editEquipment(index) {
            showNotification('🔧 Funzione in sviluppo: Modifica attrezzatura', 'info');
        }

        function generatePDF() {
            showNotification('📄 Generazione PDF in corso...', 'info');
            setTimeout(() => {
                showNotification('✅ PDF generato! (funzione da implementare)', 'success');
            }, 2000);
        }

        function generateInsurance() {
            showNotification('🛡️ Generazione valori assicurativi...', 'info');
            setTimeout(() => {
                showNotification('✅ Documento assicurativo pronto! (funzione da implementare)', 'success');
            }, 2000);
        }

        function loadQuote() {
            if (savedQuotes.length === 0) {
                showNotification('❌ Nessun preventivo salvato!', 'error');
                return;
            }
            
            showTab('saved');
            document.querySelector('[onclick="showTab(\'saved\')"]').classList.add('active');
            showNotification('📂 Seleziona un preventivo dalla lista', 'info');
        }

        function duplicateQuote() {
            const quoteName = document.getElementById('quoteName').value;
            if (!quoteName) {
                showNotification('❌ Nessun preventivo da duplicare!', 'error');
                return;
            }
            
            document.getElementById('quoteName').value = quoteName + ' - Copia';
            showNotification('📄 Preventivo duplicato! Modifica il nome e salva.', 'info');
        }

        // INITIALIZATION
        window.addEventListener('load', function() {
            loadFromGoogleSheets();
            addEquipmentRow();
            updateConnectionStatus();
            
            // Auto-save ogni 30 secondi (se ci sono modifiche)
            setInterval(() => {
                updateSyncStatus('30s fa');
            }, 30000);
        });

        // PWA Support - Disabilitato per ora
        // if ('serviceWorker' in navigator) {
        //     navigator.serviceWorker.register('/sw.js').catch(console.error);
        // }
    </script>
</body>
</html>
                    