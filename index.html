<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubris Rental - Sistema Completo</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Trebuchet MS', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #2c5aa0; }
        .connection-status { display: flex; align-items: center; gap: 15px; font-size: 14px; color: #666; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background: #4CAF50; }
        .status-syncing { background: #FF9800; animation: pulse 1s infinite; }
        .status-offline { background: #F44336; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .container { max-width: 1400px; margin: 20px auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; backdrop-filter: blur(10px); }
        .tabs { display: flex; background: linear-gradient(90deg, #2c5aa0 0%, #1a4480 100%); overflow-x: auto; }
        .tab { flex: 1; padding: 20px 25px; cursor: pointer; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-weight: 600; font-size: 16px; transition: all 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-2px); }
        .tab:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .btn-danger { background: linear-gradient(135deg, #F44336, #D32F2F); color: white; }
        .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
        .form-input { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; outline: none; transition: all 0.3s ease; }
        .form-input:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; font-weight: bold; z-index: 1000; animation: slideIn 0.3s ease; max-width: 300px; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #F44336; }
        .notification.info { background: #2196F3; }
        .notification.warning { background: #FF9800; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); max-height: 600px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        .data-table tr:hover { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); }
        .category-row { background: linear-gradient(135deg, #FF9800, #F57C00) !important; color: white; font-weight: bold; }
        .category-row:hover { background: linear-gradient(135deg, #F57C00, #EF6C00) !important; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .section-title { font-size: 28px; font-weight: bold; color: #2c5aa0; }
        .controls-grid { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; margin-bottom: 25px; align-items: center; }
        .search-box { padding: 12px 20px; border: 2px solid #e1e5e9; border-radius: 25px; font-size: 16px; outline: none; transition: all 0.3s ease; background: white; }
        .search-box:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-select { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 12px; background: white; font-size: 14px; cursor: pointer; outline: none; transition: border-color 0.3s ease; }
        .filter-select:focus { border-color: #ff9800; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
        .quote-header { background: linear-gradient(135deg, #f8f9ff, #e3f2fd); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #e1e5e9; }
        .quote-controls { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 15px; align-items: end; }
        .equipment-section { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .equipment-header { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .totals-section { background: linear-gradient(135deg, #f8f9ff, #e8f5e8); padding: 25px; border-radius: 15px; margin-top: 25px; border: 2px solid #e1e5e9; }
        .total-line { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; }
        .total-line.final { border-top: 2px solid #2c5aa0; padding-top: 12px; margin-top: 15px; font-size: 20px; font-weight: bold; color: #2c5aa0; }
        .quotes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .quote-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; }
        .quote-card:hover { border-color: #2c5aa0; transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .quote-title { font-size: 18px; font-weight: bold; color: #2c5aa0; margin-bottom: 10px; }
        .quote-meta { font-size: 13px; color: #666; margin-bottom: 15px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-draft { background: #fff3e0; color: #f57c00; }
        .status-sent { background: #e8f5e8; color: #4caf50; }
        .status-confirmed { background: #e3f2fd; color: #2196f3; }
        @media (max-width: 768px) { .nav-content { flex-direction: column; gap: 10px; } .container { margin: 10px; border-radius: 15px; } .tab-content { padding: 20px; } .controls-grid { grid-template-columns: 1fr; gap: 10px; } .form-grid { grid-template-columns: 1fr; } .quote-controls { grid-template-columns: 1fr; gap: 10px; } .data-table { font-size: 12px; } .data-table th, .data-table td { padding: 8px 6px; } .quotes-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="navbar">
    <div class="nav-content">
      <div class="logo" style="display: flex; align-items: center; gap: 10px;">
    <img src="https://i.imgur.com/ABMgyI8.png" alt="Hubris Pictures Logo" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;">
    <span style="font-size: 20px; font-weight: bold; color: #2c5aa0;">HUBRIS PICTURES S.R.L.</span>
</div>
        <div class="connection-status">
            <span class="status-indicator" id="connectionStatus"></span>
            <span id="connectionText">Connecting...</span>
            <span>|</span>
            <span id="lastSync">Ultimo sync: mai</span>
            <span>|</span>
            <button class="btn btn-warning" onclick="showConfigModal()" style="padding: 6px 12px; font-size: 12px;">⚙️ Config</button>
        </div>
    </div>
</nav>
<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('database')">🗄️ Database</button>
        <button class="tab" onclick="showTab('quotes')">📋 Nuovo Preventivo</button>
        <button class="tab" onclick="showTab('saved')">💾 Preventivi Salvati</button>
        <button class="tab" onclick="showTab('analytics')">📊 Analytics</button>
    </div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #2c5aa0; margin-bottom: 20px;">⚙️ Configurazione Sistema</h2>
            <div style="background: linear-gradient(135deg, #fff3e0, #ffeaa7); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ff9800;">
                <div style="font-size: 18px; font-weight: bold; color: #f57c00; margin-bottom: 15px;">🔑 Google Sheets API</div>
                <div class="form-group">
                    <label class="form-label">API Key:</label>
                    <input type="text" class="form-input" id="apiKeyInput" placeholder="Inserisci la tua API Key">
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">Sheets ID:</label>
                    <input type="text" class="form-input" id="sheetsIdInput" placeholder="ID del tuo Google Sheets">
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">ℹ️ Inserisci le credenziali per collegare il sistema al tuo database Google Sheets</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeConfigModal()">Annulla</button>
                <button class="btn btn-success" onclick="saveConfig()">💾 Salva e Connetti</button>
            </div>
        </div>
    </div>

    <!-- DATABASE TAB -->
    <div id="database" class="tab-content active">
        <div class="section-header">
            <h2 class="section-title">Database Attrezzature</h2>
            <div id="dbStats" style="font-size: 14px; color: #666;"></div>
        </div>
        <div class="controls-grid">
            <input type="text" class="search-box" placeholder="🔍 Cerca attrezzatura..." onkeyup="filterDatabase()" id="searchInput">
            <select class="filter-select" onchange="filterByCategory()" id="categoryFilter">
                <option value="">Tutte le categorie</option>
            </select>
            <button class="btn btn-success" onclick="addNewEquipment()">+ Nuova</button>
            <button class="btn btn-warning" onclick="syncDatabase()" id="syncBtn">🔄 Sync</button>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Attrezzatura</th>
                        <th>1 Giorno</th>
                        <th>3 Giorni</th>
                        <th>1 Settimana</th>
                        <th>Valore Assic.</th>
                        <th>Kit/Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="databaseBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Configura le API per caricare il database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- QUOTES TAB -->
    <div id="quotes" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Nuovo Preventivo</h2>
        </div>
        <div class="quote-header">
            <div class="quote-controls">
                <div class="form-group">
                    <label class="form-label">Nome Preventivo</label>
                    <input type="text" class="form-input" id="quoteName" placeholder="Es: Spot TV Audi Q3">
                </div>
                <button class="btn btn-success" onclick="saveQuote()">💾 Salva</button>
                <button class="btn btn-info" onclick="loadQuote()">📂 Carica</button>
                <button class="btn btn-warning" onclick="duplicateQuote()">📄 Duplica</button>
                <button class="btn btn-danger" onclick="resetQuote()">🔄 Reset</button>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-input" id="cliente" placeholder="Nome del cliente">
            </div>
            <div class="form-group">
                <label class="form-label">P.IVA Cliente</label>
                <input type="text" class="form-input" id="clientePiva" placeholder="Partita IVA del cliente">
            </div>
            <div class="form-group">
                <label class="form-label">Contatti</label>
                <input type="text" class="form-input" id="contatti" placeholder="Telefono/Email">
            </div>
            <div class="form-group">
                <label class="form-label">Data Carico</label>
                <input type="date" class="form-input" id="carico">
            </div>
            <div class="form-group">
                <label class="form-label">Data Scarico</label>
                <input type="date" class="form-input" id="scarico">
            </div>
        </div>
        <div class="form-grid" style="grid-template-columns: auto auto auto 1fr auto auto;">
            <div class="form-group">
                <label class="form-label">Durata (giorni)</label>
                <input type="number" class="form-input" id="durata" value="1" min="1" max="30" onchange="updateAllPrices()" style="width: 100px;">
            </div>
            <div class="form-group">
                <label class="form-label">Sconto (%)</label>
                <input type="number" class="form-input" id="sconto" value="0" min="0" max="50" step="0.1" onchange="updateTotals()" style="width: 100px;">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-input" id="quoteType">
                    <option value="rental">Noleggio</option>
                    <option value="sale">Vendita</option>
                    <option value="service">Servizio</option>
                </select>
            </div>
            <div></div>
            <button class="btn btn-primary" onclick="addEquipmentRow()">+ Attrezzatura</button>
            <button class="btn btn-info" onclick="addServiceRow()">+ Servizio</button>
        </div>
        <div class="equipment-section">
            <div class="equipment-header">
                <h3>Lista Attrezzature e Servizi</h3>
                <div>
                    <button class="btn btn-info" onclick="generatePDF()">📄 PDF</button>
                    <button class="btn btn-warning" onclick="generateInsurance()">🛡️ Assicurazione</button>
                    <button class="btn btn-success" onclick="generateNoPricesQuote()">📋 Senza Prezzi</button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 180px;">Categoria</th>
                        <th style="width: 220px;">Attrezzatura/Servizio</th>
                        <th style="width: 80px;">Qtà</th>
                        <th style="width: 120px;">Prezzo Unit.</th>
                        <th style="width: 120px;">Totale</th>
                        <th style="width: 80px;">Azioni</th>
                    </tr>
                </thead>
                <tbody id="equipmentRows"></tbody>
            </table>
        </div>
        <div class="totals-section">
            <div>
                <div class="total-line">
                    <span>Subtotale:</span>
                    <span id="subtotale" onclick="makeSubtotalEditable()" style="cursor: pointer; text-decoration: underline;" title="Clicca per modificare">€ 0.00</span>
                </div>
                <div class="total-line">
                    <span>Sconto (<span id="discount-percent">0</span>%):</span>
                    <span id="sconto-amount">€ 0.00</span>
                </div>
                <div class="total-line">
                    <span>Imponibile:</span>
                    <span id="imponibile">€ 0.00</span>
                </div>
                <div class="total-line">
                    <span>IVA (22%):</span>
                    <span id="iva">€ 0.00</span>
                </div>
                <div class="total-line final">
                    <span>TOTALE:</span>
                    <span id="totale">€ 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVED QUOTES TAB -->
    <div id="saved" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Preventivi Salvati</h2>
            <div>
                <button class="btn btn-warning" onclick="syncQuotes()">🔄 Aggiorna</button>
                <button class="btn btn-info" onclick="exportAllQuotes()">📊 Export Excel</button>
            </div>
        </div>
        <div class="quotes-grid" id="savedQuotes">
            <div class="quote-card">
                <div class="quote-title">Caricamento...</div>
                <div class="quote-meta">Sincronizzazione con Google Sheets in corso...</div>
            </div>
        </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Analytics & Statistiche</h2>
            <button class="btn btn-info" onclick="generateAnalyticsReport()">📊 Report Completo</button>
        </div>
        <div class="form-grid">
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Preventivi Questo Mese</h3>
                <div style="font-size: 36px; font-weight: bold; color: #4CAF50;" id="monthlyQuotes">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Fatturato Stimato</h3>
                <div style="font-size: 36px; font-weight: bold; color: #FF9800;" id="estimatedRevenue">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Attrezzature Più Richieste</h3>
                <div style="font-size: 18px; font-weight: bold; color: #2196F3;" id="topEquipment">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Tasso di Conversione</h3>
                <div style="font-size: 36px; font-weight: bold; color: #9C27B0;" id="conversionRate">-</div>
            </div>
        </div>
    </div>
</div>
<script>
    // CONFIGURAZIONE GLOBALE - AGGIORNATA CON NUOVO SHEETS ID
let CONFIG = {
    API_KEY: 'AIzaSyAbcQrfJiXQMIbBAb5ZOLvm_9tEz73d1DY',
    SHEETS_ID: '1gzjiGiZkyKeaE6f0iBKoeUNW7bbhemdQiipGknnd6Pc',
    DATABASE_RANGE: 'Database!A:G',
    QUOTES_RANGE: 'Preventivi_Salvati!A:Z'
};

// STATO GLOBALE
let equipmentDatabase = {};
let savedQuotes = [];
let isConnected = false;
let gapi_loaded = false;
let rowCounter = 0;

// GOOGLE SHEETS API INITIALIZATION
function initializeGoogleAPI() {
    updateConnectionStatus('syncing', 'Connessione in corso...');
    gapi.load('client', async () => {
        try {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            });
            gapi_loaded = true;
            isConnected = true;
            updateConnectionStatus('online', 'Connesso');
            await loadDatabaseFromSheets();
            await loadQuotesFromSheets();
            showNotification('✅ Connessione Google Sheets stabilita!', 'success');
        } catch (error) {
            console.error('Errore inizializzazione API:', error);
            updateConnectionStatus('offline', 'Errore connessione');
            showNotification('❌ Errore connessione Google Sheets: ' + error.message, 'error');
        }
    });
}

// GOOGLE SHEETS DATA LOADING
async function loadDatabaseFromSheets() {
    if (!gapi_loaded || !isConnected) {
        showNotification('⚠️ Connessione Google Sheets non disponibile', 'warning');
        return;
    }
    try {
        updateConnectionStatus('syncing', 'Sincronizzazione database...');
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: CONFIG.DATABASE_RANGE
        });
        const values = response.result.values;
        if (!values || values.length === 0) {
            throw new Error('Nessun dato trovato nel database');
        }
        processEquipmentData(values);
        updateConnectionStatus('online', 'Database aggiornato');
        updateSyncTime();
        showNotification('✅ Database caricato: ' + Object.keys(equipmentDatabase).length + ' categorie', 'success');
    } catch (error) {
        console.error('Errore caricamento database:', error);
        updateConnectionStatus('offline', 'Errore sync database');
        showNotification('❌ Errore caricamento database: ' + error.message, 'error');
    }
}

async function loadQuotesFromSheets() {
    if (!gapi_loaded || !isConnected) {
        // Carica da localStorage se disponibile
        const localQuotes = localStorage.getItem('hubris_quotes');
        if (localQuotes) {
            try {
                savedQuotes = JSON.parse(localQuotes);
                renderSavedQuotes();
                updateAnalytics();
                showNotification('📂 Preventivi caricati da memoria locale', 'info');
            } catch (e) {
                savedQuotes = [];
            }
        }
        return;
    }
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: CONFIG.QUOTES_RANGE
        });
        const values = response.result.values;
        if (values && values.length > 1) {
            savedQuotes = parseQuotesData(values);
            // Salva anche in localStorage come backup
            localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
            renderSavedQuotes();
            updateAnalytics();
        }
    } catch (error) {
        console.log('Foglio preventivi non trovato, verrà creato al primo salvataggio');
        savedQuotes = [];
    }
}

async function saveQuoteToSheets(quote) {
    // Salva sempre in localStorage
    localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
    
    if (!gapi_loaded || !isConnected) {
        showNotification('💾 Preventivo salvato localmente - sincronizzazione quando connesso', 'warning');
        return;
    }
    try {
        const quoteRow = [
            quote.id, quote.name, quote.cliente, quote.clientePiva || '', quote.contatti, 
            quote.carico, quote.scarico, quote.durata, quote.sconto, quote.total, 
            quote.status, quote.createdAt, JSON.stringify(quote.equipment)
        ];
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: 'Preventivi_Salvati!A:M',
            valueInputOption: 'RAW',
            resource: { values: [quoteRow] }
        });
        showNotification('✅ Preventivo salvato su Google Sheets', 'success');
    } catch (error) {
        console.error('Errore salvataggio:', error);
        showNotification('❌ Errore salvataggio su Google Sheets, salvato localmente', 'error');
    }
}

// DATA PROCESSING
function processEquipmentData(values) {
    equipmentDatabase = {};
    const processedData = [];
    let currentCategory = '';
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (!row || row.length === 0) continue;
        const name = row[0] || '';
        const price1 = parseFloat(row[1]) || 0;
        const price3 = parseFloat(row[2]) || 0;
        const price7 = parseFloat(row[3]) || 0;
        const insurance = parseFloat(row[4]) || 0;
        const kit = row[5] || '';
        const notes = row[6] || '';
        if (name && !price1 && !price3 && !price7 && !insurance) {
            currentCategory = name;
            if (!equipmentDatabase[currentCategory]) {
                equipmentDatabase[currentCategory] = {};
            }
        } else if (name && currentCategory) {
            equipmentDatabase[currentCategory][name] = {
                price1, price3, price7, insurance, kit, notes
            };
            processedData.push({
                category: currentCategory, name, price1, price3, price7, insurance, kit, notes
            });
        }
    }
    renderDatabase(processedData);
    updateCategoryFilter();
    updateDbStats();
}

function parseQuotesData(values) {
    const quotes = [];
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (row && row.length >= 12) {
            quotes.push({
                id: parseInt(row[0]) || Date.now(),
                name: row[1] || '',
                cliente: row[2] || '',
                clientePiva: row[3] || '',
                contatti: row[4] || '',
                carico: row[5] || '',
                scarico: row[6] || '',
                durata: parseInt(row[7]) || 1,
                sconto: parseFloat(row[8]) || 0,
                total: parseFloat(row[9]) || 0,
                status: row[10] || 'draft',
                createdAt: row[11] || '',
                equipment: JSON.parse(row[12] || '[]')
            });
        }
    }
    return quotes;
}

// NUOVA FUNZIONE PER AGGIUNGERE SERVIZI
function addServiceRow() {
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.className = 'equipment-row service-row';
    row.id = 'row-' + rowCounter;
    row.style.background = '#fff3e0';
    row.innerHTML = `
        <td style="color: #f57c00; font-weight: bold;">🔧 SERVIZIO</td>
        <td>
            <input type="text" class="form-input" placeholder="Nome del servizio (es. Trasporto)" 
                   id="service-name-${rowCounter}" style="width: 100%; margin-bottom: 5px;">
            <textarea class="form-input" placeholder="Note servizio..." 
                      id="service-notes-${rowCounter}" style="width: 100%; height: 60px; resize: vertical;"></textarea>
        </td>
        <td>
            <input type="number" class="form-input" value="1" min="1" 
                   onchange="updateRowTotal(${rowCounter})" id="qty-${rowCounter}" 
                   style="width: 100%; text-align: center;">
        </td>
        <td>
            <input type="number" class="form-input" placeholder="0.00" min="0" step="0.01" 
                   onchange="updateRowTotal(${rowCounter})" id="service-price-${rowCounter}" 
                   style="width: 100%; text-align: right;">
        </td>
        <td style="text-align: right; font-weight: bold; color: #f57c00;" id="total-${rowCounter}">€ 0.00</td>
        <td>
            <button class="btn btn-danger" onclick="removeRow(${rowCounter})" 
                    style="padding: 6px 12px; font-size: 12px;">✕</button>
        </td>
    `;
    tbody.appendChild(row);
}

// UI RENDERING
function renderDatabase(data) {
    const tbody = document.getElementById('databaseBody');
    tbody.innerHTML = '';
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nessun dato disponibile. Configura le API per caricare il database.</td></tr>';
        return;
    }
    let currentCategory = '';
    data.forEach((item, index) => {
        if (item.category !== currentCategory) {
            const categoryRow = document.createElement('tr');
            categoryRow.className = 'category-row';
            categoryRow.innerHTML = '<td colspan="7" style="text-align: center; font-weight: bold;">📁 ' + item.category + '</td>';
            tbody.appendChild(categoryRow);
            currentCategory = item.category;
        }
        const row = document.createElement('tr');
        row.innerHTML = '<td style="font-weight: 500;">' + item.name + '</td><td>€ ' + item.price1.toFixed(2) + '</td><td>€ ' + item.price3.toFixed(2) + '</td><td>€ ' + item.price7.toFixed(2) + '</td><td>€ ' + item.insurance.toLocaleString() + '</td><td style="font-size: 12px; color: #666; max-width: 200px;">' + item.kit + '</td><td><button class="btn btn-warning" onclick="editEquipment(\'' + item.category + '\', \'' + item.name + '\')" style="padding: 6px 12px; font-size: 12px;">✏️</button></td>';
        tbody.appendChild(row);
    });
}

function updateCategoryFilter() {
    const filter = document.getElementById('categoryFilter');
    filter.innerHTML = '<option value="">Tutte le categorie</option>';
    Object.keys(equipmentDatabase).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filter.appendChild(option);
    });
}

function updateDbStats() {
    const totalCategories = Object.keys(equipmentDatabase).length;
    let totalItems = 0;
    Object.values(equipmentDatabase).forEach(category => {
        totalItems += Object.keys(category).length;
    });
    document.getElementById('dbStats').textContent = totalCategories + ' categorie, ' + totalItems + ' attrezzature';
}
    function renderSavedQuotes() {
    const container = document.getElementById('savedQuotes');
    container.innerHTML = '';
    if (savedQuotes.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;"><h3>Nessun preventivo salvato</h3><p>Crea il tuo primo preventivo nella sezione "Nuovo Preventivo"</p></div>';
        return;
    }
    savedQuotes.forEach(quote => {
        const div = document.createElement('div');
        div.className = 'quote-card';
        div.innerHTML = '<div class="quote-title">' + quote.name + '</div><div class="quote-meta"><strong>Cliente:</strong> ' + quote.cliente + (quote.clientePiva ? '<br><strong>P.IVA:</strong> ' + quote.clientePiva : '') + '<br><strong>Durata:</strong> ' + quote.durata + ' giorni<br><strong>Totale:</strong> € ' + quote.total.toFixed(2) + '<br><strong>Creato:</strong> ' + quote.createdAt + '</div><div style="margin-top: 15px;"><span class="status-badge status-' + quote.status + '">' + (quote.status === 'draft' ? 'Bozza' : quote.status === 'sent' ? 'Inviato' : 'Confermato') + '</span><div style="margin-top: 10px;"><button class="btn btn-primary" onclick="loadQuoteById(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">📂</button><button class="btn btn-info" onclick="generateQuotePDF(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">📄</button><button class="btn btn-warning" onclick="duplicateQuoteById(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">📄</button><button class="btn btn-danger" onclick="deleteQuote(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">🗑️</button></div></div>';
        container.appendChild(div);
    });
}

// TAB MANAGEMENT
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    if (tabName === 'analytics') {
        updateAnalytics();
    }
}

// CONFIGURATION MODAL
function showConfigModal() {
    document.getElementById('apiKeyInput').value = CONFIG.API_KEY;
    document.getElementById('sheetsIdInput').value = CONFIG.SHEETS_ID;
    document.getElementById('configModal').classList.add('active');
}

function closeConfigModal() {
    document.getElementById('configModal').classList.remove('active');
}

function saveConfig() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const sheetsId = document.getElementById('sheetsIdInput').value.trim();
    if (!apiKey || !sheetsId) {
        showNotification('❌ Inserisci API Key e Sheets ID', 'error');
        return;
    }
    CONFIG.API_KEY = apiKey;
    CONFIG.SHEETS_ID = sheetsId;
    localStorage.setItem('hubris_api_key', apiKey);
    localStorage.setItem('hubris_sheets_id', sheetsId);
    closeConfigModal();
    showNotification('⚙️ Configurazione salvata. Connessione in corso...', 'info');
    setTimeout(() => {
        initializeGoogleAPI();
    }, 1000);
}

// QUOTE MANAGEMENT
function addEquipmentRow() {
    if (Object.keys(equipmentDatabase).length === 0) {
        showNotification('⚠️ Carica prima il database delle attrezzature', 'warning');
        return;
    }
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.className = 'equipment-row';
    row.id = 'row-' + rowCounter;
    row.style.background = '#f8f9ff';
    row.innerHTML = '<td><select class="form-input" onchange="updateEquipmentOptions(' + rowCounter + ')" id="category-' + rowCounter + '" style="width: 100%;"><option value="">Seleziona categoria...</option>' + Object.keys(equipmentDatabase).map(cat => '<option value="' + cat + '">' + cat + '</option>').join('') + '</select></td><td><select class="form-input" onchange="updateRowData(' + rowCounter + ')" id="equipment-' + rowCounter + '" style="width: 100%;" disabled><option value="">Prima seleziona categoria</option></select><div style="font-size: 11px; color: #666; margin-top: 5px;" id="kit-' + rowCounter + '"></div></td><td><input type="number" class="form-input" value="1" min="1" onchange="updateRowTotal(' + rowCounter + ')" id="qty-' + rowCounter + '" style="width: 100%; text-align: center;"></td><td style="text-align: right; font-weight: bold; color: #2e7d32;" id="price-' + rowCounter + '">€ 0.00</td><td style="text-align: right; font-weight: bold; color: #2e7d32;" id="total-' + rowCounter + '">€ 0.00</td><td><button class="btn btn-danger" onclick="removeRow(' + rowCounter + ')" style="padding: 6px 12px; font-size: 12px;">✕</button></td>';
    tbody.appendChild(row);
}

function updateEquipmentOptions(rowId) {
    const categorySelect = document.getElementById('category-' + rowId);
    const equipmentSelect = document.getElementById('equipment-' + rowId);
    const category = categorySelect.value;
    equipmentSelect.innerHTML = '<option value="">Seleziona attrezzatura...</option>';
    if (category && equipmentDatabase[category]) {
        equipmentSelect.disabled = false;
        Object.keys(equipmentDatabase[category]).forEach(equipment => {
            const option = document.createElement('option');
            option.value = equipment;
            option.textContent = equipment;
            equipmentSelect.appendChild(option);
        });
    } else {
        equipmentSelect.disabled = true;
    }
    document.getElementById('kit-' + rowId).textContent = '';
    document.getElementById('price-' + rowId).textContent = '€ 0.00';
    document.getElementById('total-' + rowId).textContent = '€ 0.00';
    updateTotals();
}

function updateRowData(rowId) {
    const categorySelect = document.getElementById('category-' + rowId);
    const equipmentSelect = document.getElementById('equipment-' + rowId);
    const category = categorySelect.value;
    const equipment = equipmentSelect.value;
    if (category && equipment && equipmentDatabase[category][equipment]) {
        const data = equipmentDatabase[category][equipment];
        const duration = parseInt(document.getElementById('durata').value);
        const price = calculatePrice(data.price1, data.price3, data.price7, duration);
        document.getElementById('price-' + rowId).textContent = '€ ' + price.toFixed(2);
        document.getElementById('kit-' + rowId).textContent = data.kit;
        updateRowTotal(rowId);
    }
}

function calculatePrice(price1, price3, price7, duration) {
    if (duration === 1) return price1;
    if (duration === 2) return price1 * 2;
    if (duration === 3) return price3;
    if (duration === 4) return price3 + price1;
    if (duration === 5) return price7;
    if (duration === 6) return price7 + price1;
    if (duration === 7) return price7 + (price1 * 2);
    if (duration === 8) return price7 + price3;
    if (duration === 9) return price7 + price3 + price1;
    if (duration >= 10) return price7 * 2;
    return price1;
}

function updateRowTotal(rowId) {
    const row = document.getElementById('row-' + rowId);
    let price = 0;
    let quantity = parseInt(document.getElementById('qty-' + rowId).value) || 0;
    
    // Check if it's a service row
    if (row.classList.contains('service-row')) {
        price = parseFloat(document.getElementById('service-price-' + rowId).value) || 0;
    } else {
        const priceText = document.getElementById('price-' + rowId).textContent;
        price = parseFloat(priceText.replace('€ ', '')) || 0;
    }
    
    const total = price * quantity;
    document.getElementById('total-' + rowId).textContent = '€ ' + total.toFixed(2);
    updateTotals();
}

function updateAllPrices() {
    const rows = document.querySelectorAll('[id^="row-"]');
    rows.forEach(row => {
        const rowId = row.id.split('-')[1];
        if (!row.classList.contains('service-row')) {
            updateRowData(rowId);
        }
    });
}

function updateTotals() {
    const totalCells = document.querySelectorAll('[id^="total-"]');
    let subtotal = 0;
    totalCells.forEach(cell => {
        const value = parseFloat(cell.textContent.replace('€ ', '')) || 0;
        subtotal += value;
    });
    const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const imponibile = subtotal - discountAmount;
    const iva = imponibile * 0.22;
    const totale = imponibile + iva;
    document.getElementById('subtotale').textContent = '€ ' + subtotal.toFixed(2);
    document.getElementById('discount-percent').textContent = discountPercent.toFixed(1);
    document.getElementById('sconto-amount').textContent = '€ ' + discountAmount.toFixed(2);
    document.getElementById('imponibile').textContent = '€ ' + imponibile.toFixed(2);
    document.getElementById('iva').textContent = '€ ' + iva.toFixed(2);
    document.getElementById('totale').textContent = '€ ' + totale.toFixed(2);
}

function removeRow(rowId) {
    const row = document.getElementById('row-' + rowId);
    if (row) {
        row.remove();
        updateTotals();
    }
}

function saveQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('❌ Inserisci un nome per il preventivo!', 'error');
        return;
    }
    const quote = {
        id: Date.now(),
        name: quoteName,
        cliente: document.getElementById('cliente').value,
        clientePiva: document.getElementById('clientePiva').value,
        contatti: document.getElementById('contatti').value,
        carico: document.getElementById('carico').value,
        scarico: document.getElementById('scarico').value,
        durata: document.getElementById('durata').value,
        sconto: document.getElementById('sconto').value,
        equipment: [],
        createdAt: new Date().toLocaleString('it-IT'),
        status: 'draft',
        total: parseFloat(document.getElementById('totale').textContent.replace('€ ', '')) || 0
    };
    
    document.querySelectorAll('[id^="row-"]').forEach(row => {
        const rowId = row.id.split('-')[1];
        const quantity = document.getElementById('qty-' + rowId) ? document.getElementById('qty-' + rowId).value : '';
        
        if (row.classList.contains('service-row')) {
            const serviceName = document.getElementById('service-name-' + rowId) ? document.getElementById('service-name-' + rowId).value : '';
            const serviceNotes = document.getElementById('service-notes-' + rowId) ? document.getElementById('service-notes-' + rowId).value : '';
            const servicePrice = document.getElementById('service-price-' + rowId) ? document.getElementById('service-price-' + rowId).value : '';
            
            if (serviceName) {
                quote.equipment.push({
                    category: 'SERVIZIO',
                    equipment: serviceName,
                    quantity: parseInt(quantity),
                    notes: serviceNotes,
                    price: parseFloat(servicePrice),
                    isService: true
                });
            }
        } else {
            const category = document.getElementById('category-' + rowId) ? document.getElementById('category-' + rowId).value : '';
            const equipment = document.getElementById('equipment-' + rowId) ? document.getElementById('equipment-' + rowId).value : '';
            
            if (category && equipment) {
                quote.equipment.push({
                    category, equipment, quantity: parseInt(quantity), isService: false
                });
            }
        }
    });
    
    savedQuotes.push(quote);
    saveQuoteToSheets(quote);
    renderSavedQuotes();
    updateAnalytics();
    showNotification('✅ Preventivo "' + quoteName + '" salvato!', 'success');
}

function loadQuoteById(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) {
        showNotification('❌ Preventivo non trovato!', 'error');
        return;
    }
    
    // Clear existing rows
    document.getElementById('equipmentRows').innerHTML = '';
    rowCounter = 0;
    
    // Load basic data
    document.getElementById('quoteName').value = quote.name || '';
    document.getElementById('cliente').value = quote.cliente || '';
    document.getElementById('clientePiva').value = quote.clientePiva || '';
    document.getElementById('contatti').value = quote.contatti || '';
    document.getElementById('carico').value = quote.carico || '';
    document.getElementById('scarico').value = quote.scarico || '';
    document.getElementById('durata').value = quote.durata || '1';
    document.getElementById('sconto').value = quote.sconto || '0';
    
    // Load equipment and services
    if (quote.equipment && quote.equipment.length > 0) {
        quote.equipment.forEach((item, index) => {
            if (item.isService) {
                addServiceRow();
                setTimeout(() => {
                    if (document.getElementById('service-name-' + rowCounter)) {
                        document.getElementById('service-name-' + rowCounter).value = item.equipment || '';
                        document.getElementById('service-notes-' + rowCounter).value = item.notes || '';
                        document.getElementById('service-price-' + rowCounter).value = item.price || '';
                        document.getElementById('qty-' + rowCounter).value = item.quantity || 1;
                        updateRowTotal(rowCounter);
                    }
                }, 50 * (index + 1));
            } else {
                addEquipmentRow();
                setTimeout(() => {
                    if (document.getElementById('category-' + rowCounter)) {
                        document.getElementById('category-' + rowCounter).value = item.category || '';
                        updateEquipmentOptions(rowCounter);
                        setTimeout(() => {
                            if (document.getElementById('equipment-' + rowCounter)) {
                                document.getElementById('equipment-' + rowCounter).value = item.equipment || '';
                                updateRowData(rowCounter);
                                document.getElementById('qty-' + rowCounter).value = item.quantity || 1;
                                updateRowTotal(rowCounter);
                            }
                        }, 100);
                    }
                }, 100 * (index + 1));
            }
        });
    }
    
    // Switch to quotes tab
    showTab('quotes');
    document.querySelector('[onclick="showTab(\'quotes\')"]').classList.add('active');
    showNotification('✅ Preventivo "' + quote.name + '" caricato!', 'success');
}
function duplicateQuoteById(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    loadQuoteById(quoteId);
    document.getElementById('quoteName').value = quote.name + ' - Copia';
    showNotification('📄 Preventivo duplicato! Modifica il nome e salva.', 'info');
}

function deleteQuote(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    if (confirm('Sei sicuro di voler eliminare il preventivo "' + quote.name + '"?')) {
        savedQuotes = savedQuotes.filter(q => q.id !== quoteId);
        localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
        renderSavedQuotes();
        updateAnalytics();
        showNotification('🗑️ Preventivo eliminato', 'info');
    }
}

function resetQuote() {
    if (confirm('Sei sicuro di voler cancellare tutto il preventivo?')) {
        document.getElementById('equipmentRows').innerHTML = '';
        document.getElementById('cliente').value = '';
        document.getElementById('clientePiva').value = '';
        document.getElementById('contatti').value = '';
        document.getElementById('carico').value = '';
        document.getElementById('scarico').value = '';
        document.getElementById('durata').value = '1';
        document.getElementById('sconto').value = '0';
        document.getElementById('quoteName').value = '';
        updateTotals();
        showNotification('🔄 Preventivo resettato', 'info');
    }
}

// UTILITY FUNCTIONS
function filterDatabase() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#databaseBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterByCategory() {
    const selectedCategory = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('#databaseBody tr');
    if (!selectedCategory) {
        rows.forEach(row => row.style.display = '');
        return;
    }
    let showNextItems = false;
    rows.forEach(row => {
        if (row.classList.contains('category-row')) {
            const categoryText = row.textContent.trim().replace('📁 ', '');
            showNextItems = (categoryText === selectedCategory);
            row.style.display = showNextItems ? '' : 'none';
        } else {
            row.style.display = showNextItems ? '' : 'none';
        }
    });
}

function syncDatabase() {
    const loader = document.getElementById('syncLoader');
    const btn = document.getElementById('syncBtn');
    if (loader) loader.style.display = 'inline-block';
    if (btn) btn.disabled = true;
    loadDatabaseFromSheets().finally(() => {
        if (loader) loader.style.display = 'none';
        if (btn) btn.disabled = false;
    });
}

function syncQuotes() {
    showNotification('🔄 Aggiornamento preventivi...', 'info');
    loadQuotesFromSheets().then(() => {
        showNotification('✅ Preventivi aggiornati!', 'success');
    });
}

function updateConnectionStatus(status, message) {
    const indicator = document.getElementById('connectionStatus');
    const text = document.getElementById('connectionText');
    if (indicator) indicator.className = 'status-indicator status-' + status;
    if (text) text.textContent = message;
}

function updateSyncTime() {
    const lastSync = document.getElementById('lastSync');
    if (lastSync) lastSync.textContent = 'Ultimo sync: ' + new Date().toLocaleTimeString('it-IT');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = 'notification ' + (type || 'info');
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
// PDF GENERATION FUNCTIONS
function generatePDF() {
    const quoteName = document.getElementById('quoteName').value || 'Preventivo';
    const cliente = document.getElementById('cliente').value || 'Cliente';
    const clientePiva = document.getElementById('clientePiva').value || '';
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // HEADER CON LOGO REALE
const logoBase64 = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzkiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMiIvPgo8cGF0aCBkPSJNNTUgMjBMMzAgNDVMMzUgNTBMNjAgMjVMMzAgMzVMMzUgNDBMNjAgMTVMMzAgMjUiIGZpbGw9ImJsYWNrIi8+CjxwYXRoIGQ9Ik0yNSA2MEM0MCA0NSAzNSA0MCAyNSA2MFoiIGZpbGw9ImdyYXkiLz4KPHN0YXIgY3g9IjIwIiBjeT0iMjAiIHI9IjMiIGZpbGw9ImJsYWNrIi8+Cjwvc3ZnPgo=';

try {
    doc.addImage(logoBase64, 'SVG', 15, 15, 20, 20);
} catch (e) {
    // Fallback se il logo non funziona
    doc.setFillColor(44, 90, 160);
    doc.circle(25, 25, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.text('HP', 25, 28, { align: 'center' });
}

doc.setFontSize(24);
doc.setFont('helvetica', 'bold');
doc.setTextColor(0, 0, 0);
doc.text('HUBRIS PICTURES S.R.L.', 45, 28);
        
        // Informazioni azienda
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('P.IVA: 09542051215', 20, 35);
        doc.text('PEC: hubrispictures@pec.it', 20, 42);
        doc.text('CONTATTI: +39 081 18893796 / +39 348 6901218', 20, 49);
        doc.text('INDIRIZZO: Piazza Vanvitelli, 5, 80127 Napoli NA', 20, 56);
        doc.text('MAIL: info@hubrispictures.com', 20, 63);
        
        // PREVENTIVO HEADER
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(70, 130, 180);
        doc.text('PREVENTIVO', 150, 35);
        
        // Informazioni cliente in box blu
        doc.setFillColor(70, 130, 180);
        doc.rect(150, 45, 60, 25, 'F');
        
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text('CLIENTE: ' + cliente, 152, 52);
        if (clientePiva) {
            doc.text('P.IVA: ' + clientePiva, 152, 59);
        }
        doc.text('CONTATTI: ' + document.getElementById('contatti').value, 152, 66);
        
        // Date
        doc.setTextColor(0, 0, 0);
        doc.text('CARICO: ' + document.getElementById('carico').value, 20, 80);
        doc.text('SCARICO: ' + document.getElementById('scarico').value, 105, 80);
        
        // Tabella attrezzature
        const tableData = [];
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            
            if (row.classList.contains('service-row')) {
                const serviceName = document.getElementById('service-name-' + rowId)?.value || '';
                const serviceNotes = document.getElementById('service-notes-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                const total = document.getElementById('total-' + rowId)?.textContent || '';
                
                if (serviceName) {
                    const description = serviceName + (serviceNotes ? '\n' + serviceNotes : '');
                    tableData.push([description, quantity, '', total]);
                }
            } else {
                const category = document.getElementById('category-' + rowId)?.value || '';
                const equipment = document.getElementById('equipment-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                const total = document.getElementById('total-' + rowId)?.textContent || '';
                
                if (category && equipment) {
                    let description = equipment;
                    const kitInfo = document.getElementById('kit-' + rowId)?.textContent;
                    if (kitInfo) description += '\n' + kitInfo;
                    tableData.push([description, quantity, '', total]);
                }
            }
        });
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Attrezzatura', 'Quantità', 'Descrizione', '']],
                body: tableData,
                startY: 90,
                theme: 'grid',
                headStyles: { 
                    fillColor: [70, 130, 180],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 20, halign: 'center' },
                    2: { cellWidth: 70 },
                    3: { cellWidth: 20, halign: 'right' }
                }
            });
        }
        
        // Totali
        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 15 : 120;
        
        doc.setFillColor(240, 240, 240);
        doc.rect(130, finalY, 80, 30, 'F');
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text('Sconto', 135, finalY + 6);
        doc.text(document.getElementById('sconto-amount').textContent, 200, finalY + 6, { align: 'right' });
        doc.text('Subtotale', 135, finalY + 12);
        doc.text(document.getElementById('subtotale').textContent, 200, finalY + 12, { align: 'right' });
        doc.text('IVA', 135, finalY + 18);
        doc.text(document.getElementById('iva').textContent, 200, finalY + 18, { align: 'right' });
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text('TOTALE', 135, finalY + 26);
        doc.text(document.getElementById('totale').textContent, 200, finalY + 26, { align: 'right' });
        
        doc.save(quoteName.replace(/[^a-z0-9]/gi, '_') + '.pdf');
        showNotification('✅ PDF generato con successo!', 'success');
        
    } catch (error) {
        console.error('Errore generazione PDF:', error);
        showNotification('❌ Errore nella generazione del PDF: ' + error.message, 'error');
    }
}

function generateQuotePDF(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    loadQuoteById(quoteId);
    setTimeout(() => {
        generatePDF();
    }, 1000);
}

function generateInsurance() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // HEADER
        doc.setFontSize(20);
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES S.R.L.', 20, 20);
        doc.setFontSize(16);
        doc.text('VALORI ASSICURATIVI', 20, 35);
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text('Cliente: ' + document.getElementById('cliente').value, 20, 50);
        doc.text('Data: ' + new Date().toLocaleDateString('it-IT'), 20, 60);
        
        const tableData = [];
        let totalInsurance = 0;
        
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            if (!row.classList.contains('service-row')) {
                const category = document.getElementById('category-' + rowId)?.value || '';
                const equipment = document.getElementById('equipment-' + rowId)?.value || '';
                const quantity = parseInt(document.getElementById('qty-' + rowId)?.value || '1') || 1;
                
                if (category && equipment && equipmentDatabase[category] && equipmentDatabase[category][equipment]) {
                    const insurance = equipmentDatabase[category][equipment].insurance;
                    const totalValue = insurance * quantity;
                    totalInsurance += totalValue;
                    if (insurance > 0) {
                        tableData.push([
                            equipment,
                            quantity.toString(),
                            '€ ' + insurance.toLocaleString(),
                            '€ ' + totalValue.toLocaleString()
                        ]);
                    }
                }
            }
        });
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Attrezzatura', 'Quantità', 'Valore Unit.', 'Valore Totale']],
                body: tableData,
                startY: 80,
                theme: 'grid',
                headStyles: { fillColor: [44, 90, 160] }
            });
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(14);
            doc.setTextColor(44, 90, 160);
            doc.text('VALORE TOTALE DA ASSICURARE: € ' + totalInsurance.toLocaleString(), 20, finalY);
        } else {
            doc.text('Nessuna attrezzatura con valore assicurativo', 20, 80);
        }
        
        doc.save('Valori_Assicurativi.pdf');
        showNotification('✅ Documento assicurativo generato!', 'success');
    } catch (error) {
        console.error('Errore generazione assicurazione:', error);
        showNotification('❌ Errore nella generazione del documento', 'error');
    }
}

function generateNoPricesQuote() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // HEADER
        doc.setFontSize(20);
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES S.R.L.', 20, 20);
        doc.setFontSize(16);
        doc.text('PREVENTIVO', 20, 35);
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text('Cliente: ' + document.getElementById('cliente').value, 20, 50);
        doc.text('Contatti: ' + document.getElementById('contatti').value, 20, 60);
        doc.text('Data Carico: ' + document.getElementById('carico').value, 20, 70);
        doc.text('Data Scarico: ' + document.getElementById('scarico').value, 20, 80);
        
        const tableData = [];
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            
            if (row.classList.contains('service-row')) {
                const serviceName = document.getElementById('service-name-' + rowId)?.value || '';
                const serviceNotes = document.getElementById('service-notes-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                
                if (serviceName) {
                    tableData.push([serviceName, quantity, serviceNotes || 'Servizio personalizzato']);
                }
            } else {
                const category = document.getElementById('category-' + rowId)?.value || '';
                const equipment = document.getElementById('equipment-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                
                if (category && equipment && equipmentDatabase[category] && equipmentDatabase[category][equipment]) {
                    const kit = equipmentDatabase[category][equipment].kit;
                    tableData.push([equipment, quantity, kit || 'Kit standard']);
                }
            }
        });
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Attrezzatura/Servizio', 'Quantità', 'Descrizione']],
                body: tableData,
                startY: 100,
                theme: 'grid',
                headStyles: { fillColor: [44, 90, 160] }
            });
        }
        
        doc.save('Preventivo_Senza_Prezzi.pdf');
        showNotification('✅ Preventivo senza prezzi generato!', 'success');
    } catch (error) {
        console.error('Errore generazione preventivo:', error);
        showNotification('❌ Errore nella generazione del preventivo', 'error');
    }
}

function generateAnalyticsReport() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES - REPORT ANALYTICS', 20, 20);
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text('Generato il: ' + new Date().toLocaleDateString('it-IT'), 20, 40);
        
        const monthlyQuotes = document.getElementById('monthlyQuotes').textContent;
        const estimatedRevenue = document.getElementById('estimatedRevenue').textContent;
        const conversionRate = document.getElementById('conversionRate').textContent;
        const topEquipment = document.getElementById('topEquipment').textContent;
        
        doc.text('Preventivi questo mese: ' + monthlyQuotes, 20, 60);
        doc.text('Fatturato stimato: ' + estimatedRevenue, 20, 70);
        doc.text('Tasso di conversione: ' + conversionRate, 20, 80);
        doc.text('Attrezzatura più richiesta: ' + topEquipment, 20, 90);
        
        const recentQuotes = savedQuotes.slice(-10).reverse();
        const tableData = recentQuotes.map(q => [
            q.name,
            q.cliente,
            q.createdAt.split(',')[0],
            '€ ' + q.total.toFixed(2),
            q.status === 'draft' ? 'Bozza' : q.status === 'sent' ? 'Inviato' : 'Confermato'
        ]);
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Preventivo', 'Cliente', 'Data', 'Totale', 'Status']],
                body: tableData,
                startY: 110,
                theme: 'grid',
                headStyles: { fillColor: [44, 90, 160] }
            });
        }
        
        doc.save('Analytics_Report.pdf');
        showNotification('✅ Report analytics generato!', 'success');
    } catch (error) {
        console.error('Errore generazione report:', error);
        showNotification('❌ Errore nella generazione del report', 'error');
    }
}

function exportAllQuotes() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES - EXPORT PREVENTIVI', 20, 20);
        
        const tableData = savedQuotes.map(q => [
            q.name,
            q.cliente,
            q.createdAt.split(',')[0],
            q.durata + ' gg',
            q.sconto + '%',
            '€ ' + q.total.toFixed(2),
            q.status === 'draft' ? 'Bozza' : q.status === 'sent' ? 'Inviato' : 'Confermato'
        ]);
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Nome', 'Cliente', 'Data', 'Durata', 'Sconto', 'Totale', 'Status']],
                body: tableData,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [44, 90, 160] },
                styles: { fontSize: 8 }
            });
        }
        
        doc.save('Export_Tutti_Preventivi.pdf');
        showNotification('✅ Export completo generato!', 'success');
    } catch (error) {
        console.error('Errore export:', error);
        showNotification('❌ Errore nell\'export', 'error');
    }
}

// SUBTOTALE MODIFICABILE
function makeSubtotalEditable() {
    const subtotalElement = document.getElementById('subtotale');
    const currentValue = subtotalElement.textContent.replace('€ ', '');
    
    subtotalElement.innerHTML = `<input type="number" id="manual-subtotal" value="${currentValue}" 
        style="width: 100px; text-align: right; border: 1px solid #ddd; padding: 2px;" 
        onchange="updateManualtotals()" step="0.01" min="0">`;
    
    document.getElementById('manual-subtotal').focus();
}

function updateManualtotals() {
    const manualSubtotal = parseFloat(document.getElementById('manual-subtotal').value) || 0;
    const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
    const discountAmount = manualSubtotal * (discountPercent / 100);
    const imponibile = manualSubtotal - discountAmount;
    const iva = imponibile * 0.22;
    const totale = imponibile + iva;
    
    // Restore normal display
    document.getElementById('subtotale').innerHTML = '€ ' + manualSubtotal.toFixed(2);
    document.getElementById('discount-percent').textContent = discountPercent.toFixed(1);
    document.getElementById('sconto-amount').textContent = '€ ' + discountAmount.toFixed(2);
    document.getElementById('imponibile').textContent = '€ ' + imponibile.toFixed(2);
    document.getElementById('iva').textContent = '€ ' + iva.toFixed(2);
    document.getElementById('totale').textContent = '€ ' + totale.toFixed(2);
}
// ANALYTICS
function updateAnalytics() {
    const thisMonth = savedQuotes.filter(q => {
        const created = new Date(q.createdAt.split(', ')[0].split('/').reverse().join('-'));
        const now = new Date();
        return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
    });
    const totalRevenue = thisMonth.reduce((sum, q) => sum + q.total, 0);
    const confirmedQuotes = savedQuotes.filter(q => q.status === 'confirmed').length;
    const conversionRate = savedQuotes.length > 0 ? (confirmedQuotes / savedQuotes.length * 100) : 0;
    document.getElementById('monthlyQuotes').textContent = thisMonth.length;
    document.getElementById('estimatedRevenue').textContent = '€ ' + totalRevenue.toFixed(0);
    document.getElementById('conversionRate').textContent = conversionRate.toFixed(1) + '%';
    const equipmentCount = {};
    savedQuotes.forEach(quote => {
        quote.equipment.forEach(item => {
            if (!item.isService) {
                equipmentCount[item.equipment] = (equipmentCount[item.equipment] || 0) + parseInt(item.quantity);
            }
        });
    });
    const mostRequested = Object.keys(equipmentCount).reduce((a, b) => 
        equipmentCount[a] > equipmentCount[b] ? a : b, 'N/A'
    );
    document.getElementById('topEquipment').textContent = mostRequested;
}

// PLACEHOLDER FUNCTIONS FOR FUTURE DEVELOPMENT
function addNewEquipment() {
    const newName = prompt('Nome della nuova attrezzatura:');
    if (!newName) return;
    
    const category = prompt('Categoria (lascia vuoto per creare nuova categoria):');
    const price1 = parseFloat(prompt('Prezzo 1 giorno:') || '0');
    const price3 = parseFloat(prompt('Prezzo 3 giorni:') || '0');
    const price7 = parseFloat(prompt('Prezzo 1 settimana:') || '0');
    const insurance = parseFloat(prompt('Valore assicurativo:') || '0');
    const kit = prompt('Kit/Note (opzionale):') || '';
    
    if (!category) {
        const newCategory = prompt('Nome nuova categoria:');
        if (!newCategory) return;
        
        if (!equipmentDatabase[newCategory]) {
            equipmentDatabase[newCategory] = {};
        }
        
        equipmentDatabase[newCategory][newName] = {
            price1, price3, price7, insurance, kit, notes: ''
        };
    } else if (equipmentDatabase[category]) {
        equipmentDatabase[category][newName] = {
            price1, price3, price7, insurance, kit, notes: ''
        };
    } else {
        showNotification('❌ Categoria non trovata!', 'error');
        return;
    }
    
    // Refresh display
    const processedData = [];
    Object.keys(equipmentDatabase).forEach(cat => {
        Object.keys(equipmentDatabase[cat]).forEach(item => {
            const data = equipmentDatabase[cat][item];
            processedData.push({
                category: cat,
                name: item,
                ...data
            });
        });
    });
    
    renderDatabase(processedData);
    updateCategoryFilter();
    updateDbStats();
    showNotification('✅ Attrezzatura "' + newName + '" aggiunta!', 'success');
}

function editEquipment(category, name) {
    if (!equipmentDatabase[category] || !equipmentDatabase[category][name]) {
        showNotification('❌ Attrezzatura non trovata!', 'error');
        return;
    }
    
    const current = equipmentDatabase[category][name];
    
    const newPrice1 = parseFloat(prompt('Prezzo 1 giorno:', current.price1) || current.price1);
    const newPrice3 = parseFloat(prompt('Prezzo 3 giorni:', current.price3) || current.price3);
    const newPrice7 = parseFloat(prompt('Prezzo 1 settimana:', current.price7) || current.price7);
    const newInsurance = parseFloat(prompt('Valore assicurativo:', current.insurance) || current.insurance);
    const newKit = prompt('Kit/Note:', current.kit) || current.kit;
    
    // Update data
    equipmentDatabase[category][name] = {
        price1: newPrice1,
        price3: newPrice3,
        price7: newPrice7,
        insurance: newInsurance,
        kit: newKit,
        notes: current.notes || ''
    };
    
    // Refresh display
    const processedData = [];
    Object.keys(equipmentDatabase).forEach(cat => {
        Object.keys(equipmentDatabase[cat]).forEach(item => {
            const data = equipmentDatabase[cat][item];
            processedData.push({
                category: cat,
                name: item,
                ...data
            });
        });
    });
    
    renderDatabase(processedData);
    showNotification('✅ Attrezzatura "' + name + '" modificata!', 'success');
}

function loadQuote() {
    if (savedQuotes.length === 0) {
        showNotification('❌ Nessun preventivo salvato!', 'error');
        return;
    }
    showTab('saved');
    document.querySelector('[onclick="showTab(\'saved\')"]').classList.add('active');
    showNotification('📂 Seleziona un preventivo dalla lista', 'info');
}

function duplicateQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('❌ Nessun preventivo da duplicare!', 'error');
        return;
    }
    document.getElementById('quoteName').value = quoteName + ' - Copia';
    showNotification('📄 Preventivo duplicato! Modifica il nome e salva.', 'info');
}

// INITIALIZATION
window.addEventListener('load', function() {
    // Load saved configuration
    const savedApiKey = localStorage.getItem('hubris_api_key');
    const savedSheetsId = localStorage.getItem('hubris_sheets_id');
    
    if (savedApiKey) CONFIG.API_KEY = savedApiKey;
    if (savedSheetsId) CONFIG.SHEETS_ID = savedSheetsId;
    
    if (CONFIG.API_KEY && CONFIG.SHEETS_ID) {
        initializeGoogleAPI();
    } else {
        updateConnectionStatus('offline', 'Configurazione richiesta');
        showNotification('⚙️ Clicca su "Config" per configurare le API Google Sheets', 'warning');
    }
    
    // Load quotes from localStorage immediately
    loadQuotesFromSheets();
    
    // Auto-sync every 5 minutes if connected
    setInterval(() => {
        if (isConnected) {
            loadQuotesFromSheets();
            updateSyncTime();
        }
    }, 300000);
});

// Global error handler
window.addEventListener('error', function(e) {
    console.error('Errore globale:', e.error);
    showNotification('❌ Si è verificato un errore. Controlla la console.', 'error');
});

// Prevent accidental page reload
window.addEventListener('beforeunload', function(e) {
    const hasUnsavedChanges = document.getElementById('quoteName').value || 
                           document.querySelectorAll('[id^="row-"]').length > 0;
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
</body>
</html>
