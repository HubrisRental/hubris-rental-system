<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubris Rental - Sistema Completo</title>
    
    <!-- Google Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #2c5aa0; }
        .connection-status { display: flex; align-items: center; gap: 15px; font-size: 14px; color: #666; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background: #4CAF50; }
        .status-syncing { background: #FF9800; animation: pulse 1s infinite; }
        .status-offline { background: #F44336; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .container { max-width: 1400px; margin: 20px auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; backdrop-filter: blur(10px); }
        .tabs { display: flex; background: linear-gradient(90deg, #2c5aa0 0%, #1a4480 100%); overflow-x: auto; }
        .tab { flex: 1; padding: 20px 25px; cursor: pointer; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-weight: 600; font-size: 16px; transition: all 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-2px); }
        .tab:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .btn-danger { background: linear-gradient(135deg, #F44336, #D32F2F); color: white; }
        .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .form-input { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; outline: none; transition: all 0.3s ease; }
        .form-input:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; font-weight: bold; z-index: 1000; animation: slideIn 0.3s ease; max-width: 300px; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #F44336; }
        .notification.info { background: #2196F3; }
        .notification.warning { background: #FF9800; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
        <div class="logo">üé¨ HUBRIS PICTURES S.R.L.</div>
        <div class="connection-status">
            <span class="status-indicator" id="connectionStatus"></span>
            <span id="connectionText">Connecting...</span>
            <span>|</span>
            <span id="lastSync">Ultimo sync: mai</span>
            <span>|</span>
            <button class="btn btn-warning" onclick="showConfigModal()" style="padding: 6px 12px; font-size: 12px;">‚öôÔ∏è Config</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('database')">üóÑÔ∏è Database</button>
        <button class="tab" onclick="showTab('quotes')">üìã Nuovo Preventivo</button>
        <button class="tab" onclick="showTab('saved')">üíæ Preventivi Salvati</button>
        <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
    </div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #2c5aa0; margin-bottom: 20px;">‚öôÔ∏è Configurazione Sistema</h2>
            <div style="background: linear-gradient(135deg, #fff3e0, #ffeaa7); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ff9800;">
                <div style="font-size: 18px; font-weight: bold; color: #f57c00; margin-bottom: 15px;">üîë Google Sheets API</div>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; display: block;">API Key:</label>
                    <input type="text" class="form-input" id="apiKeyInput" placeholder="Inserisci la tua API Key" style="width: 100%;">
                </div>
                <div>
                    <label style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; display: block;">Sheets ID:</label>
                    <input type="text" class="form-input" id="sheetsIdInput" placeholder="ID del tuo Google Sheets" style="width: 100%;">
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">‚ÑπÔ∏è Inserisci le credenziali per collegare il sistema al tuo database Google Sheets</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeConfigModal()">Annulla</button>
                <button class="btn btn-success" onclick="saveConfig()">üíæ Salva e Connetti</button>
            </div>
        </div>
    </div>

    <!-- DATABASE TAB -->
    <div id="database" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
            <h2 style="font-size: 28px; font-weight: bold; color: #2c5aa0;">Database Attrezzature</h2>
            <div id="dbStats" style="font-size: 14px; color: #666;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; margin-bottom: 25px; align-items: center;">
            <input type="text" placeholder="üîç Cerca attrezzatura..." onkeyup="filterDatabase()" id="searchInput" style="padding: 12px 20px; border: 2px solid #e1e5e9; border-radius: 25px; font-size: 16px; outline: none; background: white;">
            <select onchange="filterByCategory()" id="categoryFilter" style="padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 12px; background: white; font-size: 14px; cursor: pointer;">
                <option value="">Tutte le categorie</option>
            </select>
            <button class="btn btn-success" onclick="addNewEquipment()">+ Nuova</button>
            <button class="btn btn-warning" onclick="syncDatabase()" id="syncBtn">üîÑ Sync</button>
        </div>
        <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); max-height: 600px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">Attrezzatura</th>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">1 Giorno</th>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">3 Giorni</th>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">1 Settimana</th>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">Valore Assic.</th>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">Kit/Note</th>
                        <th style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10;">Azioni</th>
                    </tr>
                </thead>
                <tbody id="databaseBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Configura le API per caricare il database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Altri tab content minimalizzati per ora -->
    <div id="quotes" class="tab-content"><h2>Preventivi - In caricamento...</h2></div>
    <div id="saved" class="tab-content"><h2>Salvati - In caricamento...</h2></div>
    <div id="analytics" class="tab-content"><h2>Analytics - In caricamento...</h2></div>
</div>

<script>
<script>
let CONFIG = {
    API_KEY: 'AIzaSyAbcQrfJiXQMIbBAb5ZOLvm_9tEz73d1DY',
    SHEETS_ID: '1SLA0PwsRnQ0ow6TuUZPsZ0d9tcUqpJKR_IFMSKI9g1s',
    DATABASE_RANGE: 'Database!A:G',
    QUOTES_RANGE: 'Preventivi_Salvati!A:Z'
};

let equipmentDatabase = {};
let savedQuotes = [];
let isConnected = false;
let gapi_loaded = false;
let rowCounter = 0;

function initializeGoogleAPI() {
    updateConnectionStatus('syncing', 'Connessione in corso...');
    gapi.load('client', async () => {
        try {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            });
            gapi_loaded = true;
            isConnected = true;
            updateConnectionStatus('online', 'Connesso');
            await loadDatabaseFromSheets();
            showNotification('‚úÖ Sistema completo caricato!', 'success');
        } catch (error) {
            updateConnectionStatus('offline', 'Errore connessione');
            showNotification('‚ùå Errore: ' + error.message, 'error');
        }
    });
}

async function loadDatabaseFromSheets() {
    if (!gapi_loaded || !isConnected) return;
    try {
        updateConnectionStatus('syncing', 'Caricamento database...');
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: CONFIG.DATABASE_RANGE
        });
        const values = response.result.values;
        if (!values || values.length === 0) throw new Error('Nessun dato trovato');
        processEquipmentData(values);
        updateConnectionStatus('online', 'Database caricato');
        updateSyncTime();
        showNotification('‚úÖ Database caricato: ' + Object.keys(equipmentDatabase).length + ' categorie', 'success');
    } catch (error) {
        updateConnectionStatus('offline', 'Errore sync');
        showNotification('‚ùå Errore: ' + error.message, 'error');
    }
}

function processEquipmentData(values) {
    equipmentDatabase = {};
    const processedData = [];
    let currentCategory = '';
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (!row || row.length === 0) continue;
        const name = row[0] || '';
        const price1 = parseFloat(row[1]) || 0;
        const price3 = parseFloat(row[2]) || 0;
        const price7 = parseFloat(row[3]) || 0;
        const insurance = parseFloat(row[4]) || 0;
        const kit = row[5] || '';
        if (name && !price1 && !price3 && !price7 && !insurance) {
            currentCategory = name;
            if (!equipmentDatabase[currentCategory]) equipmentDatabase[currentCategory] = {};
        } else if (name && currentCategory) {
            equipmentDatabase[currentCategory][name] = {price1, price3, price7, insurance, kit};
            processedData.push({category: currentCategory, name, price1, price3, price7, insurance, kit});
        }
    }
    renderDatabase(processedData);
    updateCategoryFilter();
    updateDbStats();
}

function renderDatabase(data) {
    const tbody = document.getElementById('databaseBody');
    tbody.innerHTML = '';
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nessun dato disponibile</td></tr>';
        return;
    }
    let currentCategory = '';
    data.forEach((item) => {
        if (item.category !== currentCategory) {
            const categoryRow = document.createElement('tr');
            categoryRow.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
            categoryRow.style.color = 'white';
            categoryRow.style.fontWeight = 'bold';
            categoryRow.innerHTML = '<td colspan="7" style="text-align: center;">üìÅ ' + item.category + '</td>';
            tbody.appendChild(categoryRow);
            currentCategory = item.category;
        }
        const row = document.createElement('tr');
        row.innerHTML = '<td>' + item.name + '</td><td>‚Ç¨ ' + item.price1.toFixed(2) + '</td><td>‚Ç¨ ' + item.price3.toFixed(2) + '</td><td>‚Ç¨ ' + item.price7.toFixed(2) + '</td><td>‚Ç¨ ' + item.insurance.toLocaleString() + '</td><td style="font-size: 12px;">' + item.kit + '</td><td><button class="btn btn-warning" style="padding: 6px;">‚úèÔ∏è</button></td>';
        tbody.appendChild(row);
    });
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'quotes') createQuotesTab();
    if (tabName === 'saved') createSavedTab();
    if (tabName === 'analytics') createAnalyticsTab();
}

function createQuotesTab() {
    document.getElementById('quotes').innerHTML = `
        <h2 style="color: #2c5aa0; margin-bottom: 20px;">üé¨ Nuovo Preventivo</h2>
        <div style="background: #f8f9ff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; align-items: end;">
                <div><label style="display: block; margin-bottom: 8px; font-weight: bold;">Nome Preventivo</label><input type="text" id="quoteName" placeholder="Es: Spot TV Audi Q3" class="form-input" style="width: 100%;"></div>
                <button class="btn btn-success" onclick="saveQuote()">üíæ Salva</button>
                <button class="btn btn-primary" onclick="addEquipmentRow()">+ Attrezzatura</button>
                <button class="btn btn-info" onclick="generatePDF()">üìÑ PDF</button>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div><label style="display: block; margin-bottom: 8px; font-weight: bold;">Cliente</label><input type="text" id="cliente" placeholder="Nome cliente" class="form-input" style="width: 100%;"></div>
            <div><label style="display: block; margin-bottom: 8px; font-weight: bold;">Data Carico</label><input type="date" id="carico" class="form-input" style="width: 100%;"></div>
            <div><label style="display: block; margin-bottom: 8px; font-weight: bold;">Data Scarico</label><input type="date" id="scarico" class="form-input" style="width: 100%;"></div>
            <div><label style="display: block; margin-bottom: 8px; font-weight: bold;">Durata (gg)</label><input type="number" id="durata" value="1" min="1" onchange="updateAllPrices()" class="form-input" style="width: 100%;"></div>
        </div>
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
            <thead><tr style="background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white;">
                <th style="padding: 15px; text-align: left;">Categoria</th>
                <th style="padding: 15px; text-align: left;">Attrezzatura</th>
                <th style="padding: 15px; text-align: left;">Qt√†</th>
                <th style="padding: 15px; text-align: left;">Prezzo Unit.</th>
                <th style="padding: 15px; text-align: left;">Totale</th>
                <th style="padding: 15px; text-align: left;">Azioni</th>
            </tr></thead>
            <tbody id="equipmentRows"></tbody>
        </table>
        <div style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, #f8f9ff, #e8f5e8); border-radius: 15px; border: 2px solid #e1e5e9;">
            <div style="text-align: right;">
                <div style="margin: 8px 0; display: flex; justify-content: space-between;"><span>Subtotale:</span><span id="subtotale">‚Ç¨ 0.00</span></div>
                <div style="margin: 8px 0; display: flex; justify-content: space-between;"><span>Sconto:</span><span id="sconto-amount">‚Ç¨ 0.00</span></div>
                <div style="margin: 8px 0; display: flex; justify-content: space-between;"><span>IVA (22%):</span><span id="iva">‚Ç¨ 0.00</span></div>
                <div style="margin: 15px 0 0 0; padding-top: 12px; border-top: 2px solid #2c5aa0; font-size: 20px; font-weight: bold; color: #2c5aa0; display: flex; justify-content: space-between;"><span>TOTALE:</span><span id="totale">‚Ç¨ 0.00</span></div>
            </div>
        </div>
    `;
}

function createSavedTab() {
    document.getElementById('saved').innerHTML = `
        <h2 style="color: #2c5aa0; margin-bottom: 20px;">üíæ Preventivi Salvati</h2>
        <div id="savedQuotes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;">
                <h3>Nessun preventivo salvato</h3>
                <p>Crea il tuo primo preventivo nella sezione "Nuovo Preventivo"</p>
            </div>
        </div>
    `;
}

function createAnalyticsTab() {
    document.getElementById('analytics').innerHTML = `
        <h2 style="color: #2c5aa0; margin-bottom: 20px;">üìä Analytics & Statistiche</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Database</h3>
                <div style="font-size: 36px; font-weight: bold; color: #4CAF50;">${Object.keys(equipmentDatabase).length}</div>
                <div>Categorie attive</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Preventivi</h3>
                <div style="font-size: 36px; font-weight: bold; color: #FF9800;">${savedQuotes.length}</div>
                <div>Preventivi salvati</div>
            </div>
        </div>
    `;
}

function addEquipmentRow() {
    if (Object.keys(equipmentDatabase).length === 0) {
        showNotification('‚ö†Ô∏è Carica prima il database', 'warning');
        return;
    }
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.id = `row-${rowCounter}`;
    row.style.background = '#f8f9ff';
    row.innerHTML = `
        <td style="padding: 10px;">
            <select onchange="updateEquipmentOptions(${rowCounter})" id="category-${rowCounter}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Seleziona categoria...</option>
                ${Object.keys(equipmentDatabase).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
        </td>
        <td style="padding: 10px;">
            <select onchange="updateRowData(${rowCounter})" id="equipment-${rowCounter}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                <option value="">Prima seleziona categoria</option>
            </select>
        </td>
        <td style="padding: 10px;">
            <input type="number" value="1" min="1" onchange="updateRowTotal(${rowCounter})" id="qty-${rowCounter}" style="width: 60px; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 10px; text-align: right; font-weight: bold; color: #2e7d32;" id="price-${rowCounter}">‚Ç¨ 0.00</td>
        <td style="padding: 10px; text-align: right; font-weight: bold; color: #2e7d32;" id="total-${rowCounter}">‚Ç¨ 0.00</td>
        <td style="padding: 10px;">
            <button onclick="removeRow(${rowCounter})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
        </td>
    `;
    tbody.appendChild(row);
}

function updateEquipmentOptions(rowId) {
    const categorySelect = document.getElementById(`category-${rowId}`);
    const equipmentSelect = document.getElementById(`equipment-${rowId}`);
    const category = categorySelect.value;
    equipmentSelect.innerHTML = '<option value="">Seleziona attrezzatura...</option>';
    if (category && equipmentDatabase[category]) {
        equipmentSelect.disabled = false;
        Object.keys(equipmentDatabase[category]).forEach(equipment => {
            const option = document.createElement('option');
            option.value = equipment;
            option.textContent = equipment;
            equipmentSelect.appendChild(option);
        });
    } else {
        equipmentSelect.disabled = true;
    }
    document.getElementById(`price-${rowId}`).textContent = '‚Ç¨ 0.00';
    document.getElementById(`total-${rowId}`).textContent = '‚Ç¨ 0.00';
    updateTotals();
}

function updateRowData(rowId) {
    const categorySelect = document.getElementById(`category-${rowId}`);
    const equipmentSelect = document.getElementById(`equipment-${rowId}`);
    const category = categorySelect.value;
    const equipment = equipmentSelect.value;
    if (category && equipment && equipmentDatabase[category][equipment]) {
        const data = equipmentDatabase[category][equipment];
        const duration = parseInt(document.getElementById('durata').value);
        const price = calculatePrice(data.price1, data.price3, data.price7, duration);
        document.getElementById(`price-${rowId}`).textContent = `‚Ç¨ ${price.toFixed(2)}`;
        updateRowTotal(rowId);
    }
}

function calculatePrice(price1, price3, price7, duration) {
    if (duration === 1) return price1;
    if (duration === 2) return price1 * 2;
    if (duration === 3) return price3;
    if (duration === 4) return price3 + price1;
    if (duration === 5) return price7;
    if (duration === 6) return price7 + price1;
    if (duration === 7) return price7 + (price1 * 2);
    if (duration === 8) return price7 + price3;
    if (duration === 9) return price7 + price3 + price1;
    if (duration >= 10) return price7 * 2;
    return price1;
}

function updateRowTotal(rowId) {
    const priceText = document.getElementById(`price-${rowId}`).textContent;
    const quantity = parseInt(document.getElementById(`qty-${rowId}`).value) || 0;
    const price = parseFloat(priceText.replace('‚Ç¨ ', '')) || 0;
    const total = price * quantity;
    document.getElementById(`total-${rowId}`).textContent = `‚Ç¨ ${total.toFixed(2)}`;
    updateTotals();
}

function updateAllPrices() {
    const rows = document.querySelectorAll('[id^="row-"]');
    rows.forEach(row => {
        const rowId = row.id.split('-')[1];
        updateRowData(rowId);
    });
}

function updateTotals() {
    const totalCells = document.querySelectorAll('[id^="total-"]');
    let subtotal = 0;
    totalCells.forEach(cell => {
        const value = parseFloat(cell.textContent.replace('‚Ç¨ ', '')) || 0;
        subtotal += value;
    });
    const sconto = 0; // Placeholder
    const imponibile = subtotal - sconto;
    const iva = imponibile * 0.22;
    const totale = imponibile + iva;
    
    document.getElementById('subtotale').textContent = `‚Ç¨ ${subtotal.toFixed(2)}`;
    document.getElementById('sconto-amount').textContent = `‚Ç¨ ${sconto.toFixed(2)}`;
    document.getElementById('iva').textContent = `‚Ç¨ ${iva.toFixed(2)}`;
    document.getElementById('totale').textContent = `‚Ç¨ ${totale.toFixed(2)}`;
}

function removeRow(rowId) {
    const row = document.getElementById(`row-${rowId}`);
    if (row) {
        row.remove();
        updateTotals();
    }
}

function saveQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('‚ùå Inserisci un nome per il preventivo!', 'error');
        return;
    }
    const quote = {
        id: Date.now(),
        name: quoteName,
        cliente: document.getElementById('cliente').value,
        carico: document.getElementById('carico').value,
        scarico: document.getElementById('scarico').value,
        durata: document.getElementById('durata').value,
        equipment: [],
        createdAt: new Date().toLocaleString('it-IT'),
        total: parseFloat(document.getElementById('totale').textContent.replace('‚Ç¨ ', '')) || 0
    };
    document.querySelectorAll('[id^="row-"]').forEach(row => {
        const rowId = row.id.split('-')[1];
        const category = document.getElementById(`category-${rowId}`)?.value;
        const equipment = document.getElementById(`equipment-${rowId}`)?.value;
        const quantity = document.getElementById(`qty-${rowId}`)?.value;
        if (category && equipment) {
            quote.equipment.push({category, equipment, quantity: parseInt(quantity)});
        }
    });
    savedQuotes.push(quote);
    showNotification(`‚úÖ Preventivo "${quoteName}" salvato!`, 'success');
}

function generatePDF() {
    const quoteName = document.getElementById('quoteName').value || 'Preventivo';
    const cliente = document.getElementById('cliente').value || 'Cliente';
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES S.R.L.', 20, 20);
        doc.setFontSize(16);
        doc.text('PREVENTIVO', 20, 35);
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Cliente: ${cliente}`, 20, 50);
        doc.text(`Data Carico: ${document.getElementById('carico').value}`, 20, 60);
        doc.text(`Data Scarico: ${document.getElementById('scarico').value}`, 20, 70);
        doc.text(`Durata: ${document.getElementById('durata').value} giorni`, 20, 80);
        
        const tableData = [];
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            const category = document.getElementById(`category-${rowId}`)?.value;
            const equipment = document.getElementById(`equipment-${rowId}`)?.value;
            const quantity = document.getElementById(`qty-${rowId}`)?.value;
            const price = document.getElementById(`price-${rowId}`)?.textContent;
            const total = document.getElementById(`total-${rowId}`)?.textContent;
            if (category && equipment) {
                tableData.push([equipment, quantity, price, total]);
            }
        });
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Attrezzatura', 'Quantit√†', 'Prezzo Unit.', 'Totale']],
                body: tableData,
                startY: 90,
                theme: 'grid',
                headStyles: { fillColor: [44, 90, 160] }
            });
        }
        
        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 110;
        doc.text(`Subtotale: ${document.getElementById('subtotale').textContent}`, 130, finalY);
        doc.text(`IVA: ${document.getElementById('iva').textContent}`, 130, finalY + 10);
        doc.setFontSize(14);
        doc.setTextColor(44, 90, 160);
        doc.text(`TOTALE: ${document.getElementById('totale').textContent}`, 130, finalY + 25);
        
        doc.save(`${quoteName.replace(/[^a-z0-9]/gi, '_')}.pdf`);
        showNotification('‚úÖ PDF generato con successo!', 'success');
    } catch (error) {
        showNotification('‚ùå Errore nella generazione del PDF', 'error');
    }
}

function updateCategoryFilter() {
    const filter = document.getElementById('categoryFilter');
    filter.innerHTML = '<option value="">Tutte le categorie</option>';
    Object.keys(equipmentDatabase).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filter.appendChild(option);
    });
}

function updateDbStats() {
    const totalCategories = Object.keys(equipmentDatabase).length;
    let totalItems = 0;
    Object.values(equipmentDatabase).forEach(category => {
        totalItems += Object.keys(category).length;
    });
    document.getElementById('dbStats').textContent = totalCategories + ' categorie, ' + totalItems + ' attrezzature';
}

function filterDatabase() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#databaseBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function filterByCategory() {
    const selectedCategory = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('#databaseBody tr');
    if (!selectedCategory) {
        rows.forEach(row => row.style.display = '');
        return;
    }
    let showNextItems = false;
    rows.forEach(row => {
        if (row.style.background && row.style.background.includes('linear-gradient')) {
            const categoryText = row.textContent.trim().replace('üìÅ ', '');
            showNextItems = (categoryText === selectedCategory);
            row.style.display = showNextItems ? '' : 'none';
        } else {
            row.style.display = showNextItems ? '' : 'none';
        }
    });
}

function showConfigModal() {
    document.getElementById('apiKeyInput').value = CONFIG.API_KEY;
    document.getElementById('sheetsIdInput').value = CONFIG.SHEETS_ID;
    document.getElementById('configModal').classList.add('active');
}

function closeConfigModal() {
    document.getElementById('configModal').classList.remove('active');
}

function saveConfig() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const sheetsId = document.getElementById('sheetsIdInput').value.trim();
    if (!apiKey || !sheetsId) {
        showNotification('‚ùå Inserisci API Key e Sheets ID', 'error');
        return;
    }
    CONFIG.API_KEY = apiKey;
    CONFIG.SHEETS_ID = sheetsId;
    closeConfigModal();
    showNotification('‚öôÔ∏è Configurazione salvata. Connessione in corso...', 'info');
    setTimeout(() => initializeGoogleAPI(), 1000);
}

function syncDatabase() {
    loadDatabaseFromSheets();
}

function updateConnectionStatus(status, message) {
    const indicator = document.getElementById('connectionStatus');
    const text = document.getElementById('connectionText');
    indicator.className = 'status-indicator status-' + status;
    text.textContent = message;
}

function updateSyncTime() {
    document.getElementById('lastSync').textContent = 'Ultimo sync: ' + new Date().toLocaleTimeString('it-IT');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = 'notification ' + type;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

function addNewEquipment() {
    showNotification('üîß Funzione in sviluppo', 'info');
}

window.addEventListener('load', function() {
    updateConnectionStatus('offline', 'Configurazione richiesta');
    if (CONFIG.API_KEY && CONFIG.SHEETS_ID) {
        initializeGoogleAPI();
    } else {
        showNotification('‚öôÔ∏è Clicca su Config per configurare le API', 'warning');
    }
});
</script>
</body>
</html>
