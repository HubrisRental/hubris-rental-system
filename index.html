<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubris Rental - Sistema Completo</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Trebuchet MS', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #2c5aa0; }
        .connection-status { display: flex; align-items: center; gap: 15px; font-size: 14px; color: #666; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background: #4CAF50; }
        .status-syncing { background: #FF9800; animation: pulse 1s infinite; }
        .status-offline { background: #F44336; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .container { max-width: 1400px; margin: 20px auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; backdrop-filter: blur(10px); }
        .tabs { display: flex; background: linear-gradient(90deg, #2c5aa0 0%, #1a4480 100%); overflow-x: auto; }
        .tab { flex: 1; padding: 20px 25px; cursor: pointer; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-weight: 600; font-size: 16px; transition: all 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-2px); }
        .tab:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .btn-danger { background: linear-gradient(135deg, #F44336, #D32F2F); color: white; }
        .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
        .form-input { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; outline: none; transition: all 0.3s ease; }
        .form-input:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { 
    background: white; 
    padding: 20px; 
    border-radius: 15px; 
    max-width: 500px; 
    width: 90%; 
    max-height: 80vh; 
    overflow-y: auto; 
    margin: 20px;
    position: relative;
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        max-width: none;
        margin: 10px;
        padding: 15px;
        max-height: 90vh;
    }
}
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; font-weight: bold; z-index: 1000; animation: slideIn 0.3s ease; max-width: 300px; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #F44336; }
        .notification.info { background: #2196F3; }
        .notification.warning { background: #FF9800; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); max-height: 600px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        .data-table tr:hover { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); }
        .category-row { background: linear-gradient(135deg, #FF9800, #F57C00) !important; color: white; font-weight: bold; }
        .category-row:hover { background: linear-gradient(135deg, #F57C00, #EF6C00) !important; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .section-title { font-size: 28px; font-weight: bold; color: #2c5aa0; }
        .controls-grid { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; margin-bottom: 25px; align-items: center; }
        .search-box { padding: 12px 20px; border: 2px solid #e1e5e9; border-radius: 25px; font-size: 16px; outline: none; transition: all 0.3s ease; background: white; }
        .search-box:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-select { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 12px; background: white; font-size: 14px; cursor: pointer; outline: none; transition: border-color 0.3s ease; }
        .filter-select:focus { border-color: #ff9800; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
        .quote-header { background: linear-gradient(135deg, #f8f9ff, #e3f2fd); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #e1e5e9; }
        .quote-controls { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 15px; align-items: end; }
        .equipment-section { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .equipment-header { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .totals-section { background: linear-gradient(135deg, #f8f9ff, #e8f5e8); padding: 25px; border-radius: 15px; margin-top: 25px; border: 2px solid #e1e5e9; }
        .total-line { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; }
        .total-line.final { border-top: 2px solid #2c5aa0; padding-top: 12px; margin-top: 15px; font-size: 20px; font-weight: bold; color: #2c5aa0; }
        .quotes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .quote-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; }
        .quote-card:hover { border-color: #2c5aa0; transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .quote-title { font-size: 18px; font-weight: bold; color: #2c5aa0; margin-bottom: 10px; }
        .quote-meta { font-size: 13px; color: #666; margin-bottom: 15px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-draft { background: #fff3e0; color: #f57c00; }
        .status-sent { background: #e8f5e8; color: #4caf50; }
        .status-confirmed { background: #e3f2fd; color: #2196f3; }
        @media (max-width: 768px) { .nav-content { flex-direction: column; gap: 10px; } .container { margin: 10px; border-radius: 15px; } .tab-content { padding: 20px; } .controls-grid { grid-template-columns: 1fr; gap: 10px; } .form-grid { grid-template-columns: 1fr; } .quote-controls { grid-template-columns: 1fr; gap: 10px; } .data-table { font-size: 12px; } .data-table th, .data-table td { padding: 8px 6px; } .quotes-grid { grid-template-columns: 1fr; } }
    /* Drag & Drop styles */
.equipment-row.dragging { opacity: 0.5; }
.equipment-row.drag-over { border-top: 3px solid #2c5aa0; }
.drag-handle { cursor: move; padding: 5px; color: #666; }
.drag-handle:hover { color: #2c5aa0; }
.move-buttons { display: flex; flex-direction: column; gap: 2px; }
.move-btn { padding: 2px 6px; font-size: 10px; background: #f0f0f0; border: 1px solid #ddd; cursor: pointer; }
.move-btn:hover { background: #e0e0e0; }

/* Select with search */
.select-search-wrapper { position: relative; }
.select-search { 
    position: absolute; 
    top: 100%; 
    left: 0; 
    right: 0; 
    background: white; 
    border: 2px solid #2c5aa0; 
    border-radius: 8px; 
    max-height: 200px; 
    overflow-y: auto; 
    z-index: 1000;
    display: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.select-search.active { display: block; }
.select-search-input { 
    width: 100%; 
    padding: 8px; 
    border: none; 
    border-bottom: 1px solid #eee;
    outline: none;
}
.select-search-item { 
    padding: 8px 12px; 
    cursor: pointer; 
    font-size: 14px;
}
.select-search-item:hover { background: #f0f4ff; }
.select-search-item.selected { background: #e3f2fd; }
.category-label { 
    font-size: 11px; 
    color: #666; 
    font-weight: bold; 
    text-transform: uppercase; 
    margin-left: 5px;
}

/* Editable fields */
.editable-input {
    border: 1px dashed transparent;
    padding: 4px 8px;
    border-radius: 4px;
    background: transparent;
    width: 100%;
    text-align: inherit;
}
.editable-input:hover {
    border-color: #ddd;
    background: #f8f9ff;
}
.editable-input:focus {
    border-color: #2c5aa0;
    background: white;
    outline: none;
}
    </style>
</head>
<body>
    <nav class="navbar">
    <div class="nav-content">
      <div class="logo" style="display: flex; align-items: center; gap: 10px;">
    <img src="https://i.imgur.com/ABMgyI8.png" alt="Hubris Pictures Logo" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;">
    <span style="font-size: 20px; font-weight: bold; color: #2c5aa0;">HUBRIS PICTURES S.R.L.</span>
</div>
        <div class="connection-status">
            <span class="status-indicator" id="connectionStatus"></span>
            <span id="connectionText">Connecting...</span>
            <span>|</span>
            <span id="lastSync">Ultimo sync: mai</span>
            <span>|</span>
<button class="btn btn-warning" onclick="document.getElementById('configModal').classList.add('active')" style="padding: 6px 12px; font-size: 12px;">‚öôÔ∏è Config</button>
    </div>
</nav>
<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('database')">üóÑÔ∏è Database</button>
        <button class="tab" onclick="showTab('quotes')">üìã Nuovo Preventivo</button>
        <button class="tab" onclick="showTab('saved')">üíæ Preventivi Salvati</button>
        <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
    </div>

   <!-- CONFIG MODAL -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <h2 style="color: #2c5aa0; margin-bottom: 20px;">‚öôÔ∏è Configurazione Sistema</h2>
        <div class="form-group">
            <label class="form-label">API Key:</label>
            <input type="text" class="form-input" id="apiKeyInput" placeholder="Inserisci la tua API Key">
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label class="form-label">Sheets ID:</label>
            <input type="text" class="form-input" id="sheetsIdInput" placeholder="ID del tuo Google Sheets">
        </div>
   <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap;">
    <button class="btn btn-danger" onclick="document.getElementById('configModal').classList.remove('active')" style="flex: 1; min-width: 100px;">Annulla</button>
   <button class="btn btn-success" id="saveConfigBtn" style="flex: 1; min-width: 120px;">üíæ Salva</button>
        </div>
    </div>
</div>

    <!-- DATABASE TAB -->
    <div id="database" class="tab-content active">
        <div class="section-header">
            <h2 class="section-title">Database Attrezzature</h2>
            <div id="dbStats" style="font-size: 14px; color: #666;"></div>
        </div>
        <div class="controls-grid">
            <input type="text" class="search-box" placeholder="üîç Cerca attrezzatura..." onkeyup="filterDatabase()" id="searchInput">
            <select class="filter-select" onchange="filterByCategory()" id="categoryFilter">
                <option value="">Tutte le categorie</option>
            </select>
            <button class="btn btn-success" onclick="addNewEquipment()">+ Nuova</button>
            <button class="btn btn-warning" onclick="syncDatabase()" id="syncBtn">üîÑ Sync</button>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Attrezzatura</th>
                        <th>1 Giorno</th>
                        <th>3 Giorni</th>
                        <th>1 Settimana</th>
                        <th>Valore Assic.</th>
                        <th>Kit/Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="databaseBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Configura le API per caricare il database...</td></tr>
               </tbody>
            </table>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
            <button class="btn btn-primary" onclick="addEquipmentRow()">+ Attrezzatura</button>
            <button class="btn btn-info" onclick="addServiceRow()">+ Servizio</button>
        </div>
    </div>

    <!-- QUOTES TAB -->
    <div id="quotes" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Nuovo Preventivo</h2>
        </div>
        <div class="quote-header">
            <div class="quote-controls">
                <div class="form-group">
                    <label class="form-label">Nome Preventivo</label>
                    <input type="text" class="form-input" id="quoteName" placeholder="Es: Spot TV Audi Q3">
                </div>
                <button class="btn btn-success" onclick="saveQuote()">üíæ Salva</button>
                <button class="btn btn-info" onclick="loadQuote()">üìÇ Carica</button>
                <button class="btn btn-warning" onclick="duplicateQuote()">üìÑ Duplica</button>
                <button class="btn btn-danger" onclick="resetQuote()">üîÑ Reset</button>
            </div>
        </div>
       <div class="form-grid">
    <div class="form-group">
        <label class="form-label">Cliente</label>
        <input type="text" class="form-input" id="cliente" placeholder="Nome del cliente">
    </div>
    <div class="form-group">
        <label class="form-label">P.IVA Cliente</label>
        <input type="text" class="form-input" id="clientePiva" placeholder="Partita IVA del cliente">
    </div>
    <div class="form-group">
        <label class="form-label">Via/Indirizzo</label>
        <input type="text" class="form-input" id="clienteVia" placeholder="Via/Indirizzo del cliente">
    </div>
    <div class="form-group">
        <label class="form-label">Codice Univoco</label>
        <input type="text" class="form-input" id="codiceUnivoco" placeholder="Codice SDI/PEC">
    </div>
    <div class="form-group">
        <label class="form-label">Contatti</label>
        <input type="text" class="form-input" id="contatti" placeholder="Telefono/Email">
    </div>
            <div class="form-group">
                <label class="form-label">Data Carico</label>
                <input type="date" class="form-input" id="carico">
            </div>
            <div class="form-group">
                <label class="form-label">Data Scarico</label>
                <input type="date" class="form-input" id="scarico">
            </div>
        </div>
        <div class="form-grid" style="grid-template-columns: auto auto auto 1fr auto auto;">
            <div class="form-group">
                <label class="form-label">Durata (giorni)</label>
                <input type="number" class="form-input" id="durata" value="1" min="1" max="30" onchange="updateAllPrices()" style="width: 100px;">
            </div>
            <div class="form-group">
                <label class="form-label">Sconto (%)</label>
                <input type="number" class="form-input" id="sconto" value="0" min="0" max="50" step="0.1" onchange="updateTotals()" style="width: 100px;">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-input" id="quoteType">
                    <option value="rental">Noleggio</option>
                    <option value="sale">Vendita</option>
                    <option value="service">Servizio</option>
                </select>
            </div>
            <div></div>
        </div>
        <div class="equipment-section">
         <div class="equipment-header">
    <h3>Lista Attrezzature e Servizi</h3>
    <div>
        <button class="btn btn-info" onclick="generatePDF()">üìÑ Preventivo</button>
        <button class="btn btn-primary" onclick="generateWord()">üìù Word</button>
        <button class="btn btn-success" onclick="generateNoPricesQuote()">üìã Senza Prezzi</button>
        <button class="btn btn-warning" onclick="generateDDT()">üöõ DDT</button>
        <button class="btn btn-warning" onclick="generateInsurance()">üõ°Ô∏è Assicurazione</button>
    </div>
</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 180px;">Categoria</th>
                        <th style="width: 220px;">Attrezzatura/Servizio</th>
                        <th style="width: 80px;">Qt√†</th>
                        <th style="width: 120px;">Prezzo Unit.</th>
                        <th style="width: 120px;">Totale</th>
                        <th style="width: 80px;">Azioni</th>
                    </tr>
                </thead>
                <tbody id="equipmentRows"></tbody>
            </table>
        </div>
        <div class="totals-section">
            <div>
                <div class="total-line">
                    <span>Subtotale:</span>
                    <span id="subtotale" onclick="makeSubtotalEditable()" style="cursor: pointer; text-decoration: underline;" title="Clicca per modificare">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line">
                    <span>Sconto (<span id="discount-percent">0</span>%):</span>
                    <span id="sconto-amount">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line">
                    <span>Imponibile:</span>
                    <span id="imponibile">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line">
                    <span>IVA (22%):</span>
                    <span id="iva">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line final">
                    <span>TOTALE:</span>
                    <span id="totale">‚Ç¨ 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVED QUOTES TAB -->
    <div id="saved" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Preventivi Salvati</h2>
            <div>
                <button class="btn btn-warning" onclick="syncQuotes()">üîÑ Aggiorna</button>
                <button class="btn btn-info" onclick="exportAllQuotes()">üìä Export Excel</button>
            </div>
        </div>
        <div class="quotes-grid" id="savedQuotes">
            <div class="quote-card">
                <div class="quote-title">Caricamento...</div>
                <div class="quote-meta">Sincronizzazione con Google Sheets in corso...</div>
            </div>
        </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Analytics & Statistiche</h2>
            <button class="btn btn-info" onclick="generateAnalyticsReport()">üìä Report Completo</button>
        </div>
        <div class="form-grid">
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Preventivi Questo Mese</h3>
                <div style="font-size: 36px; font-weight: bold; color: #4CAF50;" id="monthlyQuotes">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Fatturato Stimato</h3>
                <div style="font-size: 36px; font-weight: bold; color: #FF9800;" id="estimatedRevenue">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Attrezzature Pi√π Richieste</h3>
                <div style="font-size: 18px; font-weight: bold; color: #2196F3;" id="topEquipment">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Tasso di Conversione</h3>
                <div style="font-size: 36px; font-weight: bold; color: #9C27B0;" id="conversionRate">-</div>
            </div>
        </div>
    </div>
</div>
<script>
// FIX CONFIG BUTTON - DEVE ESSERE PRIMA DI TUTTO
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'saveConfigBtn') {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        const sheetsId = document.getElementById('sheetsIdInput').value.trim();
        if (!apiKey || !sheetsId) {
            alert('Inserisci API Key e Sheets ID');
            return;
        }
        CONFIG.API_KEY = apiKey;
        CONFIG.SHEETS_ID = sheetsId;
        localStorage.setItem('hubris_api_key', apiKey);
        localStorage.setItem('hubris_sheets_id', sheetsId);
        document.getElementById('configModal').classList.remove('active');
        alert('Configurazione salvata! Ricarica la pagina.');
        location.reload();
    }
});
// CONFIGURAZIONE GLOBALE - CON I TUOI DATI
let CONFIG = {
    API_KEY: 'AIzaSyAbcQrfJiXQMIbBAb5ZOLvm_9tEz73d1DY',
    SHEETS_ID: '1gzjiGiZkyKeaE6f0iBKoeUNW7bbhemdQiipGknnd6Pc',
    DATABASE_RANGE: 'Database!A:G',
    QUOTES_RANGE: 'Preventivi_Salvati!A:Z'
};

// STATO GLOBALE
let equipmentDatabase = {};
let savedQuotes = [];
let isConnected = false;
let gapi_loaded = false;
let rowCounter = 0;

// CONFIGURATION MODAL FUNCTIONS
// CONFIGURATION MODAL FUNCTIONS - GLOBALI
window.showConfigModal = function() {
    console.log('Opening config modal...');
    const modal = document.getElementById('configModal');
    if (modal) {
        document.getElementById('apiKeyInput').value = CONFIG.API_KEY || '';
        document.getElementById('sheetsIdInput').value = CONFIG.SHEETS_ID || '';
        modal.classList.add('active');
    } else {
        console.error('Config modal not found!');
    }
}

window.closeConfigModal = function() {
    const modal = document.getElementById('configModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

window.saveConfig = function() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const sheetsId = document.getElementById('sheetsIdInput').value.trim();
    
        // Validazione input
    if (!apiKey || !sheetsId) {
        showNotification('‚ùå Inserisci API Key e Sheets ID', 'error');
        return;
    }
    
    // Validazione formato API Key (deve iniziare con AIza)
    if (!apiKey.startsWith('AIza') || apiKey.length < 39) {
        showNotification('‚ùå API Key non valida (deve iniziare con AIza e avere 39 caratteri)', 'error');
        showNotification('üí° Genera una nuova API Key da Google Cloud Console', 'info');
        return;
    }
    
    // Validazione formato Sheets ID (lunghezza minima)
    if (sheetsId.length < 20 || sheetsId.includes(' ')) {
        showNotification('‚ùå Sheets ID non valido (controlla di non avere spazi)', 'error');
        return;
    }
    
    console.log('üíæ Salvataggio nuova configurazione...');
    
    try {
        // Reset stato precedente
        isConnected = false;
        gapi_loaded = false;
        updateConnectionStatus('offline', 'Configurazione in corso...');
        
        // Salva nuova configurazione
        CONFIG.API_KEY = apiKey;
        CONFIG.SHEETS_ID = sheetsId;
        localStorage.setItem('hubris_api_key', apiKey);
        localStorage.setItem('hubris_sheets_id', sheetsId);
        
        closeConfigModal();
        showNotification('‚öôÔ∏è Configurazione salvata. Test connessione...', 'info');
        
        // Test immediato della configurazione
        if (typeof gapi !== 'undefined' && gapi.client) {
            // Se gapi √® gi√† caricato, reinizializza
            gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            }).then(() => {
                console.log('üîÑ Reinizializzazione API completata');
                initializeGoogleAPI();
            }).catch((error) => {
                console.error('‚ùå Errore reinizializzazione:', error);
                showNotification('‚ùå Errore: API Key non valida', 'error');
            });
        } else {
            // Altrimenti inizializza normalmente
            setTimeout(() => {
                console.log('üîÑ Avvio test connessione con nuova configurazione...');
                initializeGoogleAPI();
            }, 1500);
        }
        
    } catch (error) {
        console.error('‚ùå Errore salvataggio configurazione:', error);
        showNotification('‚ùå Errore nel salvataggio della configurazione', 'error');
    }

}

// GOOGLE SHEETS API INITIALIZATION
function initializeGoogleAPI() {
    if (!CONFIG.API_KEY || !CONFIG.SHEETS_ID) {
        updateConnectionStatus('offline', 'Configurazione mancante');
        showNotification('‚öôÔ∏è Configurazione API mancante - Clicca su Config', 'warning');
        return;
    }

    updateConnectionStatus('syncing', 'Connessione in corso...');
    
    // Verifica se gapi √® disponibile
    if (typeof gapi === 'undefined') {
        console.error('Google API non caricata');
        updateConnectionStatus('offline', 'Google API non disponibile');
        showNotification('‚ùå Google API non caricata. Ricaricare la pagina.', 'error');
        return;
    }

    gapi.load('client', {
        callback: async () => {
            try {
                console.log('üîÑ Inizializzazione Google API...');
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });
                
                console.log('‚úÖ Google API inizializzata');
                gapi_loaded = true;
                isConnected = true;
                updateConnectionStatus('online', 'Connesso');
                
                // Test connessione con un tentativo di lettura
                try {
                    // Prima verifica che il foglio esista
                    const testResponse = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: CONFIG.SHEETS_ID
                    });
                    
                    if (testResponse && testResponse.result) {
                        console.log('‚úÖ Google Sheet verificato:', testResponse.result.properties.title);
                        await loadDatabaseFromSheets();
                        await loadQuotesFromSheets();
                        showNotification('‚úÖ Connessione Google Sheets stabilita!', 'success');
                    }
                } catch (loadError) {
                    console.error('Errore caricamento dati:', loadError);
                    
                    if (loadError.status === 403) {
                        showNotification('‚ùå API Key non valida o senza permessi', 'error');
                        showNotification('üí° Genera una nuova API Key da Google Cloud Console', 'info');
                    } else if (loadError.status === 404) {
                        showNotification('‚ùå Google Sheet non trovato o non condiviso', 'error');
                    } else {
                        showNotification('‚ö†Ô∏è Connesso ma errore nel caricamento dati', 'warning');
                    }
                }
                
            } catch (error) {
                console.error('Errore inizializzazione API:', error);
                gapi_loaded = false;
                isConnected = false;
                updateConnectionStatus('offline', 'Errore connessione');
                
                // Messaggi di errore pi√π specifici
                if (error.error && error.error.code === 400) {
                    showNotification('‚ùå API Key non valida - Verificare configurazione', 'error');
                    showNotification('üí° Vai su Config e inserisci una API Key valida', 'info');
                } else if (error.message && error.message.includes('API key not valid')) {
                    showNotification('‚ùå API Key non valida o disabilitata', 'error');
                } else {
                    showNotification('‚ùå Errore connessione: ' + (error.message || 'Sconosciuto'), 'error');
                }
            }
        },
        onerror: (error) => {
            console.error('Errore caricamento gapi:', error);
            updateConnectionStatus('offline', 'Errore caricamento API');
            showNotification('‚ùå Errore nel caricamento delle API Google', 'error');
        }
    });
}
// GOOGLE SHEETS DATA LOADING
async function loadDatabaseFromSheets() {
    if (!gapi_loaded || !isConnected) {
        console.log('‚ö†Ô∏è API non inizializzate, skippo caricamento database');
        return;
    }

    try {
        updateConnectionStatus('syncing', 'Sincronizzazione database...');
        console.log('üîÑ Caricamento database da Sheets ID:', CONFIG.SHEETS_ID);
        console.log('üîÑ Range:', CONFIG.DATABASE_RANGE);

        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: CONFIG.DATABASE_RANGE
        });

        console.log('üìä Risposta API ricevuta:', response);

        if (!response || !response.result) {
            throw new Error('Risposta API vuota');
        }

        const values = response.result.values;
        console.log('üìã Dati ricevuti:', values ? values.length + ' righe' : 'nessun dato');

        if (!values || values.length === 0) {
            throw new Error('Nessun dato trovato nel database. Verificare il range: ' + CONFIG.DATABASE_RANGE);
        }

        if (values.length < 2) {
            throw new Error('Database troppo piccolo (solo ' + values.length + ' righe)');
        }

        processEquipmentData(values);
        updateConnectionStatus('online', 'Database aggiornato');
        updateSyncTime();
        
        const categoriesCount = Object.keys(equipmentDatabase).length;
        let itemsCount = 0;
        Object.values(equipmentDatabase).forEach(cat => {
            itemsCount += Object.keys(cat).length;
        });

        showNotification(`‚úÖ Database caricato: ${categoriesCount} categorie, ${itemsCount} articoli`, 'success');
        console.log('‚úÖ Database processato con successo');

    } catch (error) {
        console.error('‚ùå Errore dettagliato caricamento database:', error);
        updateConnectionStatus('offline', 'Errore sync database');
        
        // Messaggi di errore pi√π specifici
        if (error.status === 403) {
            showNotification('‚ùå Accesso negato. Verificare:', 'error');
            showNotification('1Ô∏è‚É£ API Key abilitata per Sheets API', 'info');
            showNotification('2Ô∏è‚É£ Google Sheet condiviso pubblicamente', 'info');
        } else if (error.status === 404) {
            showNotification('‚ùå Google Sheet non trovato. Verificare ID.', 'error');
        } else if (error.status === 400) {
            showNotification('‚ùå Richiesta non valida. Verificare range: ' + CONFIG.DATABASE_RANGE, 'error');
        } else if (error.message && error.message.includes('API key not valid')) {
            showNotification('‚ùå API Key non valida o disabilitata', 'error');
            showNotification('üí° Genera una nuova API Key da Google Cloud Console', 'info');
        } else {
            showNotification('‚ùå Errore database: ' + (error.message || 'Sconosciuto'), 'error');
        }
    }
}

async function loadQuotesFromSheets() {
    console.log('üîÑ Caricamento preventivi...');
    
    // SEMPRE carica da localStorage prima
    const localQuotes = localStorage.getItem('hubris_quotes');
    if (localQuotes) {
        try {
            const parsedQuotes = JSON.parse(localQuotes);
            if (Array.isArray(parsedQuotes)) {
                savedQuotes = parsedQuotes;
                renderSavedQuotes();
                updateAnalytics();
                console.log('‚úÖ Preventivi caricati da localStorage:', savedQuotes.length);
                if (savedQuotes.length > 0) {
                    showNotification(`üìÇ ${savedQuotes.length} preventivi caricati`, 'success');
                }
            } else {
                console.log('‚ö†Ô∏è Formato localStorage non valido, reset');
                savedQuotes = [];
                localStorage.removeItem('hubris_quotes');
            }
        } catch (e) {
            console.error('‚ùå Errore parsing localStorage:', e);
            savedQuotes = [];
            localStorage.removeItem('hubris_quotes');
        }
    } else {
        console.log('üìÇ Nessun preventivo in localStorage');
        savedQuotes = [];
    }
    
    // Sempre renderizza, anche se vuoto
    renderSavedQuotes();
    updateAnalytics();
    
    // Tentativo opzionale Google Sheets (solo se connesso)
    if (gapi_loaded && isConnected) {
        try {
            console.log('üîÑ Tentativo sync Google Sheets preventivi...');
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: CONFIG.SHEETS_ID,
                range: CONFIG.QUOTES_RANGE
            });
            
            if (response && response.result && response.result.values) {
                const values = response.result.values;
                if (values.length > 1) {
                    const sheetsQuotes = parseQuotesData(values);
                    console.log('üìä Preventivi trovati su Google Sheets:', sheetsQuotes.length);
                    
                    // Merge intelligente (evita duplicati)
                    let merged = 0;
                    sheetsQuotes.forEach(sheetQuote => {
                        const existsLocally = savedQuotes.find(localQuote => 
                            localQuote.id === sheetQuote.id || 
                            (localQuote.name === sheetQuote.name && localQuote.cliente === sheetQuote.cliente)
                        );
                        
                        if (!existsLocally) {
                            savedQuotes.push(sheetQuote);
                            merged++;
                        }
                    });
                    
                    if (merged > 0) {
                        localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
                        renderSavedQuotes();
                        updateAnalytics();
                        showNotification(`üîÑ ${merged} preventivi sincronizzati da Google Sheets`, 'info');
                    }
                }
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Google Sheets preventivi non disponibile:', error.message);
            // Non mostrare errore all'utente, √® normale che non ci sia il foglio preventivi
        }
    }
}

async function saveQuoteToSheets(quote) {
    // Salva sempre in localStorage
    localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
    
    if (!gapi_loaded || !isConnected) {
        showNotification('üíæ Preventivo salvato localmente - sincronizzazione quando connesso', 'warning');
        return;
    }
    try {
        const quoteRow = [
            quote.id, quote.name, quote.cliente, quote.clientePiva || '', quote.contatti, 
            quote.carico, quote.scarico, quote.durata, quote.sconto, quote.total, 
            quote.status, quote.createdAt, JSON.stringify(quote.equipment)
        ];
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: 'Preventivi_Salvati!A:M',
            valueInputOption: 'RAW',
            resource: { values: [quoteRow] }
        });
        showNotification('‚úÖ Preventivo salvato su Google Sheets', 'success');
    } catch (error) {
        console.error('Errore salvataggio:', error);
        showNotification('‚ùå Errore salvataggio su Google Sheets, salvato localmente', 'error');
    }
}

// DATA PROCESSING
function processEquipmentData(values) {
    console.log('üîÑ Processamento dati database...');
    
    if (!values || !Array.isArray(values) || values.length < 2) {
        console.error('‚ùå Dati non validi per processamento');
        showNotification('‚ùå Formato dati database non valido', 'error');
        return;
    }
    
    equipmentDatabase = {};
    const processedData = [];
    let currentCategory = '';
    let processedRows = 0;
    let skippedRows = 0;
    
    // Salta l'header (riga 0)
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        
        // Salta righe vuote o incomplete
        if (!row || row.length === 0) {
            skippedRows++;
            continue;
        }
        
        const name = (row[0] || '').toString().trim();
        const price1 = parseFloat(row[1]) || 0;
        const price3 = parseFloat(row[2]) || 0;
        const price7 = parseFloat(row[3]) || 0;
        const insurance = parseFloat(row[4]) || 0;
        const kit = (row[5] || '').toString().trim();
        const notes = (row[6] || '').toString().trim();
        
        // Logica migliorata per identificare categorie vs articoli
        if (name) {
            // √à una categoria se ha solo nome e nessun prezzo
            if (!price1 && !price3 && !price7 && !insurance && !kit) {
                currentCategory = name;
                if (!equipmentDatabase[currentCategory]) {
                    equipmentDatabase[currentCategory] = {};
                }
                console.log('üìÅ Nuova categoria:', currentCategory);
            } 
            // √à un articolo se ha almeno un prezzo E una categoria corrente
            else if (currentCategory && (price1 > 0 || price3 > 0 || price7 > 0)) {
                equipmentDatabase[currentCategory][name] = {
                    price1, price3, price7, insurance, kit, notes
                };
                processedData.push({
                    category: currentCategory, 
                    name, 
                    price1, 
                    price3, 
                    price7, 
                    insurance, 
                    kit, 
                    notes
                });
                processedRows++;
            } else {
                console.log('‚ö†Ô∏è Riga saltata (no categoria o prezzi):', name);
                skippedRows++;
            }
        } else {
            skippedRows++;
        }
    }
    
    console.log(`‚úÖ Processamento completato: ${processedRows} articoli, ${skippedRows} righe saltate`);
    console.log(`üìä Categorie create: ${Object.keys(equipmentDatabase).length}`);
    
    // Verifica che ci siano dati processati
    if (processedRows === 0) {
        console.error('‚ùå Nessun articolo processato dal database');
        showNotification('‚ùå Nessun articolo trovato nel database', 'error');
        return;
    }
    
    // Aggiorna l'interfaccia
    renderDatabase(processedData);
    updateCategoryFilter();
    updateDbStats();
    
    console.log('üéØ Database processato e renderizzato con successo');
}

function parseQuotesData(values) {
    const quotes = [];
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (row && row.length >= 12) {
            quotes.push({
                id: parseInt(row[0]) || Date.now(),
                name: row[1] || '',
                cliente: row[2] || '',
                clientePiva: row[3] || '',
                contatti: row[4] || '',
                carico: row[5] || '',
                scarico: row[6] || '',
                durata: parseInt(row[7]) || 1,
                sconto: parseFloat(row[8]) || 0,
                total: parseFloat(row[9]) || 0,
                status: row[10] || 'draft',
                createdAt: row[11] || '',
                equipment: JSON.parse(row[12] || '[]')
            });
        }
    }
    return quotes;
}

// NUOVA FUNZIONE PER AGGIUNGERE SERVIZI
function addServiceRow() {
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.className = 'equipment-row service-row';
    row.id = 'row-' + rowCounter;
    row.style.background = '#fff3e0';
    row.innerHTML = `
        <td style="color: #f57c00; font-weight: bold;">üîß SERVIZIO</td>
        <td>
            <input type="text" class="form-input" placeholder="Nome del servizio (es. Trasporto)" 
                   id="service-name-${rowCounter}" style="width: 100%; margin-bottom: 5px;">
            <textarea class="form-input" placeholder="Note servizio..." 
                      id="service-notes-${rowCounter}" style="width: 100%; height: 60px; resize: vertical;"></textarea>
        </td>
        <td>
            <input type="number" class="form-input" value="1" min="1" 
                   onchange="updateRowTotal(${rowCounter})" id="qty-${rowCounter}" 
                   style="width: 100%; text-align: center;">
        </td>
        <td>
            <input type="number" class="form-input" placeholder="0.00" min="0" step="0.01" 
                   onchange="updateRowTotal(${rowCounter})" id="service-price-${rowCounter}" 
                   style="width: 100%; text-align: right;">
        </td>
        <td style="text-align: right; font-weight: bold; color: #f57c00;" id="total-${rowCounter}">‚Ç¨ 0.00</td>
        <td>
            <button class="btn btn-danger" onclick="removeRow(${rowCounter})" 
                    style="padding: 6px 12px; font-size: 12px;">‚úï</button>
        </td>
    `;
    tbody.appendChild(row);
}

// UI RENDERING
function renderDatabase(data) {
    const tbody = document.getElementById('databaseBody');
    tbody.innerHTML = '';
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nessun dato disponibile. Configura le API per caricare il database.</td></tr>';
        return;
    }
    let currentCategory = '';
    data.forEach((item, index) => {
        if (item.category !== currentCategory) {
            const categoryRow = document.createElement('tr');
            categoryRow.className = 'category-row';
            categoryRow.innerHTML = '<td colspan="7" style="text-align: center; font-weight: bold;">üìÅ ' + item.category + '</td>';
            tbody.appendChild(categoryRow);
            currentCategory = item.category;
        }
        const row = document.createElement('tr');
        row.innerHTML = '<td style="font-weight: 500;">' + item.name + '</td><td>‚Ç¨ ' + item.price1.toFixed(2) + '</td><td>‚Ç¨ ' + item.price3.toFixed(2) + '</td><td>‚Ç¨ ' + item.price7.toFixed(2) + '</td><td>‚Ç¨ ' + item.insurance.toLocaleString() + '</td><td style="font-size: 12px; color: #666; max-width: 200px;">' + item.kit + '</td><td><button class="btn btn-warning" onclick="editEquipment(\'' + item.category + '\', \'' + item.name + '\')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è</button></td>';
        tbody.appendChild(row);
    });
}

function updateCategoryFilter() {
    const filter = document.getElementById('categoryFilter');
    filter.innerHTML = '<option value="">Tutte le categorie</option>';
    Object.keys(equipmentDatabase).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filter.appendChild(option);
    });
}

function updateDbStats() {
    const totalCategories = Object.keys(equipmentDatabase).length;
    let totalItems = 0;
    Object.values(equipmentDatabase).forEach(category => {
        totalItems += Object.keys(category).length;
    });
    document.getElementById('dbStats').textContent = totalCategories + ' categorie, ' + totalItems + ' attrezzature';
}
    function renderSavedQuotes() {
    const container = document.getElementById('savedQuotes');
    container.innerHTML = '';
    if (savedQuotes.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;"><h3>Nessun preventivo salvato</h3><p>Crea il tuo primo preventivo nella sezione "Nuovo Preventivo"</p></div>';
        return;
    }
    savedQuotes.forEach(quote => {
        const div = document.createElement('div');
        div.className = 'quote-card';
        div.innerHTML = '<div class="quote-title">' + quote.name + '</div>' +
                       '<div class="quote-meta">' +
                       '<strong>Cliente:</strong> ' + quote.cliente + 
                       (quote.clientePiva ? '<br><strong>P.IVA:</strong> ' + quote.clientePiva : '') + 
                       '<br><strong>Durata:</strong> ' + quote.durata + ' giorni' +
                       '<br><strong>Totale:</strong> ‚Ç¨ ' + quote.total.toFixed(2) + 
                       '<br><strong>Creato:</strong> ' + quote.createdAt + '</div>' +
                       '<div style="margin-top: 15px;">' +
                       '<span class="status-badge status-' + quote.status + '">' + 
                       (quote.status === 'draft' ? 'Bozza' : quote.status === 'sent' ? 'Inviato' : 'Confermato') + 
                       '</span>' +
                       '<div style="margin-top: 10px;">' +
                       '<button class="btn btn-primary" onclick="loadQuoteById(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üìÇ</button> ' +
                       '<button class="btn btn-info" onclick="generateQuotePDF(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üìÑ</button> ' +
                       '<button class="btn btn-warning" onclick="generateDDTFromQuote(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üöõ</button> ' +
                       '<button class="btn btn-warning" onclick="duplicateQuoteById(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üìÑ</button> ' +
                       '<button class="btn btn-danger" onclick="deleteQuote(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è</button>' +
                       '</div></div>';
        container.appendChild(div);
    });
}

// TAB MANAGEMENT
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    if (tabName === 'analytics') {
        updateAnalytics();
    }
}

// NUOVA FUNZIONE - TEST CONNESSIONE
async function testConnection() {
    if (!CONFIG.API_KEY || !CONFIG.SHEETS_ID) {
        showNotification('‚öôÔ∏è Configurazione mancante per il test', 'warning');
        return false;
    }
    
    console.log('üß™ Test connessione Google Sheets...');
    updateConnectionStatus('syncing', 'Test connessione...');
    
    try {
        // Test semplice: prova a leggere una cella qualsiasi
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: 'A1:A1' // Solo una cella per test veloce
        });
        
        if (response && response.result) {
            console.log('‚úÖ Test connessione riuscito');
            updateConnectionStatus('online', 'Connesso e testato');
            showNotification('‚úÖ Connessione Google Sheets verificata!', 'success');
            return true;
        } else {
            throw new Error('Risposta vuota dal test');
        }
        
    } catch (error) {
        console.error('‚ùå Test connessione fallito:', error);
        updateConnectionStatus('offline', 'Test fallito');
        
        // Messaggi di errore specifici
        if (error.message.includes('API_KEY_INVALID')) {
            showNotification('‚ùå API Key non valida', 'error');
        } else if (error.message.includes('PERMISSION_DENIED')) {
            showNotification('‚ùå Accesso negato - verificare condivisione Sheet', 'error');
        } else if (error.message.includes('NOT_FOUND')) {
            showNotification('‚ùå Google Sheet non trovato', 'error');
        } else {
            showNotification('‚ùå Test connessione fallito: ' + error.message, 'error');
        }
        
        return false;
    }
}
// QUOTE MANAGEMENT
function addEquipmentRow() {
    if (Object.keys(equipmentDatabase).length === 0) {
        showNotification('‚ö†Ô∏è Carica prima il database delle attrezzature', 'warning');
        return;
    }
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.className = 'equipment-row';
    row.id = 'row-' + rowCounter;
    row.draggable = true;
    row.style.background = '#f8f9ff';
    
    row.innerHTML = `
        <td style="width: 40px;">
            <span class="drag-handle">‚ò∞</span>
            <div class="move-buttons">
                <button class="move-btn" onclick="moveRow(${rowCounter}, -1)">‚Üë</button>
                <button class="move-btn" onclick="moveRow(${rowCounter}, 1)">‚Üì</button>
            </div>
        </td>
        <td>
            <div class="select-search-wrapper">
                <input type="text" class="form-input" 
                    placeholder="Cerca categoria..." 
                    id="search-cat-${rowCounter}"
                    onclick="toggleSearchDropdown(${rowCounter}, 'category')"
                    onkeyup="filterSearchDropdown(${rowCounter}, 'category')"
                    autocomplete="off">
                <div class="select-search" id="dropdown-cat-${rowCounter}">
                    <input type="text" class="select-search-input" 
                        placeholder="Digita per cercare..." 
                        onkeyup="filterSearchDropdown(${rowCounter}, 'category')">
                    <div id="options-cat-${rowCounter}">
                        ${Object.keys(equipmentDatabase).map(cat => 
                            `<div class="select-search-item" onclick="selectCategory(${rowCounter}, '${cat}')">${cat}</div>`
                        ).join('')}
                    </div>
                </div>
            </div>
            <input type="hidden" id="category-${rowCounter}">
        </td>
        <td>
            <div class="select-search-wrapper">
                <input type="text" class="form-input" 
                    placeholder="Cerca attrezzatura..." 
                    id="search-eq-${rowCounter}"
                    onclick="toggleSearchDropdown(${rowCounter}, 'equipment')"
                    onkeyup="filterSearchDropdown(${rowCounter}, 'equipment')"
                    autocomplete="off"
                    disabled>
                <div class="select-search" id="dropdown-eq-${rowCounter}">
                    <input type="text" class="select-search-input" 
                        placeholder="Digita per cercare..." 
                        onkeyup="filterSearchDropdown(${rowCounter}, 'equipment')">
                    <div id="options-eq-${rowCounter}"></div>
                </div>
            </div>
            <input type="hidden" id="equipment-${rowCounter}">
            <input type="text" class="editable-input" 
                id="kit-${rowCounter}" 
                placeholder="Kit/Note personalizzate..." 
                style="margin-top: 5px; font-size: 12px; color: #666;">
        </td>
        <td>
            <input type="number" class="form-input" value="1" min="1" 
                onchange="updateRowTotal(${rowCounter})" id="qty-${rowCounter}" 
                style="width: 100%; text-align: center;">
        </td>
        <td>
            <input type="text" class="editable-input" 
                id="price-${rowCounter}" 
                value="‚Ç¨ 0.00" 
                onchange="updateCustomPrice(${rowCounter})"
                style="text-align: right; font-weight: bold; color: #2e7d32;">
        </td>
        <td style="text-align: right; font-weight: bold; color: #2e7d32;" id="total-${rowCounter}">‚Ç¨ 0.00</td>
        <td>
            <button class="btn btn-danger" onclick="removeRow(${rowCounter})" 
                style="padding: 6px 12px; font-size: 12px;">‚úï</button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    // Setup drag & drop
    setupDragAndDrop(row);
    
    // Close dropdowns on click outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.select-search-wrapper')) {
            document.querySelectorAll('.select-search').forEach(d => d.classList.remove('active'));
        }
    });
}

    // DRAG & DROP FUNCTIONS
function setupDragAndDrop(row) {
    row.addEventListener('dragstart', function(e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('dragging');
        window.draggedRow = this;
    });
    
    row.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(r => r.classList.remove('drag-over'));
    });
    
    row.addEventListener('dragover', function(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
        return false;
    });
    
    row.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
    });
    
    row.addEventListener('drop', function(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (window.draggedRow !== this) {
            this.parentNode.insertBefore(window.draggedRow, this.nextSibling);
        }
        return false;
    });
}

// MOVE ROW FUNCTIONS
function moveRow(rowId, direction) {
    const row = document.getElementById('row-' + rowId);
    if (!row) return;
    
    if (direction === -1 && row.previousElementSibling) {
        row.parentNode.insertBefore(row, row.previousElementSibling);
    } else if (direction === 1 && row.nextElementSibling) {
        row.parentNode.insertBefore(row.nextElementSibling, row);
    }
}

// SEARCH DROPDOWN FUNCTIONS
function toggleSearchDropdown(rowId, type) {
    const dropdown = document.getElementById(`dropdown-${type === 'category' ? 'cat' : 'eq'}-${rowId}`);
    const wasActive = dropdown.classList.contains('active');
    
    // Close all dropdowns
    document.querySelectorAll('.select-search').forEach(d => d.classList.remove('active'));
    
    // Toggle this dropdown
    if (!wasActive) {
        dropdown.classList.add('active');
        dropdown.querySelector('.select-search-input').focus();
    }
}

function filterSearchDropdown(rowId, type) {
    const searchInput = event.target;
    const searchTerm = searchInput.value.toLowerCase();
    const optionsContainer = document.getElementById(`options-${type === 'category' ? 'cat' : 'eq'}-${rowId}`);
    
    if (type === 'category') {
        const filtered = Object.keys(equipmentDatabase).filter(cat => 
            cat.toLowerCase().includes(searchTerm)
        );
        
        optionsContainer.innerHTML = filtered.map(cat => 
            `<div class="select-search-item" onclick="selectCategory(${rowId}, '${cat}')">${cat}</div>`
        ).join('');
    } else {
        const category = document.getElementById('category-' + rowId).value;
        if (!category) return;
        
        const items = Object.keys(equipmentDatabase[category]);
        const filtered = items.filter(item => 
            item.toLowerCase().includes(searchTerm) || 
            category.toLowerCase().includes(searchTerm)
        );
        
        optionsContainer.innerHTML = filtered.map(item => 
            `<div class="select-search-item" onclick="selectEquipment(${rowId}, '${item}')">
                ${item} <span class="category-label">${category}</span>
            </div>`
        ).join('');
    }
}

function selectCategory(rowId, category) {
    document.getElementById('category-' + rowId).value = category;
    document.getElementById('search-cat-' + rowId).value = category;
    document.getElementById('dropdown-cat-' + rowId).classList.remove('active');
    
    // Enable equipment search
    document.getElementById('search-eq-' + rowId).disabled = false;
    document.getElementById('search-eq-' + rowId).placeholder = 'Cerca in ' + category + '...';
    
    // Populate equipment options
    const items = Object.keys(equipmentDatabase[category]);
    const optionsContainer = document.getElementById('options-eq-' + rowId);
    optionsContainer.innerHTML = items.map(item => 
        `<div class="select-search-item" onclick="selectEquipment(${rowId}, '${item}')">
            ${item} <span class="category-label">${category}</span>
        </div>`
    ).join('');
    
    // Reset equipment selection
    document.getElementById('equipment-' + rowId).value = '';
    document.getElementById('search-eq-' + rowId).value = '';
    document.getElementById('price-' + rowId).value = '‚Ç¨ 0.00';
    document.getElementById('total-' + rowId).textContent = '‚Ç¨ 0.00';
    updateTotals();
}

function selectEquipment(rowId, equipment) {
    const category = document.getElementById('category-' + rowId).value;
    document.getElementById('equipment-' + rowId).value = equipment;
    document.getElementById('search-eq-' + rowId).value = equipment;
    document.getElementById('dropdown-eq-' + rowId).classList.remove('active');
    
    if (category && equipment && equipmentDatabase[category][equipment]) {
        const data = equipmentDatabase[category][equipment];
        const duration = parseInt(document.getElementById('durata').value);
        const price = calculatePrice(data.price1, data.price3, data.price7, duration);
        document.getElementById('price-' + rowId).value = '‚Ç¨ ' + price.toFixed(2);
        
        // Set default kit info but keep it editable
        if (data.kit && !document.getElementById('kit-' + rowId).value) {
            document.getElementById('kit-' + rowId).value = data.kit;
        }
        
        updateRowTotal(rowId);
    }
}

function updateCustomPrice(rowId) {
    const priceInput = document.getElementById('price-' + rowId);
    let value = priceInput.value.replace('‚Ç¨', '').replace(',', '.').trim();
    const price = parseFloat(value) || 0;
    priceInput.value = '‚Ç¨ ' + price.toFixed(2);
    updateRowTotal(rowId);
}
function updateEquipmentOptions(rowId) {
    const categorySelect = document.getElementById('category-' + rowId);
    const equipmentSelect = document.getElementById('equipment-' + rowId);
    const category = categorySelect.value;
    equipmentSelect.innerHTML = '<option value="">Seleziona attrezzatura...</option>';
    if (category && equipmentDatabase[category]) {
        equipmentSelect.disabled = false;
        Object.keys(equipmentDatabase[category]).forEach(equipment => {
            const option = document.createElement('option');
            option.value = equipment;
            option.textContent = equipment;
            equipmentSelect.appendChild(option);
        });
    } else {
        equipmentSelect.disabled = true;
    }
    document.getElementById('kit-' + rowId).textContent = '';
    document.getElementById('price-' + rowId).textContent = '‚Ç¨ 0.00';
    document.getElementById('total-' + rowId).textContent = '‚Ç¨ 0.00';
    updateTotals();
}

function updateRowData(rowId) {
    const categorySelect = document.getElementById('category-' + rowId);
    const equipmentSelect = document.getElementById('equipment-' + rowId);
    const category = categorySelect.value;
    const equipment = equipmentSelect.value;
    if (category && equipment && equipmentDatabase[category][equipment]) {
        const data = equipmentDatabase[category][equipment];
        const duration = parseInt(document.getElementById('durata').value);
        const price = calculatePrice(data.price1, data.price3, data.price7, duration);
        document.getElementById('price-' + rowId).textContent = '‚Ç¨ ' + price.toFixed(2);
        document.getElementById('kit-' + rowId).textContent = data.kit;
        updateRowTotal(rowId);
    }
}

function calculatePrice(price1, price3, price7, duration) {
    if (duration === 1) return price1;
    if (duration === 2) return price1 * 2;
    if (duration === 3) return price3;
    if (duration === 4) return price3 + price1;
    if (duration === 5) return price7;
    if (duration === 6) return price7 + price1;
    if (duration === 7) return price7 + (price1 * 2);
    if (duration === 8) return price7 + price3;
    if (duration === 9) return price7 + price3 + price1;
    if (duration >= 10) return price7 * 2;
    return price1;
}

function updateRowTotal(rowId) {
    const row = document.getElementById('row-' + rowId);
    let price = 0;
    let quantity = parseInt(document.getElementById('qty-' + rowId).value) || 0;
    
    if (row.classList.contains('service-row')) {
        price = parseFloat(document.getElementById('service-price-' + rowId).value) || 0;
    } else {
        const priceText = document.getElementById('price-' + rowId).value;
        price = parseFloat(priceText.replace('‚Ç¨ ', '')) || 0;
    }
    
    const total = price * quantity;
    document.getElementById('total-' + rowId).textContent = '‚Ç¨ ' + total.toFixed(2);
    updateTotals();
}

function updateAllPrices() {
    const rows = document.querySelectorAll('[id^="row-"]');
    rows.forEach(row => {
        const rowId = row.id.split('-')[1];
        if (!row.classList.contains('service-row')) {
            // Ricalcola il prezzo basato sulla durata
            const category = document.getElementById('category-' + rowId)?.value;
            const equipment = document.getElementById('equipment-' + rowId)?.value;
            
            if (category && equipment && equipmentDatabase[category] && equipmentDatabase[category][equipment]) {
                const data = equipmentDatabase[category][equipment];
                const duration = parseInt(document.getElementById('durata').value);
                const price = calculatePrice(data.price1, data.price3, data.price7, duration);
                document.getElementById('price-' + rowId).value = '‚Ç¨ ' + price.toFixed(2);
                updateRowTotal(rowId);
            }
        }
    });
}

function updateTotals() {
    const totalCells = document.querySelectorAll('[id^="total-"]');
    let subtotal = 0;
    totalCells.forEach(cell => {
        const value = parseFloat(cell.textContent.replace('‚Ç¨ ', '')) || 0;
        subtotal += value;
    });
    const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const imponibile = subtotal - discountAmount;
    const iva = imponibile * 0.22;
    const totale = imponibile + iva;
    document.getElementById('subtotale').textContent = '‚Ç¨ ' + subtotal.toFixed(2);
    document.getElementById('discount-percent').textContent = discountPercent.toFixed(1);
    document.getElementById('sconto-amount').textContent = '‚Ç¨ ' + discountAmount.toFixed(2);
    document.getElementById('imponibile').textContent = '‚Ç¨ ' + imponibile.toFixed(2);
    document.getElementById('iva').textContent = '‚Ç¨ ' + iva.toFixed(2);
    document.getElementById('totale').textContent = '‚Ç¨ ' + totale.toFixed(2);
}

function removeRow(rowId) {
    const row = document.getElementById('row-' + rowId);
    if (row) {
        row.remove();
        updateTotals();
    }
}

function saveQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('‚ùå Inserisci un nome per il preventivo!', 'error');
        return;
    }
    const quote = {
        id: Date.now(),
        name: quoteName,
        cliente: document.getElementById('cliente').value,
        clientePiva: document.getElementById('clientePiva').value,
        clienteVia: document.getElementById('clienteVia').value,
        codiceUnivoco: document.getElementById('codiceUnivoco').value,
        contatti: document.getElementById('contatti').value,
        carico: document.getElementById('carico').value,
        scarico: document.getElementById('scarico').value,
        durata: document.getElementById('durata').value,
        sconto: document.getElementById('sconto').value,
        equipment: [],
        createdAt: new Date().toLocaleString('it-IT'),
        status: 'draft',
        total: parseFloat(document.getElementById('totale').textContent.replace('‚Ç¨ ', '')) || 0
    };
    
    document.querySelectorAll('[id^="row-"]').forEach(row => {
        const rowId = row.id.split('-')[1];
        const quantity = document.getElementById('qty-' + rowId) ? document.getElementById('qty-' + rowId).value : '';
        
        if (row.classList.contains('service-row')) {
            const serviceName = document.getElementById('service-name-' + rowId) ? document.getElementById('service-name-' + rowId).value : '';
            const serviceNotes = document.getElementById('service-notes-' + rowId) ? document.getElementById('service-notes-' + rowId).value : '';
            const servicePrice = document.getElementById('service-price-' + rowId) ? document.getElementById('service-price-' + rowId).value : '';
            
            if (serviceName) {
                quote.equipment.push({
                    category: 'SERVIZIO',
                    equipment: serviceName,
                    quantity: parseInt(quantity),
                    notes: serviceNotes,
                    price: parseFloat(servicePrice),
                    isService: true
                });
            }
        } else {
            const category = document.getElementById('category-' + rowId) ? document.getElementById('category-' + rowId).value : '';
            const equipment = document.getElementById('equipment-' + rowId) ? document.getElementById('equipment-' + rowId).value : '';
            
            if (category && equipment) {
                quote.equipment.push({
                    category, equipment, quantity: parseInt(quantity), isService: false
                });
            }
        }
    });
    
    savedQuotes.push(quote);
    saveQuoteToSheets(quote);
    renderSavedQuotes();
    updateAnalytics();
    showNotification('‚úÖ Preventivo "' + quoteName + '" salvato!', 'success');
}

function loadQuoteById(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) {
        showNotification('‚ùå Preventivo non trovato!', 'error');
        return;
    }
    
    // Clear existing rows
    document.getElementById('equipmentRows').innerHTML = '';
    rowCounter = 0;
    
    // Load basic data
    document.getElementById('quoteName').value = quote.name || '';
    document.getElementById('cliente').value = quote.cliente || '';
    document.getElementById('clientePiva').value = quote.clientePiva || '';
    document.getElementById('clienteVia').value = quote.clienteVia || '';
    document.getElementById('codiceUnivoco').value = quote.codiceUnivoco || '';
    document.getElementById('contatti').value = quote.contatti || '';
    document.getElementById('carico').value = quote.carico || '';
    document.getElementById('scarico').value = quote.scarico || '';
    document.getElementById('durata').value = quote.durata || '1';
    document.getElementById('sconto').value = quote.sconto || '0';
    
    // Load equipment and services
    if (quote.equipment && quote.equipment.length > 0) {
        quote.equipment.forEach((item, index) => {
            if (item.isService) {
                addServiceRow();
                setTimeout(() => {
                    if (document.getElementById('service-name-' + rowCounter)) {
                        document.getElementById('service-name-' + rowCounter).value = item.equipment || '';
                        document.getElementById('service-notes-' + rowCounter).value = item.notes || '';
                        document.getElementById('service-price-' + rowCounter).value = item.price || '';
                        document.getElementById('qty-' + rowCounter).value = item.quantity || 1;
                        updateRowTotal(rowCounter);
                    }
                }, 50 * (index + 1));
            } else {
                addEquipmentRow();
                setTimeout(() => {
                    if (document.getElementById('category-' + rowCounter)) {
                        document.getElementById('category-' + rowCounter).value = item.category || '';
                        updateEquipmentOptions(rowCounter);
                        setTimeout(() => {
                            if (document.getElementById('equipment-' + rowCounter)) {
                                document.getElementById('equipment-' + rowCounter).value = item.equipment || '';
                                updateRowData(rowCounter);
                                document.getElementById('qty-' + rowCounter).value = item.quantity || 1;
                                updateRowTotal(rowCounter);
                            }
                        }, 100);
                    }
                }, 100 * (index + 1));
            }
        });
    }
    
    // Switch to quotes tab
    showTab('quotes');
    document.querySelector('[onclick="showTab(\'quotes\')"]').classList.add('active');
    showNotification('‚úÖ Preventivo "' + quote.name + '" caricato!', 'success');
}
    function generateDDTFromQuote(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) {
        showNotification('‚ùå Preventivo non trovato!', 'error');
        return;
    }
    
    // Carica temporaneamente i dati del preventivo
    const originalName = document.getElementById('quoteName').value;
    const originalCliente = document.getElementById('cliente').value;
    const originalPiva = document.getElementById('clientePiva').value;
    const originalContatti = document.getElementById('contatti').value;
    const originalCarico = document.getElementById('carico').value;
    const originalScarico = document.getElementById('scarico').value;
    
    document.getElementById('quoteName').value = quote.name || '';
    document.getElementById('cliente').value = quote.cliente || '';
    document.getElementById('clientePiva').value = quote.clientePiva || '';
    document.getElementById('contatti').value = quote.contatti || '';
    document.getElementById('carico').value = quote.carico || '';
    document.getElementById('scarico').value = quote.scarico || '';
    
    // Genera il DDT
    setTimeout(() => {
        generateDDT();
        
        // Ripristina i valori originali
        document.getElementById('quoteName').value = originalName;
        document.getElementById('cliente').value = originalCliente;
        document.getElementById('clientePiva').value = originalPiva;
        document.getElementById('contatti').value = originalContatti;
        document.getElementById('carico').value = originalCarico;
        document.getElementById('scarico').value = originalScarico;
    }, 500);
}
function duplicateQuoteById(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    loadQuoteById(quoteId);
    document.getElementById('quoteName').value = quote.name + ' - Copia';
    showNotification('üìÑ Preventivo duplicato! Modifica il nome e salva.', 'info');
}

function deleteQuote(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    if (confirm('Sei sicuro di voler eliminare il preventivo "' + quote.name + '"?')) {
        savedQuotes = savedQuotes.filter(q => q.id !== quoteId);
        localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
        renderSavedQuotes();
        updateAnalytics();
        showNotification('üóëÔ∏è Preventivo eliminato', 'info');
    }
}

function resetQuote() {
    if (confirm('Sei sicuro di voler cancellare tutto il preventivo?')) {
        document.getElementById('equipmentRows').innerHTML = '';
        document.getElementById('cliente').value = '';
        document.getElementById('clientePiva').value = '';
        document.getElementById('contatti').value = '';
        document.getElementById('carico').value = '';
        document.getElementById('scarico').value = '';
        document.getElementById('durata').value = '1';
        document.getElementById('sconto').value = '0';
        document.getElementById('quoteName').value = '';
        updateTotals();
        showNotification('üîÑ Preventivo resettato', 'info');
    }
}

// UTILITY FUNCTIONS
function filterDatabase() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#databaseBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterByCategory() {
    const selectedCategory = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('#databaseBody tr');
    if (!selectedCategory) {
        rows.forEach(row => row.style.display = '');
        return;
    }
    let showNextItems = false;
    rows.forEach(row => {
        if (row.classList.contains('category-row')) {
            const categoryText = row.textContent.trim().replace('üìÅ ', '');
            showNextItems = (categoryText === selectedCategory);
            row.style.display = showNextItems ? '' : 'none';
        } else {
            row.style.display = showNextItems ? '' : 'none';
        }
    });
}

function syncDatabase() {
    const btn = document.getElementById('syncBtn');
    
    if (!CONFIG.API_KEY || !CONFIG.SHEETS_ID) {
        showNotification('‚öôÔ∏è Configurazione API mancante', 'warning');
        return;
    }
    
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'üîÑ Sincronizzazione...';
    }
    
    console.log('üîÑ Sync manuale database avviato...');
    showNotification('üîÑ Sincronizzazione database in corso...', 'info');
    
    loadDatabaseFromSheets()
        .then(() => {
            showNotification('‚úÖ Database sincronizzato con successo!', 'success');
        })
        .catch((error) => {
            console.error('‚ùå Errore sync database:', error);
            showNotification('‚ùå Errore nella sincronizzazione database', 'error');
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üîÑ Sync';
            }
        });
}

function syncQuotes() {
    showNotification('üîÑ Aggiornamento preventivi...', 'info');
    loadQuotesFromSheets().then(() => {
        showNotification('‚úÖ Preventivi aggiornati!', 'success');
    });
}

function updateConnectionStatus(status, message) {
    const indicator = document.getElementById('connectionStatus');
    const text = document.getElementById('connectionText');
    
    if (indicator) {
        indicator.className = 'status-indicator status-' + status;
    }
    
    if (text) {
        text.textContent = message;
    }
    
    // Logging per debugging
    console.log(`üì° Status: ${status} - ${message}`);
    
    // Aggiorna variabili globali di stato
    switch(status) {
        case 'online':
            isConnected = true;
            break;
        case 'offline':
        case 'error':
            isConnected = false;
            gapi_loaded = false;
            break;
        case 'syncing':
            // Mantieni stato precedente durante sync
            break;
    }
}

function updateSyncTime() {
    const lastSync = document.getElementById('lastSync');
    const now = new Date();
    const timeString = now.toLocaleTimeString('it-IT', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    
    if (lastSync) {
        lastSync.textContent = 'Ultimo sync: ' + timeString;
    }
    
    console.log('‚è∞ Sync time aggiornato:', timeString);
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = 'notification ' + (type || 'info');
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
// PDF GENERATION FUNCTIONS
function generateQuoteNumber() {
    const currentYear = new Date().getFullYear();
    const thisYearQuotes = savedQuotes.filter(q => {
        return q.createdAt && q.createdAt.includes(currentYear.toString());
    });
    const nextNumber = thisYearQuotes.length + 1;
    return `#${currentYear}-${nextNumber.toString().padStart(3, '0')}`;
}

function generatePDF() {
    const quoteName = document.getElementById('quoteName').value || 'Preventivo';
    const cliente = document.getElementById('cliente').value || 'Cliente';
    const clientePiva = document.getElementById('clientePiva').value || '';
    const contatti = document.getElementById('contatti').value || '';
    const carico = document.getElementById('carico').value || '';
    const scarico = document.getElementById('scarico').value || '';
    const durata = document.getElementById('durata').value || '1';
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const quoteNumber = generateQuoteNumber();
        
        // HEADER CON LOGO PI√ô GRANDE E LAYOUT MIGLIORATO
        try {
            doc.addImage('https://i.imgur.com/ABMgyI8.png', 'PNG', 15, 10, 35, 35);
        } catch (e) {
            // Fallback logo se immagine non carica
            doc.setFillColor(44, 90, 160);
            doc.circle(32.5, 27.5, 17, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('HP', 32.5, 32, { align: 'center' });
        }
        
        // INTESTAZIONE AZIENDA - ALLINEATA CON LOGO
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES S.R.L.', 55, 22);
        
        // DATI AZIENDA - ALLINEATI E SPAZIATI MEGLIO
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('P.IVA: 09542051215', 55, 29);
        doc.text('PEC: hubrispictures@pec.it | Tel: +39 081 18893796 / +39 348 6901218', 55, 34);
        doc.text('Indirizzo: Piazza Vanvitelli, 5, 80127 Napoli NA', 55, 39);
        doc.text('Email: info@hubrispictures.com', 55, 44);
        
        // NUMERO PREVENTIVO E DATA - BEN ALLINEATI A DESTRA
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('PREVENTIVO', 195, 15, { align: 'right' });
        doc.text('N. ' + quoteNumber, 195, 23, { align: 'right' });
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Data: ' + new Date().toLocaleDateString('it-IT'), 195, 30, { align: 'right' });
        
        // LINEA SEPARATRICE PRINCIPALE
        doc.setDrawColor(44, 90, 160);
        doc.setLineWidth(1.5);
        doc.line(15, 50, 195, 50);
        
        // SEZIONE DESTINATARIO - PI√ô COMPATTA
        doc.setFillColor(248, 250, 255);
        doc.rect(15, 55, 70, 28, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(15, 55, 70, 28);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('DESTINATARIO:', 18, 62);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text(cliente, 18, 68);
        if (clientePiva) {
            doc.text('P.IVA: ' + clientePiva, 18, 73);
        }
        if (contatti) {
            doc.text('Tel: ' + contatti, 18, 78);
        }
        
        // PERIODO NOLEGGIO - PI√ô COMPATTO
        doc.setFillColor(248, 250, 255);
        doc.rect(125, 55, 70, 28, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(125, 55, 70, 28);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('PERIODO NOLEGGIO:', 128, 62);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text('Carico: ' + (carico || 'Da definire'), 128, 68);
        doc.text('Scarico: ' + (scarico || 'Da definire'), 128, 73);
        doc.text('Durata: ' + durata + ' giorni', 128, 78);
        
        // TITOLO TABELLA
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('DETTAGLIO ATTREZZATURE E SERVIZI', 105, 95, { align: 'center' });
        
        // PREPARAZIONE DATI TABELLA
        const equipmentData = [];
        const servicesData = [];
        let equipmentTotal = 0;
        let servicesTotal = 0;
        
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            
            if (row.classList.contains('service-row')) {
                const serviceName = document.getElementById('service-name-' + rowId)?.value || '';
                const serviceNotes = document.getElementById('service-notes-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                const price = parseFloat(document.getElementById('service-price-' + rowId)?.value || '0');
                const total = parseFloat(document.getElementById('total-' + rowId)?.textContent.replace('‚Ç¨ ', '') || '0');
                
                if (serviceName) {
                    servicesData.push([
                        'Servizi',
                        serviceName + (serviceNotes ? '\n' + serviceNotes : ''),
                        quantity,
                        '‚Ç¨ ' + price.toFixed(2),
                        '‚Ç¨ ' + total.toFixed(2)
                    ]);
                    servicesTotal += total;
                }
            } else {
                const category = document.getElementById('category-' + rowId)?.value || '';
                const equipment = document.getElementById('equipment-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                const priceText = document.getElementById('price-' + rowId)?.value || '‚Ç¨ 0.00';
                const total = parseFloat(document.getElementById('total-' + rowId)?.textContent.replace('‚Ç¨ ', '') || '0');
                const kitInfo = document.getElementById('kit-' + rowId)?.textContent || '';
                
                if (category && equipment) {
                    equipmentData.push([
                        category,
                        equipment + (kitInfo ? '\n' + kitInfo : ''),
                        quantity,
                        priceText,
                        '‚Ç¨ ' + total.toFixed(2)
                    ]);
                    equipmentTotal += total;
                }
            }
        });
        
        // TABELLA ATTREZZATURE - FONT PI√ô GRANDE
        let currentY = 105;
        
        if (equipmentData.length > 0) {
            doc.autoTable({
                head: [['Categoria', 'Articolo', 'Qt√†', 'Prezzo Unit.', 'Totale']],
                body: equipmentData,
                startY: currentY,
                theme: 'grid',
                headStyles: { 
                    fillColor: [44, 90, 160],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 70 },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 25, halign: 'right' },
                    4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 255]
                }
            });
            
            currentY = doc.lastAutoTable.finalY + 10;
        }
        
        // TABELLA SERVIZI - FONT PI√ô GRANDE
        if (servicesData.length > 0) {
            // HEADER SERVIZI
            doc.setFillColor(255, 152, 0);
            doc.rect(15, currentY, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('SERVIZI', 105, currentY + 5, { align: 'center' });
            currentY += 8;
            
            doc.autoTable({
                head: [['Categoria', 'Servizio', 'Qt√†', 'Prezzo Unit.', 'Totale']],
                body: servicesData,
                startY: currentY,
                theme: 'grid',
                headStyles: { 
                    fillColor: [230, 126, 34],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 70 },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 25, halign: 'right' },
                    4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                },
                alternateRowStyles: {
                    fillColor: [255, 243, 224]
                }
            });
            
            currentY = doc.lastAutoTable.finalY + 15;
        }
        
        // TOTALI FINALI
        const subtotalValue = parseFloat(document.getElementById('subtotale').textContent.replace('‚Ç¨ ', '')) || 0;
        const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
        const discountAmount = parseFloat(document.getElementById('sconto-amount').textContent.replace('‚Ç¨ ', '')) || 0;
        const imponibileValue = parseFloat(document.getElementById('imponibile').textContent.replace('‚Ç¨ ', '')) || 0;
        const ivaValue = parseFloat(document.getElementById('iva').textContent.replace('‚Ç¨ ', '')) || 0;
        const totaleValue = parseFloat(document.getElementById('totale').textContent.replace('‚Ç¨ ', '')) || 0;
        
        // BOX TOTALI
        const boxY = currentY;
        const boxWidth = 80;
        const boxHeight = discountPercent > 0 ? 45 : 35;
        
        // Sfondo del box totali
        doc.setFillColor(248, 250, 255);
        doc.rect(115, boxY, boxWidth, boxHeight, 'F');
        
        // Bordo del box
        doc.setDrawColor(44, 90, 160);
        doc.setLineWidth(0.5);
        doc.rect(115, boxY, boxWidth, boxHeight);
        
        // DETTAGLIO TOTALI
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        
        let lineY = boxY + 7;
        
        // Subtotale
        doc.text('Subtotale:', 118, lineY);
        doc.text('‚Ç¨ ' + subtotalValue.toFixed(2), 190, lineY, { align: 'right' });
        lineY += 6;
        
        // Sconto (se presente)
        if (discountPercent > 0) {
            doc.text('Sconto (' + discountPercent.toFixed(1) + '%):', 118, lineY);
            doc.text('-‚Ç¨ ' + discountAmount.toFixed(2), 190, lineY, { align: 'right' });
            lineY += 6;
        }
        
        // Imponibile
        doc.text('Imponibile:', 118, lineY);
        doc.text('‚Ç¨ ' + imponibileValue.toFixed(2), 190, lineY, { align: 'right' });
        lineY += 6;
        
        // IVA
        doc.text('IVA 22%:', 118, lineY);
        doc.text('‚Ç¨ ' + ivaValue.toFixed(2), 190, lineY, { align: 'right' });
        lineY += 6;
        
        // LINEA SEPARATRICE
        doc.setLineWidth(1);
        doc.setDrawColor(44, 90, 160);
        doc.line(118, lineY, 190, lineY);
        lineY += 5;
        
        // TOTALE FINALE
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.setTextColor(44, 90, 160);
        doc.text('TOTALE FINALE:', 118, lineY);
        doc.text('‚Ç¨ ' + totaleValue.toFixed(2), 190, lineY, { align: 'right' });
        
        // NOTE FINALI AGGIORNATE
        const finalY = boxY + boxHeight + 15;
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        
        const noteText = [
            "La societ√† emette fattura al momento del ritiro materiale non si accettano dilazioni di pagamento",
            "che dovr√† essere contestuale al RITIRO delle attrezzature.",
            "Ritiro e riconsegna a Vostra cura presso nostra sede. Il materiale non reso verr√† addebitato al",
            "prezzo di listino della casa costruttrice. Eventuali danneggiamenti saranno valutati al momento",
            "della riconsegna ed addebitati per il loro valore.",
            "Il materiale eventualmente difettoso verr√† riparato o sostituito presso la nostra sede.",
            "L'eventuale smarrimento dei MATERIALI, anche al fine di scongiurare una illecita utilizzazione",
            "dei medesimi, dovr√† essere tempestivamente denunciato presso l'Autorit√† di Pubblica Sicurezza",
            "pi√π vicina e quindi comunicato per iscritto."
        ];
        
        let noteY = finalY;
        noteText.forEach(line => {
            doc.text(line, 15, noteY);
            noteY += 4;
        });
        
        // SALVATAGGIO FILE
        const fileName = quoteName.replace(/[^a-z0-9]/gi, '_') + '_' + quoteNumber + '.pdf';
        doc.save(fileName);
        
        showNotification('‚úÖ PDF preventivo generato: ' + quoteNumber, 'success');
        
    } catch (error) {
        console.error('Errore generazione PDF:', error);
        showNotification('‚ùå Errore nella generazione del PDF: ' + error.message, 'error');
    }
}

    function generateWord() {
    const quoteName = document.getElementById('quoteName').value || 'Preventivo';
    const cliente = document.getElementById('cliente').value || 'Cliente';
    const clientePiva = document.getElementById('clientePiva').value || '';
    const contatti = document.getElementById('contatti').value || '';
    const carico = document.getElementById('carico').value || '';
    const scarico = document.getElementById('scarico').value || '';
    const durata = document.getElementById('durata').value || '1';
    const quoteNumber = generateQuoteNumber();
    
    // Prepara i dati delle attrezzature
    let equipmentHTML = '';
    let servicesHTML = '';
    let equipmentTotal = 0;
    let servicesTotal = 0;
    
    document.querySelectorAll('[id^="row-"]').forEach(row => {
        const rowId = row.id.split('-')[1];
        
        if (row.classList.contains('service-row')) {
            const serviceName = document.getElementById('service-name-' + rowId)?.value || '';
            const serviceNotes = document.getElementById('service-notes-' + rowId)?.value || '';
            const quantity = document.getElementById('qty-' + rowId)?.value || '';
            const price = parseFloat(document.getElementById('service-price-' + rowId)?.value || '0');
            const total = parseFloat(document.getElementById('total-' + rowId)?.textContent.replace('‚Ç¨ ', '') || '0');
            
            if (serviceName) {
                servicesHTML += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">Servizi</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${serviceName}${serviceNotes ? '<br>' + serviceNotes : ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${quantity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚Ç¨ ${price.toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">‚Ç¨ ${total.toFixed(2)}</td>
                    </tr>
                `;
                servicesTotal += total;
            }
        } else {
            const category = document.getElementById('category-' + rowId)?.value || '';
            const equipment = document.getElementById('equipment-' + rowId)?.value || '';
            const quantity = document.getElementById('qty-' + rowId)?.value || '';
            const priceText = document.getElementById('price-' + rowId)?.textContent || '‚Ç¨ 0.00';
            const total = parseFloat(document.getElementById('total-' + rowId)?.textContent.replace('‚Ç¨ ', '') || '0');
            const kitInfo = document.getElementById('kit-' + rowId)?.textContent || '';
            
            if (category && equipment) {
                equipmentHTML += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${category}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${equipment}${kitInfo ? '<br><small>' + kitInfo + '</small>' : ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${quantity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${priceText}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">‚Ç¨ ${total.toFixed(2)}</td>
                    </tr>
                `;
                equipmentTotal += total;
            }
        }
    });
    
    // Calcola totali
    const subtotalValue = parseFloat(document.getElementById('subtotale').textContent.replace('‚Ç¨ ', '')) || 0;
    const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
    const discountAmount = parseFloat(document.getElementById('sconto-amount').textContent.replace('‚Ç¨ ', '')) || 0;
    const imponibileValue = parseFloat(document.getElementById('imponibile').textContent.replace('‚Ç¨ ', '')) || 0;
    const ivaValue = parseFloat(document.getElementById('iva').textContent.replace('‚Ç¨ ', '')) || 0;
    const totaleValue = parseFloat(document.getElementById('totale').textContent.replace('‚Ç¨ ', '')) || 0;
    
    // Genera HTML completo
    const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Preventivo ${quoteNumber} - ${cliente}</title>
    <style>
        @page { margin: 2cm; }
        body { 
            font-family: Arial, sans-serif; 
            line-height: 1.6; 
            color: #333;
            max-width: 21cm;
            margin: 0 auto;
            padding: 20px;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: start;
            margin-bottom: 30px;
            border-bottom: 3px solid #2c5aa0;
            padding-bottom: 20px;
        }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 80px; height: 80px; }
        .company-info h1 { color: #2c5aa0; margin: 0; }
        .quote-info { text-align: right; }
        .quote-info h2 { color: #2c5aa0; margin: 0; }
        .info-boxes { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .info-box {
            flex: 1;
            background: #f8f9ff;
            border: 1px solid #2c5aa0;
            padding: 15px;
            border-radius: 5px;
        }
        .info-box h3 {
            color: #2c5aa0;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: #2c5aa0;
            color: white;
            padding: 10px;
            text-align: left;
        }
        .totals {
            margin-left: auto;
            width: 300px;
            margin-top: 20px;
        }
        .totals-box {
            background: #f8f9ff;
            border: 1px solid #2c5aa0;
            padding: 15px;
            border-radius: 5px;
        }
        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .total-final {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c5aa0;
            border-top: 2px solid #2c5aa0;
            padding-top: 10px;
            margin-top: 10px;
        }
        .notes {
            margin-top: 40px;
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }
        .service-header {
            background: #ff9800;
            color: white;
            padding: 8px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <img src="https://i.imgur.com/ABMgyI8.png" alt="Logo" class="logo">
            <div class="company-info">
                <h1>HUBRIS PICTURES S.R.L.</h1>
                <p style="margin: 5px 0;">P.IVA: 09542051215</p>
                <p style="margin: 5px 0;">PEC: hubrispictures@pec.it | Tel: +39 081 18893796 / +39 348 6901218</p>
                <p style="margin: 5px 0;">Indirizzo: Piazza Vanvitelli, 5, 80127 Napoli NA</p>
                <p style="margin: 5px 0;">Email: info@hubrispictures.com</p>
            </div>
        </div>
        <div class="quote-info">
            <h2>PREVENTIVO</h2>
            <p><strong>N. ${quoteNumber}</strong></p>
            <p>Data: ${new Date().toLocaleDateString('it-IT')}</p>
        </div>
    </div>

    <div class="info-boxes">
        <div class="info-box">
            <h3>DESTINATARIO:</h3>
            <p><strong>${cliente}</strong></p>
            ${clientePiva ? '<p>P.IVA: ' + clientePiva + '</p>' : ''}
            ${contatti ? '<p>Tel: ' + contatti + '</p>' : ''}
        </div>
        <div class="info-box">
            <h3>PERIODO NOLEGGIO:</h3>
            <p>Carico: ${carico || 'Da definire'}</p>
            <p>Scarico: ${scarico || 'Da definire'}</p>
            <p>Durata: ${durata} giorni</p>
        </div>
    </div>

    <h2 style="text-align: center; color: #2c5aa0;">DETTAGLIO ATTREZZATURE E SERVIZI</h2>

    ${equipmentHTML ? `
    <table>
        <thead>
            <tr>
                <th>Categoria</th>
                <th>Articolo</th>
                <th style="text-align: center;">Qt√†</th>
                <th style="text-align: right;">Prezzo Unit.</th>
                <th style="text-align: right;">Totale</th>
            </tr>
        </thead>
        <tbody>
            ${equipmentHTML}
        </tbody>
    </table>
    ` : ''}

    ${servicesHTML ? `
    <div class="service-header">SERVIZI</div>
    <table>
        <thead>
            <tr>
                <th>Categoria</th>
                <th>Servizio</th>
                <th style="text-align: center;">Qt√†</th>
                <th style="text-align: right;">Prezzo Unit.</th>
                <th style="text-align: right;">Totale</th>
            </tr>
        </thead>
        <tbody>
            ${servicesHTML}
        </tbody>
    </table>
    ` : ''}

    <div class="totals">
        <div class="totals-box">
            <div class="total-line">
                <span>Subtotale:</span>
                <span>‚Ç¨ ${subtotalValue.toFixed(2)}</span>
            </div>
            ${discountPercent > 0 ? `
            <div class="total-line">
                <span>Sconto (${discountPercent.toFixed(1)}%):</span>
                <span>-‚Ç¨ ${discountAmount.toFixed(2)}</span>
            </div>
            ` : ''}
            <div class="total-line">
                <span>Imponibile:</span>
                <span>‚Ç¨ ${imponibileValue.toFixed(2)}</span>
            </div>
            <div class="total-line">
                <span>IVA 22%:</span>
                <span>‚Ç¨ ${ivaValue.toFixed(2)}</span>
            </div>
            <div class="total-line total-final">
                <span>TOTALE FINALE:</span>
                <span>‚Ç¨ ${totaleValue.toFixed(2)}</span>
            </div>
        </div>
    </div>

    <div class="notes">
        <p>La societ√† emette fattura al momento del ritiro materiale non si accettano dilazioni di pagamento che dovr√† essere contestuale al RITIRO delle attrezzature.</p>
        <p>Ritiro e riconsegna a Vostra cura presso nostra sede. Il materiale non reso verr√† addebitato al prezzo di listino della casa costruttrice. Eventuali danneggiamenti saranno valutati al momento della riconsegna ed addebitati per il loro valore.</p>
        <p>Il materiale eventualmente difettoso verr√† riparato o sostituito presso la nostra sede.</p>
        <p>L'eventuale smarrimento dei MATERIALI, anche al fine di scongiurare una illecita utilizzazione dei medesimi, dovr√† essere tempestivamente denunciato presso l'Autorit√† di Pubblica Sicurezza pi√π vicina e quindi comunicato per iscritto.</p>
    </div>
</body>
</html>
    `;
    
    // Crea e scarica il file
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = quoteName.replace(/[^a-z0-9]/gi, '_') + '_' + quoteNumber + '.html';
    link.click();
    
    showNotification('‚úÖ Documento Word generato! Aprilo con Microsoft Word.', 'success');
}
    
function generateNoPricesQuote() {
    const quoteName = document.getElementById('quoteName').value || 'Preventivo';
    const cliente = document.getElementById('cliente').value || 'Cliente';
    const clientePiva = document.getElementById('clientePiva').value || '';
    const contatti = document.getElementById('contatti').value || '';
    const carico = document.getElementById('carico').value || '';
    const scarico = document.getElementById('scarico').value || '';
    const durata = document.getElementById('durata').value || '1';
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const quoteNumber = generateQuoteNumber();
        
        // SETUP FONT
        doc.setFont('helvetica'); // Nota: jsPDF non supporta Trebuchet MS nativamente
        
        // HEADER CON LOGO PI√ô GRANDE E LAYOUT MIGLIORATO
        try {
            doc.addImage('https://i.imgur.com/ABMgyI8.png', 'PNG', 15, 10, 35, 35);
        } catch (e) {
            doc.setFillColor(44, 90, 160);
            doc.circle(32.5, 27.5, 17, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('HP', 32.5, 32, { align: 'center' });
        }
        
        // INTESTAZIONE AZIENDA - ALLINEATA CON LOGO
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES S.R.L.', 55, 22);
        
        // DATI AZIENDA - ALLINEATI E SPAZIATI MEGLIO
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('P.IVA: 09542051215', 55, 29);
        doc.text('PEC: hubrispictures@pec.it | Tel: +39 081 18893796 / +39 348 6901218', 55, 34);
        doc.text('Indirizzo: Piazza Vanvitelli, 5, 80127 Napoli NA', 55, 39);
        doc.text('Email: info@hubrispictures.com', 55, 44);
        
        // TITOLO - SOLO "PREVENTIVO"
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('PREVENTIVO', 195, 15, { align: 'right' });
        doc.text('N. ' + quoteNumber, 195, 23, { align: 'right' });
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Data: ' + new Date().toLocaleDateString('it-IT'), 195, 30, { align: 'right' });
        
        // LINEA SEPARATRICE
        doc.setDrawColor(44, 90, 160);
        doc.setLineWidth(1.5);
        doc.line(15, 50, 195, 50);
        
        // SEZIONE DESTINATARIO - PI√ô COMPATTA
        doc.setFillColor(248, 250, 255);
        doc.rect(15, 55, 70, 28, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(15, 55, 70, 28);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('DESTINATARIO:', 18, 62);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text(cliente, 18, 68);
        if (clientePiva) {
            doc.text('P.IVA: ' + clientePiva, 18, 73);
        }
        if (contatti) {
            doc.text('Tel: ' + contatti, 18, 78);
        }
        
        // PERIODO NOLEGGIO - PI√ô COMPATTO
        doc.setFillColor(248, 250, 255);
        doc.rect(125, 55, 70, 28, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(125, 55, 70, 28);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('PERIODO NOLEGGIO:', 128, 62);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text('Carico: ' + (carico || 'Da definire'), 128, 68);
        doc.text('Scarico: ' + (scarico || 'Da definire'), 128, 73);
        doc.text('Durata: ' + durata + ' giorni', 128, 78);
        
        // TITOLO TABELLA
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('LISTA ATTREZZATURE E SERVIZI', 105, 95, { align: 'center' });
        
        // PREPARAZIONE DATI SENZA PREZZI
        const equipmentData = [];
        const servicesData = [];
        
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            
            if (row.classList.contains('service-row')) {
                const serviceName = document.getElementById('service-name-' + rowId)?.value || '';
                const serviceNotes = document.getElementById('service-notes-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                
                if (serviceName) {
                    servicesData.push([
                        'Servizi',
                        serviceName,
                        quantity,
                        serviceNotes || 'Servizio personalizzato'
                    ]);
                }
            } else {
                const category = document.getElementById('category-' + rowId)?.value || '';
                const equipment = document.getElementById('equipment-' + rowId)?.value || '';
                const quantity = document.getElementById('qty-' + rowId)?.value || '';
                const kitInfo = document.getElementById('kit-' + rowId)?.textContent || '';
                
                if (category && equipment) {
                    equipmentData.push([
                        category,
                        equipment,
                        quantity,
                        kitInfo || 'Kit completo'
                    ]);
                }
            }
        });
        
        // TABELLA ATTREZZATURE SENZA PREZZI
        let currentY = 105;
        
        if (equipmentData.length > 0) {
            doc.autoTable({
                head: [['Categoria', 'Articolo', 'Qt√†', 'Kit']],
                body: equipmentData,
                startY: currentY,
                theme: 'grid',
                headStyles: { 
                    fillColor: [44, 90, 160],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 80 },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 40 }
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 255]
                }
            });
            
            currentY = doc.lastAutoTable.finalY + 10;
        }
        
        // TABELLA SERVIZI SENZA PREZZI
        if (servicesData.length > 0) {
            // HEADER SERVIZI
            doc.setFillColor(255, 152, 0);
            doc.rect(15, currentY, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('SERVIZI', 105, currentY + 5, { align: 'center' });
            currentY += 8;
            
            doc.autoTable({
                head: [['Categoria', 'Servizio', 'Qt√†', 'Note']],
                body: servicesData,
                startY: currentY,
                theme: 'grid',
                headStyles: { 
                    fillColor: [230, 126, 34],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 80 },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 40 }
                },
                alternateRowStyles: {
                    fillColor: [255, 243, 224]
                }
            });
            
            currentY = doc.lastAutoTable.finalY + 15;
        }
        
        // TOTALI FINALI (per trasparenza)
        const totaleValue = parseFloat(document.getElementById('totale').textContent.replace('‚Ç¨ ', '')) || 0;
        const imponibileValue = parseFloat(document.getElementById('imponibile').textContent.replace('‚Ç¨ ', '')) || 0;
        const ivaValue = parseFloat(document.getElementById('iva').textContent.replace('‚Ç¨ ', '')) || 0;
        
        // BOX TOTALI SEMPLIFICATO
        doc.setFillColor(248, 250, 255);
        doc.rect(130, currentY, 65, 30, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(130, currentY, 65, 30);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        
        doc.text('Totale imponibile:', 133, currentY + 10);
        doc.text('‚Ç¨ ' + imponibileValue.toFixed(2), 190, currentY + 10, { align: 'right' });
        
        doc.text('IVA 22%:', 133, currentY + 17);
        doc.text('‚Ç¨ ' + ivaValue.toFixed(2), 190, currentY + 17, { align: 'right' });
        
        // LINEA E TOTALE FINALE
        doc.setLineWidth(1);
        doc.line(133, currentY + 20, 190, currentY + 20);
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.setTextColor(44, 90, 160);
        doc.text('TOTALE FINALE:', 133, currentY + 27);
        doc.text('‚Ç¨ ' + totaleValue.toFixed(2), 190, currentY + 27, { align: 'right' });
        
        // NOTE FINALI AGGIORNATE
        const finalY = currentY + 40;
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        
        const noteText = [
            "La societ√† emette fattura al momento del ritiro materiale non si accettano dilazioni di pagamento",
            "che dovr√† essere contestuale al RITIRO delle attrezzature.",
            "Ritiro e riconsegna a Vostra cura presso nostra sede. Il materiale non reso verr√† addebitato al",
            "prezzo di listino della casa costruttrice. Eventuali danneggiamenti saranno valutati al momento",
            "della riconsegna ed addebitati per il loro valore.",
            "Il materiale eventualmente difettoso verr√† riparato o sostituito presso la nostra sede.",
            "L'eventuale smarrimento dei MATERIALI, anche al fine di scongiurare una illecita utilizzazione",
            "dei medesimi, dovr√† essere tempestivamente denunciato presso l'Autorit√† di Pubblica Sicurezza",
            "pi√π vicina e quindi comunicato per iscritto."
        ];
        
        let noteY = finalY;
        noteText.forEach(line => {
            doc.text(line, 15, noteY);
            noteY += 4;
        });
        
        // SALVATAGGIO
        const fileName = quoteName.replace(/[^a-z0-9]/gi, '_') + '_SenzaPrezzi_' + quoteNumber + '.pdf';
        doc.save(fileName);
        
        showNotification('‚úÖ Preventivo senza prezzi generato: ' + quoteNumber, 'success');
        
    } catch (error) {
        console.error('Errore generazione PDF senza prezzi:', error);
        showNotification('‚ùå Errore nella generazione del PDF', 'error');
    }
}

function generateInsurance() {
    const quoteName = document.getElementById('quoteName').value || 'Preventivo';
    const cliente = document.getElementById('cliente').value || 'Cliente';
    const clientePiva = document.getElementById('clientePiva').value || '';
    const contatti = document.getElementById('contatti').value || '';
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const docNumber = 'ASS-' + Date.now().toString().slice(-6);
        
        // HEADER CON LOGO
        try {
            doc.addImage('https://i.imgur.com/ABMgyI8.png', 'PNG', 15, 15, 25, 25);
        } catch (e) {
            doc.setFillColor(44, 90, 160);
            doc.circle(27.5, 27.5, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('HP', 27.5, 31, { align: 'center' });
        }
        
        // INTESTAZIONE AZIENDA
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES S.R.L.', 50, 25);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('P.IVA: 09542051215', 50, 32);
        doc.text('PEC: hubrispictures@pec.it | Tel: +39 081 18893796 / +39 348 6901218', 50, 37);
        doc.text('Indirizzo: Piazza Vanvitelli, 5, 80127 Napoli NA', 50, 42);
        doc.text('Email: info@hubrispictures.com', 50, 47);
        
        // TITOLO DOCUMENTO
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('VALORI ASSICURATIVI', 150, 20);
        doc.text('N. ' + docNumber, 150, 27);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Data: ' + new Date().toLocaleDateString('it-IT'), 150, 34);
        
        // LINEA SEPARATRICE
        doc.setDrawColor(44, 90, 160);
        doc.setLineWidth(1);
        doc.line(15, 55, 195, 55);
        
        // SEZIONE DESTINATARIO
        doc.setFillColor(248, 250, 255);
        doc.rect(15, 65, 85, 30, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(15, 65, 85, 30);
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('DESTINATARIO:', 18, 73);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(cliente, 18, 80);
        if (clientePiva) {
            doc.text('P.IVA: ' + clientePiva, 18, 86);
        }
        if (contatti) {
            doc.text('Tel: ' + contatti, 18, 92);
        }
        
        // PROGETTO
        doc.setFillColor(248, 250, 255);
        doc.rect(110, 65, 85, 30, 'F');
        doc.setDrawColor(44, 90, 160);
        doc.rect(110, 65, 85, 30);
        
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('PROGETTO:', 113, 73);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(quoteName, 113, 80);
        doc.text('Tipo: Noleggio', 113, 86);
        doc.text('Valutazione assicurativa', 113, 92);
        
        // TITOLO TABELLA
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('ATTREZZATURE DA ASSICURARE', 105, 110, { align: 'center' });
        
        // PREPARAZIONE DATI ASSICURAZIONE
        const insuranceData = [];
        let totalInsurance = 0;
        
        document.querySelectorAll('[id^="row-"]').forEach(row => {
            const rowId = row.id.split('-')[1];
            
            // Solo attrezzature (non servizi) hanno valori assicurativi
            if (!row.classList.contains('service-row')) {
                const category = document.getElementById('category-' + rowId)?.value || '';
                const equipment = document.getElementById('equipment-' + rowId)?.value || '';
                const quantity = parseInt(document.getElementById('qty-' + rowId)?.value || '1') || 1;
                
                if (category && equipment && equipmentDatabase[category] && equipmentDatabase[category][equipment]) {
                    const insurance = equipmentDatabase[category][equipment].insurance;
                    
                    if (insurance > 0) {
                        const totalValue = insurance * quantity;
                        totalInsurance += totalValue;
                        
                        insuranceData.push([
                            category,
                            equipment,
                            quantity.toString(),
                            '‚Ç¨ ' + insurance.toLocaleString('it-IT'),
                            '‚Ç¨ ' + totalValue.toLocaleString('it-IT')
                        ]);
                    }
                }
            }
        });
        
        // TABELLA VALORI ASSICURATIVI
        if (insuranceData.length > 0) {
            doc.autoTable({
                head: [['Categoria', 'Attrezzatura', 'Qt√†', 'Valore Unit.', 'Totale']],
                body: insuranceData,
                startY: 120,
                theme: 'grid',
                headStyles: { 
                    fillColor: [44, 90, 160],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 10
                },
                bodyStyles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 70 },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 30, halign: 'right' },
                    4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 255]
                }
            });
            
            // TOTALE ASSICURAZIONE
            const finalY = doc.lastAutoTable.finalY + 15;
            
            doc.setFillColor(44, 90, 160);
            doc.rect(15, finalY, 180, 15, 'F');
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 255, 255);
            doc.text('VALORE TOTALE DA ASSICURARE: ‚Ç¨ ' + totalInsurance.toLocaleString('it-IT'), 105, finalY + 10, { align: 'center' });
            
            // NOTE FINALI
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('‚Ä¢ Valori riferiti al valore di mercato delle attrezzature', 15, finalY + 25);
            doc.text('‚Ä¢ La polizza deve coprire furto, incendio, danneggiamento e responsabilit√† civile', 15, finalY + 30);
            
        } else {
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('Nessuna attrezzatura con valore assicurativo trovata', 105, 130, { align: 'center' });
        }
        
        // SALVATAGGIO
        const fileName = quoteName.replace(/[^a-z0-9]/gi, '_') + '_ValoriAssicurativi_' + docNumber + '.pdf';
        doc.save(fileName);
        
        showNotification('‚úÖ Documento valori assicurativi generato: ' + docNumber, 'success');
        
    } catch (error) {
        console.error('Errore generazione valori assicurativi:', error);
        showNotification('‚ùå Errore nella generazione del documento', 'error');
    }
}
    function generateQuotePDF(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) {
        showNotification('‚ùå Preventivo non trovato!', 'error');
        return;
    }
    
    // Carica il preventivo temporaneamente per generare il PDF
    const originalName = document.getElementById('quoteName').value;
    const originalCliente = document.getElementById('cliente').value;
    const originalPiva = document.getElementById('clientePiva').value;
    const originalContatti = document.getElementById('contatti').value;
    const originalCarico = document.getElementById('carico').value;
    const originalScarico = document.getElementById('scarico').value;
    const originalDurata = document.getElementById('durata').value;
    const originalSconto = document.getElementById('sconto').value;
    
    // Carica i dati del preventivo salvato
    document.getElementById('quoteName').value = quote.name || '';
    document.getElementById('cliente').value = quote.cliente || '';
    document.getElementById('clientePiva').value = quote.clientePiva || '';
    document.getElementById('contatti').value = quote.contatti || '';
    document.getElementById('carico').value = quote.carico || '';
    document.getElementById('scarico').value = quote.scarico || '';
    document.getElementById('durata').value = quote.durata || '1';
    document.getElementById('sconto').value = quote.sconto || '0';
    
    // Simula i totali (approssimativo per il PDF)
    document.getElementById('subtotale').textContent = '‚Ç¨ ' + (quote.total / 1.22).toFixed(2);
    document.getElementById('totale').textContent = '‚Ç¨ ' + quote.total.toFixed(2);
    
    // Genera il PDF
    setTimeout(() => {
        generatePDF();
        
        // Ripristina i valori originali
        document.getElementById('quoteName').value = originalName;
        document.getElementById('cliente').value = originalCliente;
        document.getElementById('clientePiva').value = originalPiva;
        document.getElementById('contatti').value = originalContatti;
        document.getElementById('carico').value = originalCarico;
        document.getElementById('scarico').value = originalScarico;
        document.getElementById('durata').value = originalDurata;
        document.getElementById('sconto').value = originalSconto;
        
        updateTotals();
    }, 500);
}

function generateAnalyticsReport() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // HEADER CON LOGO
        try {
            doc.addImage('https://i.imgur.com/ABMgyI8.png', 'PNG', 15, 15, 20, 20);
        } catch (e) {
            doc.setFillColor(44, 90, 160);
            doc.circle(25, 25, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text('HP', 25, 28, { align: 'center' });
        }
        
        // TITOLO
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES - REPORT ANALYTICS', 45, 22);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('Generato il: ' + new Date().toLocaleDateString('it-IT'), 15, 42);
        
        // STATISTICHE
        const monthlyQuotes = document.getElementById('monthlyQuotes').textContent;
        const estimatedRevenue = document.getElementById('estimatedRevenue').textContent;
        const conversionRate = document.getElementById('conversionRate').textContent;
        const topEquipment = document.getElementById('topEquipment').textContent;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('STATISTICHE MENSILI', 15, 60);
        
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('Preventivi questo mese: ' + monthlyQuotes, 20, 70);
        doc.text('Fatturato stimato: ' + estimatedRevenue, 20, 80);
        doc.text('Tasso di conversione: ' + conversionRate, 20, 90);
        doc.text('Attrezzatura pi√π richiesta: ' + topEquipment, 20, 100);
        
        // TABELLA PREVENTIVI RECENTI
        const recentQuotes = savedQuotes.slice(-10).reverse();
        const tableData = recentQuotes.map(q => [
            q.name || 'N/A',
            q.cliente || 'N/A',
            q.createdAt ? q.createdAt.split(',')[0] : 'N/A',
            '‚Ç¨ ' + (q.total || 0).toFixed(2),
            q.status === 'draft' ? 'Bozza' : q.status === 'sent' ? 'Inviato' : 'Confermato'
        ]);
        
        if (tableData.length > 0) {
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(44, 90, 160);
            doc.text('PREVENTIVI RECENTI', 15, 120);
            
            doc.autoTable({
                head: [['Preventivo', 'Cliente', 'Data', 'Totale', 'Status']],
                body: tableData,
                startY: 130,
                theme: 'grid',
                headStyles: { 
                    fillColor: [44, 90, 160],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 10
                },
                bodyStyles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 50 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 30, halign: 'right' },
                    4: { cellWidth: 30, halign: 'center' }
                }
            });
        }
        
        doc.save('Hubris_Analytics_Report.pdf');
        showNotification('‚úÖ Report analytics generato!', 'success');
        
    } catch (error) {
        console.error('Errore generazione report:', error);
        showNotification('‚ùå Errore nella generazione del report', 'error');
    }
}

function exportAllQuotes() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // HEADER CON LOGO
        try {
            doc.addImage('https://i.imgur.com/ABMgyI8.png', 'PNG', 15, 15, 20, 20);
        } catch (e) {
            doc.setFillColor(44, 90, 160);
            doc.circle(25, 25, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text('HP', 25, 28, { align: 'center' });
        }
        
        // TITOLO
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(44, 90, 160);
        doc.text('HUBRIS PICTURES - EXPORT PREVENTIVI', 45, 22);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('Esportato il: ' + new Date().toLocaleDateString('it-IT'), 15, 42);
        doc.text('Totale preventivi: ' + savedQuotes.length, 15, 48);
        
        // TABELLA TUTTI I PREVENTIVI
        const tableData = savedQuotes.map(q => [
            q.name || 'N/A',
            q.cliente || 'N/A',
            q.createdAt ? q.createdAt.split(',')[0] : 'N/A',
            (q.durata || '1') + ' gg',
            (q.sconto || '0') + '%',
            '‚Ç¨ ' + (q.total || 0).toFixed(2),
            q.status === 'draft' ? 'Bozza' : q.status === 'sent' ? 'Inviato' : 'Confermato'
        ]);
        
        if (tableData.length > 0) {
            doc.autoTable({
                head: [['Nome', 'Cliente', 'Data', 'Durata', 'Sconto', 'Totale', 'Status']],
                body: tableData,
                startY: 60,
                theme: 'grid',
                headStyles: { 
                    fillColor: [44, 90, 160],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 20, halign: 'center' },
                    4: { cellWidth: 20, halign: 'center' },
                    5: { cellWidth: 30, halign: 'right' },
                    6: { cellWidth: 25, halign: 'center' }
                }
            });
        } else {
            doc.text('Nessun preventivo trovato', 15, 70);
        }
        
        doc.save('Hubris_Export_Tutti_Preventivi.pdf');
        showNotification('‚úÖ Export completo generato!', 'success');
        
    } catch (error) {
        console.error('Errore export:', error);
        showNotification('‚ùå Errore nell\'export', 'error');
    }
}

// SUBTOTALE MODIFICABILE
function makeSubtotalEditable() {
    const subtotalElement = document.getElementById('subtotale');
    const currentValue = subtotalElement.textContent.replace('‚Ç¨ ', '');
    
    subtotalElement.innerHTML = `<input type="number" id="manual-subtotal" value="${currentValue}" 
        style="width: 100px; text-align: right; border: 1px solid #ddd; padding: 2px;" 
        onchange="updateManualtotals()" step="0.01" min="0">`;
    
    document.getElementById('manual-subtotal').focus();
}

function updateManualtotals() {
    const manualSubtotal = parseFloat(document.getElementById('manual-subtotal').value) || 0;
    const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
    const discountAmount = manualSubtotal * (discountPercent / 100);
    const imponibile = manualSubtotal - discountAmount;
    const iva = imponibile * 0.22;
    const totale = imponibile + iva;
    
    // Restore normal display
    document.getElementById('subtotale').innerHTML = '‚Ç¨ ' + manualSubtotal.toFixed(2);
    document.getElementById('discount-percent').textContent = discountPercent.toFixed(1);
    document.getElementById('sconto-amount').textContent = '‚Ç¨ ' + discountAmount.toFixed(2);
    document.getElementById('imponibile').textContent = '‚Ç¨ ' + imponibile.toFixed(2);
    document.getElementById('iva').textContent = '‚Ç¨ ' + iva.toFixed(2);
    document.getElementById('totale').textContent = '‚Ç¨ ' + totale.toFixed(2);
}
// ANALYTICS
function updateAnalytics() {
    const thisMonth = savedQuotes.filter(q => {
        const created = new Date(q.createdAt.split(', ')[0].split('/').reverse().join('-'));
        const now = new Date();
        return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
    });
    const totalRevenue = thisMonth.reduce((sum, q) => sum + q.total, 0);
    const confirmedQuotes = savedQuotes.filter(q => q.status === 'confirmed').length;
    const conversionRate = savedQuotes.length > 0 ? (confirmedQuotes / savedQuotes.length * 100) : 0;
    document.getElementById('monthlyQuotes').textContent = thisMonth.length;
    document.getElementById('estimatedRevenue').textContent = '‚Ç¨ ' + totalRevenue.toFixed(0);
    document.getElementById('conversionRate').textContent = conversionRate.toFixed(1) + '%';
    const equipmentCount = {};
    savedQuotes.forEach(quote => {
        quote.equipment.forEach(item => {
            if (!item.isService) {
                equipmentCount[item.equipment] = (equipmentCount[item.equipment] || 0) + parseInt(item.quantity);
            }
        });
    });
    const mostRequested = Object.keys(equipmentCount).reduce((a, b) => 
        equipmentCount[a] > equipmentCount[b] ? a : b, 'N/A'
    );
    document.getElementById('topEquipment').textContent = mostRequested;
}

// PLACEHOLDER FUNCTIONS FOR FUTURE DEVELOPMENT
function addNewEquipment() {
    const newName = prompt('Nome della nuova attrezzatura:');
    if (!newName) return;
    
    const category = prompt('Categoria (lascia vuoto per creare nuova categoria):');
    const price1 = parseFloat(prompt('Prezzo 1 giorno:') || '0');
    const price3 = parseFloat(prompt('Prezzo 3 giorni:') || '0');
    const price7 = parseFloat(prompt('Prezzo 1 settimana:') || '0');
    const insurance = parseFloat(prompt('Valore assicurativo:') || '0');
    const kit = prompt('Kit/Note (opzionale):') || '';
    
    if (!category) {
        const newCategory = prompt('Nome nuova categoria:');
        if (!newCategory) return;
        
        if (!equipmentDatabase[newCategory]) {
            equipmentDatabase[newCategory] = {};
        }
        
        equipmentDatabase[newCategory][newName] = {
            price1, price3, price7, insurance, kit, notes: ''
        };
    } else if (equipmentDatabase[category]) {
        equipmentDatabase[category][newName] = {
            price1, price3, price7, insurance, kit, notes: ''
        };
    } else {
        showNotification('‚ùå Categoria non trovata!', 'error');
        return;
    }
    
    // Refresh display
    const processedData = [];
    Object.keys(equipmentDatabase).forEach(cat => {
        Object.keys(equipmentDatabase[cat]).forEach(item => {
            const data = equipmentDatabase[cat][item];
            processedData.push({
                category: cat,
                name: item,
                ...data
            });
        });
    });
    
    renderDatabase(processedData);
    updateCategoryFilter();
    updateDbStats();
    showNotification('‚úÖ Attrezzatura "' + newName + '" aggiunta!', 'success');
}

function editEquipment(category, name) {
    if (!equipmentDatabase[category] || !equipmentDatabase[category][name]) {
        showNotification('‚ùå Attrezzatura non trovata!', 'error');
        return;
    }
    
    const current = equipmentDatabase[category][name];
    
    const newPrice1 = parseFloat(prompt('Prezzo 1 giorno:', current.price1) || current.price1);
    const newPrice3 = parseFloat(prompt('Prezzo 3 giorni:', current.price3) || current.price3);
    const newPrice7 = parseFloat(prompt('Prezzo 1 settimana:', current.price7) || current.price7);
    const newInsurance = parseFloat(prompt('Valore assicurativo:', current.insurance) || current.insurance);
    const newKit = prompt('Kit/Note:', current.kit) || current.kit;
    
    // Update data
    equipmentDatabase[category][name] = {
        price1: newPrice1,
        price3: newPrice3,
        price7: newPrice7,
        insurance: newInsurance,
        kit: newKit,
        notes: current.notes || ''
    };
    
    // Refresh display
    const processedData = [];
    Object.keys(equipmentDatabase).forEach(cat => {
        Object.keys(equipmentDatabase[cat]).forEach(item => {
            const data = equipmentDatabase[cat][item];
            processedData.push({
                category: cat,
                name: item,
                ...data
            });
        });
    });
    
    renderDatabase(processedData);
    showNotification('‚úÖ Attrezzatura "' + name + '" modificata!', 'success');
}

function loadQuote() {
    if (savedQuotes.length === 0) {
        showNotification('‚ùå Nessun preventivo salvato!', 'error');
        return;
    }
    showTab('saved');
    document.querySelector('[onclick="showTab(\'saved\')"]').classList.add('active');
    showNotification('üìÇ Seleziona un preventivo dalla lista', 'info');
}

function duplicateQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('‚ùå Nessun preventivo da duplicare!', 'error');
        return;
    }
    document.getElementById('quoteName').value = quoteName + ' - Copia';
    showNotification('üìÑ Preventivo duplicato! Modifica il nome e salva.', 'info');
}

// INITIALIZATION
// INITIALIZATION MIGLIORATA
window.addEventListener('load', function() {
    console.log('üöÄ Inizializzazione sistema Hubris Rental...');
    
    // Carica configurazione salvata
    const savedApiKey = localStorage.getItem('hubris_api_key');
    const savedSheetsId = localStorage.getItem('hubris_sheets_id');
    
    if (savedApiKey && savedApiKey.trim()) {
        CONFIG.API_KEY = savedApiKey.trim();
        console.log('üîë API Key caricata da localStorage');
    }
    
    if (savedSheetsId && savedSheetsId.trim()) {
        CONFIG.SHEETS_ID = savedSheetsId.trim();
        console.log('üìä Sheets ID caricato da localStorage');
    }
    
    // Log configurazione (senza esporre API key completa)
    console.log('‚öôÔ∏è Configurazione:', {
        hasApiKey: !!CONFIG.API_KEY,
        apiKeyPrefix: CONFIG.API_KEY ? CONFIG.API_KEY.substring(0, 8) + '...' : 'non impostato',
        sheetsId: CONFIG.SHEETS_ID ? CONFIG.SHEETS_ID.substring(0, 10) + '...' : 'non impostato'
    });
    
    // Carica sempre i preventivi da localStorage prima di tutto
    loadQuotesFromSheets();
    
    // Inizializza Google API solo se configurato
    if (CONFIG.API_KEY && CONFIG.SHEETS_ID) {
        console.log('üîÑ Configurazione presente, verifica validit√†...');
        
        // Verifica base della API key
        if (!CONFIG.API_KEY.startsWith('AIza') || CONFIG.API_KEY.length < 39) {
            console.error('‚ùå API Key non valida nel formato');
            updateConnectionStatus('offline', 'API Key non valida');
            showNotification('‚ùå API Key non valida - Clicca su Config per aggiornare', 'error');
            return;
        }
        
        // Ritardo per dare tempo al DOM di caricarsi completamente
        setTimeout(() => {
            initializeGoogleAPI();
        }, 1000);
    } else {
        console.log('‚öôÔ∏è Configurazione incompleta, modalit√† offline');
        updateConnectionStatus('offline', 'Configurazione richiesta');
        showNotification('‚öôÔ∏è Clicca su "Config" per configurare le API Google Sheets', 'warning');
        
        // Mostra automaticamente il modal di configurazione al primo avvio
        if (!savedApiKey && !savedSheetsId) {
            setTimeout(() => {
                showConfigModal();
            }, 2000);
        }
    }
    
    // Auto-sync every 10 minutes (ridotto per evitare troppi tentativi)
    setInterval(() => {
        if (isConnected && gapi_loaded) {
            console.log('üîÑ Auto-sync programmato...');
            loadDatabaseFromSheets();
            updateSyncTime();
        }
    }, 600000); // 10 minuti
    
    console.log('‚úÖ Inizializzazione completata');
});

// Global error handler
// GESTIONE ERRORI GLOBALE MIGLIORATA
window.addEventListener('error', function(e) {
    console.error('‚ùå Errore globale:', e.error);
    console.error('üìç File:', e.filename, 'Linea:', e.lineno);
    
    // Errori specifici Google API
    if (e.error && e.error.message) {
        if (e.error.message.includes('gapi')) {
            showNotification('‚ö†Ô∏è Errore Google API - ricaricare la pagina', 'warning');
        } else if (e.error.message.includes('jsPDF')) {
            showNotification('‚ö†Ô∏è Errore generazione PDF', 'warning');
        } else {
            showNotification('‚ùå Errore del sistema. Verifica console.', 'error');
        }
    }
});

// Gestione errori promesse non catturate
window.addEventListener('unhandledrejection', function(e) {
    console.error('‚ùå Promise rejection non gestita:', e.reason);
    
    // Errori API Google Sheets specifici
    if (e.reason && e.reason.message) {
        if (e.reason.message.includes('PERMISSION_DENIED')) {
            showNotification('‚ùå Accesso negato a Google Sheets', 'error');
        } else if (e.reason.message.includes('NOT_FOUND')) {
            showNotification('‚ùå Google Sheet non trovato', 'error');
        } else if (e.reason.message.includes('API_KEY_INVALID')) {
            showNotification('‚ùå API Key non valida', 'error');
        }
    }
    
    e.preventDefault(); // Previene la stampa dell'errore in console
});

// Verifica periodica dello stato delle API
setInterval(() => {
    if (CONFIG.API_KEY && CONFIG.SHEETS_ID && !isConnected) {
        console.log('üîÑ Tentativo riconnessione automatica...');
        initializeGoogleAPI();
    }
}, 30000); // Ogni 30 secondi

// Prevent accidental page reload
window.addEventListener('beforeunload', function(e) {
    const hasUnsavedChanges = document.getElementById('quoteName').value || 
                           document.querySelectorAll('[id^="row-"]').length > 0;
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});
// FIX IMMEDIATO PER I BOTTONI
document.addEventListener('DOMContentLoaded', function() {
    // Config button
    const configBtn = document.getElementById('configBtn');
    if (configBtn) {
        configBtn.addEventListener('click', function() {
            const modal = document.getElementById('configModal');
            if (modal) {
                modal.classList.add('active');
                document.getElementById('apiKeyInput').value = CONFIG.API_KEY || '';
                document.getElementById('sheetsIdInput').value = CONFIG.SHEETS_ID || '';
            }
        });
    }
    
    // Cancel button
    const cancelBtn = document.getElementById('cancelBtn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            const modal = document.getElementById('configModal');
            if (modal) {
                modal.classList.remove('active');
            }
        });
    }
    
    // Save button
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            window.saveConfig();
        });
    }
});
</script>
</body>
</html>
