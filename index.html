<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubris Rental - Sistema Completo</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Trebuchet MS', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #2c5aa0; }
        .connection-status { display: flex; align-items: center; gap: 15px; font-size: 14px; color: #666; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background: #4CAF50; }
        .status-syncing { background: #FF9800; animation: pulse 1s infinite; }
        .status-offline { background: #F44336; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .container { max-width: 1400px; margin: 20px auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; backdrop-filter: blur(10px); }
        .tabs { display: flex; background: linear-gradient(90deg, #2c5aa0 0%, #1a4480 100%); overflow-x: auto; }
        .tab { flex: 1; padding: 20px 25px; cursor: pointer; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-weight: 600; font-size: 16px; transition: all 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-2px); }
        .tab:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .btn-danger { background: linear-gradient(135deg, #F44336, #D32F2F); color: white; }
        .btn-info { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; }
        .form-input { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; outline: none; transition: all 0.3s ease; }
        .form-input:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; font-weight: bold; z-index: 1000; animation: slideIn 0.3s ease; max-width: 300px; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #F44336; }
        .notification.info { background: #2196F3; }
        .notification.warning { background: #FF9800; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); max-height: 600px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        .data-table tr:hover { background: linear-gradient(135deg, #f8f9ff, #f0f4ff); }
        .category-row { background: linear-gradient(135deg, #FF9800, #F57C00) !important; color: white; font-weight: bold; }
        .category-row:hover { background: linear-gradient(135deg, #F57C00, #EF6C00) !important; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .section-title { font-size: 28px; font-weight: bold; color: #2c5aa0; }
        .controls-grid { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; margin-bottom: 25px; align-items: center; }
        .search-box { padding: 12px 20px; border: 2px solid #e1e5e9; border-radius: 25px; font-size: 16px; outline: none; transition: all 0.3s ease; background: white; }
        .search-box:focus { border-color: #2c5aa0; box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1); }
        .filter-select { padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 12px; background: white; font-size: 14px; cursor: pointer; outline: none; transition: border-color 0.3s ease; }
        .filter-select:focus { border-color: #ff9800; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
        .quote-header { background: linear-gradient(135deg, #f8f9ff, #e3f2fd); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #e1e5e9; }
        .quote-controls { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 15px; align-items: end; }
        .equipment-section { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .equipment-header { background: linear-gradient(135deg, #2c5aa0, #1a4480); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .totals-section { background: linear-gradient(135deg, #f8f9ff, #e8f5e8); padding: 25px; border-radius: 15px; margin-top: 25px; border: 2px solid #e1e5e9; }
        .total-line { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; }
        .total-line.final { border-top: 2px solid #2c5aa0; padding-top: 12px; margin-top: 15px; font-size: 20px; font-weight: bold; color: #2c5aa0; }
        .quotes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .quote-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; }
        .quote-card:hover { border-color: #2c5aa0; transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .quote-title { font-size: 18px; font-weight: bold; color: #2c5aa0; margin-bottom: 10px; }
        .quote-meta { font-size: 13px; color: #666; margin-bottom: 15px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-draft { background: #fff3e0; color: #f57c00; }
        .status-sent { background: #e8f5e8; color: #4caf50; }
        .status-confirmed { background: #e3f2fd; color: #2196f3; }
        @media (max-width: 768px) { .nav-content { flex-direction: column; gap: 10px; } .container { margin: 10px; border-radius: 15px; } .tab-content { padding: 20px; } .controls-grid { grid-template-columns: 1fr; gap: 10px; } .form-grid { grid-template-columns: 1fr; } .quote-controls { grid-template-columns: 1fr; gap: 10px; } .data-table { font-size: 12px; } .data-table th, .data-table td { padding: 8px 6px; } .quotes-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="navbar">
    <div class="nav-content">
        <div class="logo">üé¨ HUBRIS PICTURES S.R.L.</div>
        <div class="connection-status">
            <span class="status-indicator" id="connectionStatus"></span>
            <span id="connectionText">Connecting...</span>
            <span>|</span>
            <span id="lastSync">Ultimo sync: mai</span>
            <span>|</span>
            <button class="btn btn-warning" onclick="showConfigModal()" style="padding: 6px 12px; font-size: 12px;">‚öôÔ∏è Config</button>
        </div>
    </div>
</nav>
<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('database')">üóÑÔ∏è Database</button>
        <button class="tab" onclick="showTab('quotes')">üìã Nuovo Preventivo</button>
        <button class="tab" onclick="showTab('saved')">üíæ Preventivi Salvati</button>
        <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
    </div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #2c5aa0; margin-bottom: 20px;">‚öôÔ∏è Configurazione Sistema</h2>
            <div style="background: linear-gradient(135deg, #fff3e0, #ffeaa7); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ff9800;">
                <div style="font-size: 18px; font-weight: bold; color: #f57c00; margin-bottom: 15px;">üîë Google Sheets API</div>
                <div class="form-group">
                    <label class="form-label">API Key:</label>
                    <input type="text" class="form-input" id="apiKeyInput" placeholder="Inserisci la tua API Key">
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">Sheets ID:</label>
                    <input type="text" class="form-input" id="sheetsIdInput" placeholder="ID del tuo Google Sheets">
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">‚ÑπÔ∏è Inserisci le credenziali per collegare il sistema al tuo database Google Sheets</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeConfigModal()">Annulla</button>
                <button class="btn btn-success" onclick="saveConfig()">üíæ Salva e Connetti</button>
            </div>
        </div>
    </div>

    <!-- DATABASE TAB -->
    <div id="database" class="tab-content active">
        <div class="section-header">
            <h2 class="section-title">Database Attrezzature</h2>
            <div id="dbStats" style="font-size: 14px; color: #666;"></div>
        </div>
        <div class="controls-grid">
            <input type="text" class="search-box" placeholder="üîç Cerca attrezzatura..." onkeyup="filterDatabase()" id="searchInput">
            <select class="filter-select" onchange="filterByCategory()" id="categoryFilter">
                <option value="">Tutte le categorie</option>
            </select>
            <button class="btn btn-success" onclick="addNewEquipment()">+ Nuova</button>
            <button class="btn btn-warning" onclick="syncDatabase()" id="syncBtn">üîÑ Sync</button>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Attrezzatura</th>
                        <th>1 Giorno</th>
                        <th>3 Giorni</th>
                        <th>1 Settimana</th>
                        <th>Valore Assic.</th>
                        <th>Kit/Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="databaseBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Configura le API per caricare il database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- QUOTES TAB -->
    <div id="quotes" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Nuovo Preventivo</h2>
        </div>
        <div class="quote-header">
            <div class="quote-controls">
                <div class="form-group">
                    <label class="form-label">Nome Preventivo</label>
                    <input type="text" class="form-input" id="quoteName" placeholder="Es: Spot TV Audi Q3">
                </div>
                <button class="btn btn-success" onclick="saveQuote()">üíæ Salva</button>
                <button class="btn btn-info" onclick="loadQuote()">üìÇ Carica</button>
                <button class="btn btn-warning" onclick="duplicateQuote()">üìÑ Duplica</button>
                <button class="btn btn-danger" onclick="resetQuote()">üîÑ Reset</button>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-input" id="cliente" placeholder="Nome del cliente">
            </div>
            <div class="form-group">
                <label class="form-label">P.IVA Cliente</label>
                <input type="text" class="form-input" id="clientePiva" placeholder="Partita IVA del cliente">
            </div>
            <div class="form-group">
                <label class="form-label">Contatti</label>
                <input type="text" class="form-input" id="contatti" placeholder="Telefono/Email">
            </div>
            <div class="form-group">
                <label class="form-label">Data Carico</label>
                <input type="date" class="form-input" id="carico">
            </div>
            <div class="form-group">
                <label class="form-label">Data Scarico</label>
                <input type="date" class="form-input" id="scarico">
            </div>
        </div>
        <div class="form-grid" style="grid-template-columns: auto auto auto 1fr auto auto;">
            <div class="form-group">
                <label class="form-label">Durata (giorni)</label>
                <input type="number" class="form-input" id="durata" value="1" min="1" max="30" onchange="updateAllPrices()" style="width: 100px;">
            </div>
            <div class="form-group">
                <label class="form-label">Sconto (%)</label>
                <input type="number" class="form-input" id="sconto" value="0" min="0" max="50" step="0.1" onchange="updateTotals()" style="width: 100px;">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-input" id="quoteType">
                    <option value="rental">Noleggio</option>
                    <option value="sale">Vendita</option>
                    <option value="service">Servizio</option>
                </select>
            </div>
            <div></div>
            <button class="btn btn-primary" onclick="addEquipmentRow()">+ Attrezzatura</button>
            <button class="btn btn-info" onclick="addServiceRow()">+ Servizio</button>
        </div>
        <div class="equipment-section">
            <div class="equipment-header">
                <h3>Lista Attrezzature e Servizi</h3>
                <div>
                    <button class="btn btn-info" onclick="generatePDF()">üìÑ PDF</button>
                    <button class="btn btn-warning" onclick="generateInsurance()">üõ°Ô∏è Assicurazione</button>
                    <button class="btn btn-success" onclick="generateNoPricesQuote()">üìã Senza Prezzi</button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 180px;">Categoria</th>
                        <th style="width: 220px;">Attrezzatura/Servizio</th>
                        <th style="width: 80px;">Qt√†</th>
                        <th style="width: 120px;">Prezzo Unit.</th>
                        <th style="width: 120px;">Totale</th>
                        <th style="width: 80px;">Azioni</th>
                    </tr>
                </thead>
                <tbody id="equipmentRows"></tbody>
            </table>
        </div>
        <div class="totals-section">
            <div>
                <div class="total-line">
                    <span>Subtotale:</span>
                    <span id="subtotale">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line">
                    <span>Sconto (<span id="discount-percent">0</span>%):</span>
                    <span id="sconto-amount">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line">
                    <span>Imponibile:</span>
                    <span id="imponibile">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line">
                    <span>IVA (22%):</span>
                    <span id="iva">‚Ç¨ 0.00</span>
                </div>
                <div class="total-line final">
                    <span>TOTALE:</span>
                    <span id="totale">‚Ç¨ 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVED QUOTES TAB -->
    <div id="saved" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Preventivi Salvati</h2>
            <div>
                <button class="btn btn-warning" onclick="syncQuotes()">üîÑ Aggiorna</button>
                <button class="btn btn-info" onclick="exportAllQuotes()">üìä Export Excel</button>
            </div>
        </div>
        <div class="quotes-grid" id="savedQuotes">
            <div class="quote-card">
                <div class="quote-title">Caricamento...</div>
                <div class="quote-meta">Sincronizzazione con Google Sheets in corso...</div>
            </div>
        </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics" class="tab-content">
        <div class="section-header">
            <h2 class="section-title">Analytics & Statistiche</h2>
            <button class="btn btn-info" onclick="generateAnalyticsReport()">üìä Report Completo</button>
        </div>
        <div class="form-grid">
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Preventivi Questo Mese</h3>
                <div style="font-size: 36px; font-weight: bold; color: #4CAF50;" id="monthlyQuotes">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Fatturato Stimato</h3>
                <div style="font-size: 36px; font-weight: bold; color: #FF9800;" id="estimatedRevenue">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Attrezzature Pi√π Richieste</h3>
                <div style="font-size: 18px; font-weight: bold; color: #2196F3;" id="topEquipment">-</div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: #2c5aa0; margin-bottom: 10px;">Tasso di Conversione</h3>
                <div style="font-size: 36px; font-weight: bold; color: #9C27B0;" id="conversionRate">-</div>
            </div>
        </div>
    </div>
</div>
<script>
    // CONFIGURAZIONE GLOBALE - AGGIORNATA CON NUOVO SHEETS ID
let CONFIG = {
    API_KEY: 'AIzaSyAbcQrfJiXQMIbBAb5ZOLvm_9tEz73d1DY',
    SHEETS_ID: '1gzjiGiZkyKeaE6f0iBKoeUNW7bbhemdQiipGknnd6Pc',
    DATABASE_RANGE: 'Database!A:G',
    QUOTES_RANGE: 'Preventivi_Salvati!A:Z'
};

// STATO GLOBALE
let equipmentDatabase = {};
let savedQuotes = [];
let isConnected = false;
let gapi_loaded = false;
let rowCounter = 0;

// GOOGLE SHEETS API INITIALIZATION
function initializeGoogleAPI() {
    updateConnectionStatus('syncing', 'Connessione in corso...');
    gapi.load('client', async () => {
        try {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            });
            gapi_loaded = true;
            isConnected = true;
            updateConnectionStatus('online', 'Connesso');
            await loadDatabaseFromSheets();
            await loadQuotesFromSheets();
            showNotification('‚úÖ Connessione Google Sheets stabilita!', 'success');
        } catch (error) {
            console.error('Errore inizializzazione API:', error);
            updateConnectionStatus('offline', 'Errore connessione');
            showNotification('‚ùå Errore connessione Google Sheets: ' + error.message, 'error');
        }
    });
}

// GOOGLE SHEETS DATA LOADING
async function loadDatabaseFromSheets() {
    if (!gapi_loaded || !isConnected) {
        showNotification('‚ö†Ô∏è Connessione Google Sheets non disponibile', 'warning');
        return;
    }
    try {
        updateConnectionStatus('syncing', 'Sincronizzazione database...');
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: CONFIG.DATABASE_RANGE
        });
        const values = response.result.values;
        if (!values || values.length === 0) {
            throw new Error('Nessun dato trovato nel database');
        }
        processEquipmentData(values);
        updateConnectionStatus('online', 'Database aggiornato');
        updateSyncTime();
        showNotification('‚úÖ Database caricato: ' + Object.keys(equipmentDatabase).length + ' categorie', 'success');
    } catch (error) {
        console.error('Errore caricamento database:', error);
        updateConnectionStatus('offline', 'Errore sync database');
        showNotification('‚ùå Errore caricamento database: ' + error.message, 'error');
    }
}

async function loadQuotesFromSheets() {
    if (!gapi_loaded || !isConnected) {
        // Carica da localStorage se disponibile
        const localQuotes = localStorage.getItem('hubris_quotes');
        if (localQuotes) {
            try {
                savedQuotes = JSON.parse(localQuotes);
                renderSavedQuotes();
                updateAnalytics();
                showNotification('üìÇ Preventivi caricati da memoria locale', 'info');
            } catch (e) {
                savedQuotes = [];
            }
        }
        return;
    }
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: CONFIG.QUOTES_RANGE
        });
        const values = response.result.values;
        if (values && values.length > 1) {
            savedQuotes = parseQuotesData(values);
            // Salva anche in localStorage come backup
            localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
            renderSavedQuotes();
            updateAnalytics();
        }
    } catch (error) {
        console.log('Foglio preventivi non trovato, verr√† creato al primo salvataggio');
        savedQuotes = [];
    }
}

async function saveQuoteToSheets(quote) {
    // Salva sempre in localStorage
    localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
    
    if (!gapi_loaded || !isConnected) {
        showNotification('üíæ Preventivo salvato localmente - sincronizzazione quando connesso', 'warning');
        return;
    }
    try {
        const quoteRow = [
            quote.id, quote.name, quote.cliente, quote.clientePiva || '', quote.contatti, 
            quote.carico, quote.scarico, quote.durata, quote.sconto, quote.total, 
            quote.status, quote.createdAt, JSON.stringify(quote.equipment)
        ];
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SHEETS_ID,
            range: 'Preventivi_Salvati!A:M',
            valueInputOption: 'RAW',
            resource: { values: [quoteRow] }
        });
        showNotification('‚úÖ Preventivo salvato su Google Sheets', 'success');
    } catch (error) {
        console.error('Errore salvataggio:', error);
        showNotification('‚ùå Errore salvataggio su Google Sheets, salvato localmente', 'error');
    }
}

// DATA PROCESSING
function processEquipmentData(values) {
    equipmentDatabase = {};
    const processedData = [];
    let currentCategory = '';
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (!row || row.length === 0) continue;
        const name = row[0] || '';
        const price1 = parseFloat(row[1]) || 0;
        const price3 = parseFloat(row[2]) || 0;
        const price7 = parseFloat(row[3]) || 0;
        const insurance = parseFloat(row[4]) || 0;
        const kit = row[5] || '';
        const notes = row[6] || '';
        if (name && !price1 && !price3 && !price7 && !insurance) {
            currentCategory = name;
            if (!equipmentDatabase[currentCategory]) {
                equipmentDatabase[currentCategory] = {};
            }
        } else if (name && currentCategory) {
            equipmentDatabase[currentCategory][name] = {
                price1, price3, price7, insurance, kit, notes
            };
            processedData.push({
                category: currentCategory, name, price1, price3, price7, insurance, kit, notes
            });
        }
    }
    renderDatabase(processedData);
    updateCategoryFilter();
    updateDbStats();
}

function parseQuotesData(values) {
    const quotes = [];
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (row && row.length >= 12) {
            quotes.push({
                id: parseInt(row[0]) || Date.now(),
                name: row[1] || '',
                cliente: row[2] || '',
                clientePiva: row[3] || '',
                contatti: row[4] || '',
                carico: row[5] || '',
                scarico: row[6] || '',
                durata: parseInt(row[7]) || 1,
                sconto: parseFloat(row[8]) || 0,
                total: parseFloat(row[9]) || 0,
                status: row[10] || 'draft',
                createdAt: row[11] || '',
                equipment: JSON.parse(row[12] || '[]')
            });
        }
    }
    return quotes;
}

// NUOVA FUNZIONE PER AGGIUNGERE SERVIZI
function addServiceRow() {
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.className = 'equipment-row service-row';
    row.id = 'row-' + rowCounter;
    row.style.background = '#fff3e0';
    row.innerHTML = `
        <td style="color: #f57c00; font-weight: bold;">üîß SERVIZIO</td>
        <td>
            <input type="text" class="form-input" placeholder="Nome del servizio (es. Trasporto)" 
                   id="service-name-${rowCounter}" style="width: 100%; margin-bottom: 5px;">
            <textarea class="form-input" placeholder="Note servizio..." 
                      id="service-notes-${rowCounter}" style="width: 100%; height: 60px; resize: vertical;"></textarea>
        </td>
        <td>
            <input type="number" class="form-input" value="1" min="1" 
                   onchange="updateRowTotal(${rowCounter})" id="qty-${rowCounter}" 
                   style="width: 100%; text-align: center;">
        </td>
        <td>
            <input type="number" class="form-input" placeholder="0.00" min="0" step="0.01" 
                   onchange="updateRowTotal(${rowCounter})" id="service-price-${rowCounter}" 
                   style="width: 100%; text-align: right;">
        </td>
        <td style="text-align: right; font-weight: bold; color: #f57c00;" id="total-${rowCounter}">‚Ç¨ 0.00</td>
        <td>
            <button class="btn btn-danger" onclick="removeRow(${rowCounter})" 
                    style="padding: 6px 12px; font-size: 12px;">‚úï</button>
        </td>
    `;
    tbody.appendChild(row);
}

// UI RENDERING
function renderDatabase(data) {
    const tbody = document.getElementById('databaseBody');
    tbody.innerHTML = '';
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Nessun dato disponibile. Configura le API per caricare il database.</td></tr>';
        return;
    }
    let currentCategory = '';
    data.forEach((item, index) => {
        if (item.category !== currentCategory) {
            const categoryRow = document.createElement('tr');
            categoryRow.className = 'category-row';
            categoryRow.innerHTML = '<td colspan="7" style="text-align: center; font-weight: bold;">üìÅ ' + item.category + '</td>';
            tbody.appendChild(categoryRow);
            currentCategory = item.category;
        }
        const row = document.createElement('tr');
        row.innerHTML = '<td style="font-weight: 500;">' + item.name + '</td><td>‚Ç¨ ' + item.price1.toFixed(2) + '</td><td>‚Ç¨ ' + item.price3.toFixed(2) + '</td><td>‚Ç¨ ' + item.price7.toFixed(2) + '</td><td>‚Ç¨ ' + item.insurance.toLocaleString() + '</td><td style="font-size: 12px; color: #666; max-width: 200px;">' + item.kit + '</td><td><button class="btn btn-warning" onclick="editEquipment(\'' + item.category + '\', \'' + item.name + '\')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è</button></td>';
        tbody.appendChild(row);
    });
}

function updateCategoryFilter() {
    const filter = document.getElementById('categoryFilter');
    filter.innerHTML = '<option value="">Tutte le categorie</option>';
    Object.keys(equipmentDatabase).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filter.appendChild(option);
    });
}

function updateDbStats() {
    const totalCategories = Object.keys(equipmentDatabase).length;
    let totalItems = 0;
    Object.values(equipmentDatabase).forEach(category => {
        totalItems += Object.keys(category).length;
    });
    document.getElementById('dbStats').textContent = totalCategories + ' categorie, ' + totalItems + ' attrezzature';
}
    function renderSavedQuotes() {
    const container = document.getElementById('savedQuotes');
    container.innerHTML = '';
    if (savedQuotes.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;"><h3>Nessun preventivo salvato</h3><p>Crea il tuo primo preventivo nella sezione "Nuovo Preventivo"</p></div>';
        return;
    }
    savedQuotes.forEach(quote => {
        const div = document.createElement('div');
        div.className = 'quote-card';
        div.innerHTML = '<div class="quote-title">' + quote.name + '</div><div class="quote-meta"><strong>Cliente:</strong> ' + quote.cliente + (quote.clientePiva ? '<br><strong>P.IVA:</strong> ' + quote.clientePiva : '') + '<br><strong>Durata:</strong> ' + quote.durata + ' giorni<br><strong>Totale:</strong> ‚Ç¨ ' + quote.total.toFixed(2) + '<br><strong>Creato:</strong> ' + quote.createdAt + '</div><div style="margin-top: 15px;"><span class="status-badge status-' + quote.status + '">' + (quote.status === 'draft' ? 'Bozza' : quote.status === 'sent' ? 'Inviato' : 'Confermato') + '</span><div style="margin-top: 10px;"><button class="btn btn-primary" onclick="loadQuoteById(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üìÇ</button><button class="btn btn-info" onclick="generateQuotePDF(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üìÑ</button><button class="btn btn-warning" onclick="duplicateQuoteById(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üìÑ</button><button class="btn btn-danger" onclick="deleteQuote(' + quote.id + ')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è</button></div></div>';
        container.appendChild(div);
    });
}

// TAB MANAGEMENT
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    if (tabName === 'analytics') {
        updateAnalytics();
    }
}

// CONFIGURATION MODAL
function showConfigModal() {
    document.getElementById('apiKeyInput').value = CONFIG.API_KEY;
    document.getElementById('sheetsIdInput').value = CONFIG.SHEETS_ID;
    document.getElementById('configModal').classList.add('active');
}

function closeConfigModal() {
    document.getElementById('configModal').classList.remove('active');
}

function saveConfig() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const sheetsId = document.getElementById('sheetsIdInput').value.trim();
    if (!apiKey || !sheetsId) {
        showNotification('‚ùå Inserisci API Key e Sheets ID', 'error');
        return;
    }
    CONFIG.API_KEY = apiKey;
    CONFIG.SHEETS_ID = sheetsId;
    localStorage.setItem('hubris_api_key', apiKey);
    localStorage.setItem('hubris_sheets_id', sheetsId);
    closeConfigModal();
    showNotification('‚öôÔ∏è Configurazione salvata. Connessione in corso...', 'info');
    setTimeout(() => {
        initializeGoogleAPI();
    }, 1000);
}

// QUOTE MANAGEMENT
function addEquipmentRow() {
    if (Object.keys(equipmentDatabase).length === 0) {
        showNotification('‚ö†Ô∏è Carica prima il database delle attrezzature', 'warning');
        return;
    }
    rowCounter++;
    const tbody = document.getElementById('equipmentRows');
    const row = document.createElement('tr');
    row.className = 'equipment-row';
    row.id = 'row-' + rowCounter;
    row.style.background = '#f8f9ff';
    row.innerHTML = '<td><select class="form-input" onchange="updateEquipmentOptions(' + rowCounter + ')" id="category-' + rowCounter + '" style="width: 100%;"><option value="">Seleziona categoria...</option>' + Object.keys(equipmentDatabase).map(cat => '<option value="' + cat + '">' + cat + '</option>').join('') + '</select></td><td><select class="form-input" onchange="updateRowData(' + rowCounter + ')" id="equipment-' + rowCounter + '" style="width: 100%;" disabled><option value="">Prima seleziona categoria</option></select><div style="font-size: 11px; color: #666; margin-top: 5px;" id="kit-' + rowCounter + '"></div></td><td><input type="number" class="form-input" value="1" min="1" onchange="updateRowTotal(' + rowCounter + ')" id="qty-' + rowCounter + '" style="width: 100%; text-align: center;"></td><td style="text-align: right; font-weight: bold; color: #2e7d32;" id="price-' + rowCounter + '">‚Ç¨ 0.00</td><td style="text-align: right; font-weight: bold; color: #2e7d32;" id="total-' + rowCounter + '">‚Ç¨ 0.00</td><td><button class="btn btn-danger" onclick="removeRow(' + rowCounter + ')" style="padding: 6px 12px; font-size: 12px;">‚úï</button></td>';
    tbody.appendChild(row);
}

function updateEquipmentOptions(rowId) {
    const categorySelect = document.getElementById('category-' + rowId);
    const equipmentSelect = document.getElementById('equipment-' + rowId);
    const category = categorySelect.value;
    equipmentSelect.innerHTML = '<option value="">Seleziona attrezzatura...</option>';
    if (category && equipmentDatabase[category]) {
        equipmentSelect.disabled = false;
        Object.keys(equipmentDatabase[category]).forEach(equipment => {
            const option = document.createElement('option');
            option.value = equipment;
            option.textContent = equipment;
            equipmentSelect.appendChild(option);
        });
    } else {
        equipmentSelect.disabled = true;
    }
    document.getElementById('kit-' + rowId).textContent = '';
    document.getElementById('price-' + rowId).textContent = '‚Ç¨ 0.00';
    document.getElementById('total-' + rowId).textContent = '‚Ç¨ 0.00';
    updateTotals();
}

function updateRowData(rowId) {
    const categorySelect = document.getElementById('category-' + rowId);
    const equipmentSelect = document.getElementById('equipment-' + rowId);
    const category = categorySelect.value;
    const equipment = equipmentSelect.value;
    if (category && equipment && equipmentDatabase[category][equipment]) {
        const data = equipmentDatabase[category][equipment];
        const duration = parseInt(document.getElementById('durata').value);
        const price = calculatePrice(data.price1, data.price3, data.price7, duration);
        document.getElementById('price-' + rowId).textContent = '‚Ç¨ ' + price.toFixed(2);
        document.getElementById('kit-' + rowId).textContent = data.kit;
        updateRowTotal(rowId);
    }
}

function calculatePrice(price1, price3, price7, duration) {
    if (duration === 1) return price1;
    if (duration === 2) return price1 * 2;
    if (duration === 3) return price3;
    if (duration === 4) return price3 + price1;
    if (duration === 5) return price7;
    if (duration === 6) return price7 + price1;
    if (duration === 7) return price7 + (price1 * 2);
    if (duration === 8) return price7 + price3;
    if (duration === 9) return price7 + price3 + price1;
    if (duration >= 10) return price7 * 2;
    return price1;
}

function updateRowTotal(rowId) {
    const row = document.getElementById('row-' + rowId);
    let price = 0;
    let quantity = parseInt(document.getElementById('qty-' + rowId).value) || 0;
    
    // Check if it's a service row
    if (row.classList.contains('service-row')) {
        price = parseFloat(document.getElementById('service-price-' + rowId).value) || 0;
    } else {
        const priceText = document.getElementById('price-' + rowId).textContent;
        price = parseFloat(priceText.replace('‚Ç¨ ', '')) || 0;
    }
    
    const total = price * quantity;
    document.getElementById('total-' + rowId).textContent = '‚Ç¨ ' + total.toFixed(2);
    updateTotals();
}

function updateAllPrices() {
    const rows = document.querySelectorAll('[id^="row-"]');
    rows.forEach(row => {
        const rowId = row.id.split('-')[1];
        if (!row.classList.contains('service-row')) {
            updateRowData(rowId);
        }
    });
}

function updateTotals() {
    const totalCells = document.querySelectorAll('[id^="total-"]');
    let subtotal = 0;
    totalCells.forEach(cell => {
        const value = parseFloat(cell.textContent.replace('‚Ç¨ ', '')) || 0;
        subtotal += value;
    });
    const discountPercent = parseFloat(document.getElementById('sconto').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const imponibile = subtotal - discountAmount;
    const iva = imponibile * 0.22;
    const totale = imponibile + iva;
    document.getElementById('subtotale').textContent = '‚Ç¨ ' + subtotal.toFixed(2);
    document.getElementById('discount-percent').textContent = discountPercent.toFixed(1);
    document.getElementById('sconto-amount').textContent = '‚Ç¨ ' + discountAmount.toFixed(2);
    document.getElementById('imponibile').textContent = '‚Ç¨ ' + imponibile.toFixed(2);
    document.getElementById('iva').textContent = '‚Ç¨ ' + iva.toFixed(2);
    document.getElementById('totale').textContent = '‚Ç¨ ' + totale.toFixed(2);
}

function removeRow(rowId) {
    const row = document.getElementById('row-' + rowId);
    if (row) {
        row.remove();
        updateTotals();
    }
}

function saveQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('‚ùå Inserisci un nome per il preventivo!', 'error');
        return;
    }
    const quote = {
        id: Date.now(),
        name: quoteName,
        cliente: document.getElementById('cliente').value,
        clientePiva: document.getElementById('clientePiva').value,
        contatti: document.getElementById('contatti').value,
        carico: document.getElementById('carico').value,
        scarico: document.getElementById('scarico').value,
        durata: document.getElementById('durata').value,
        sconto: document.getElementById('sconto').value,
        equipment: [],
        createdAt: new Date().toLocaleString('it-IT'),
        status: 'draft',
        total: parseFloat(document.getElementById('totale').textContent.replace('‚Ç¨ ', '')) || 0
    };
    
    document.querySelectorAll('[id^="row-"]').forEach(row => {
        const rowId = row.id.split('-')[1];
        const quantity = document.getElementById('qty-' + rowId) ? document.getElementById('qty-' + rowId).value : '';
        
        if (row.classList.contains('service-row')) {
            const serviceName = document.getElementById('service-name-' + rowId) ? document.getElementById('service-name-' + rowId).value : '';
            const serviceNotes = document.getElementById('service-notes-' + rowId) ? document.getElementById('service-notes-' + rowId).value : '';
            const servicePrice = document.getElementById('service-price-' + rowId) ? document.getElementById('service-price-' + rowId).value : '';
            
            if (serviceName) {
                quote.equipment.push({
                    category: 'SERVIZIO',
                    equipment: serviceName,
                    quantity: parseInt(quantity),
                    notes: serviceNotes,
                    price: parseFloat(servicePrice),
                    isService: true
                });
            }
        } else {
            const category = document.getElementById('category-' + rowId) ? document.getElementById('category-' + rowId).value : '';
            const equipment = document.getElementById('equipment-' + rowId) ? document.getElementById('equipment-' + rowId).value : '';
            
            if (category && equipment) {
                quote.equipment.push({
                    category, equipment, quantity: parseInt(quantity), isService: false
                });
            }
        }
    });
    
    savedQuotes.push(quote);
    saveQuoteToSheets(quote);
    renderSavedQuotes();
    updateAnalytics();
    showNotification('‚úÖ Preventivo "' + quoteName + '" salvato!', 'success');
}

function loadQuoteById(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    document.getElementById('quoteName').value = quote.name;
    document.getElementById('cliente').value = quote.cliente;
    document.getElementById('clientePiva').value = quote.clientePiva || '';
    document.getElementById('contatti').value = quote.contatti;
    document.getElementById('carico').value = quote.carico;
    document.getElementById('scarico').value = quote.scarico;
    document.getElementById('durata').value = quote.durata;
    document.getElementById('sconto').value = quote.sconto;
    document.getElementById('equipmentRows').innerHTML = '';
    rowCounter = 0;
    
    quote.equipment.forEach(item => {
        if (item.isService) {
            addServiceRow();
            document.getElementById('service-name-' + rowCounter).value = item.equipment;
            document.getElementById('service-notes-' + rowCounter).value = item.notes || '';
            document.getElementById('service-price-' + rowCounter).value = item.price || '';
            document.getElementById('qty-' + rowCounter).value = item.quantity;
            updateRowTotal(rowCounter);
        } else {
            addEquipmentRow();
            document.getElementById('category-' + rowCounter).value = item.category;
            updateEquipmentOptions(rowCounter);
            setTimeout(() => {
                document.getElementById('equipment-' + rowCounter).value = item.equipment;
                updateRowData(rowCounter);
                document.getElementById('qty-' + rowCounter).value = item.quantity;
                updateRowTotal(rowCounter);
            }, 100);
        }
    });
    
    showTab('quotes');
    document.querySelector('[onclick="showTab(\'quotes\')"]').classList.add('active');
    showNotification('‚úÖ Preventivo "' + quote.name + '" caricato!', 'success');
}

function duplicateQuoteById(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    loadQuoteById(quoteId);
    document.getElementById('quoteName').value = quote.name + ' - Copia';
    showNotification('üìÑ Preventivo duplicato! Modifica il nome e salva.', 'info');
}

function deleteQuote(quoteId) {
    const quote = savedQuotes.find(q => q.id === quoteId);
    if (!quote) return;
    if (confirm('Sei sicuro di voler eliminare il preventivo "' + quote.name + '"?')) {
        savedQuotes = savedQuotes.filter(q => q.id !== quoteId);
        localStorage.setItem('hubris_quotes', JSON.stringify(savedQuotes));
        renderSavedQuotes();
        updateAnalytics();
        showNotification('üóëÔ∏è Preventivo eliminato', 'info');
    }
}

function resetQuote() {
    if (confirm('Sei sicuro di voler cancellare tutto il preventivo?')) {
        document.getElementById('equipmentRows').innerHTML = '';
        document.getElementById('cliente').value = '';
        document.getElementById('clientePiva').value = '';
        document.getElementById('contatti').value = '';
        document.getElementById('carico').value = '';
        document.getElementById('scarico').value = '';
        document.getElementById('durata').value = '1';
        document.getElementById('sconto').value = '0';
        document.getElementById('quoteName').value = '';
        updateTotals();
        showNotification('üîÑ Preventivo resettato', 'info');
    }
}

// UTILITY FUNCTIONS
function filterDatabase() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#databaseBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterByCategory() {
    const selectedCategory = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('#databaseBody tr');
    if (!selectedCategory) {
        rows.forEach(row => row.style.display = '');
        return;
    }
    let showNextItems = false;
    rows.forEach(row => {
        if (row.classList.contains('category-row')) {
            const categoryText = row.textContent.trim().replace('üìÅ ', '');
            showNextItems = (categoryText === selectedCategory);
            row.style.display = showNextItems ? '' : 'none';
        } else {
            row.style.display = showNextItems ? '' : 'none';
        }
    });
}

function syncDatabase() {
    const loader = document.getElementById('syncLoader');
    const btn = document.getElementById('syncBtn');
    if (loader) loader.style.display = 'inline-block';
    if (btn) btn.disabled = true;
    loadDatabaseFromSheets().finally(() => {
        if (loader) loader.style.display = 'none';
        if (btn) btn.disabled = false;
    });
}

function syncQuotes() {
    showNotification('üîÑ Aggiornamento preventivi...', 'info');
    loadQuotesFromSheets().then(() => {
        showNotification('‚úÖ Preventivi aggiornati!', 'success');
    });
}

function updateConnectionStatus(status, message) {
    const indicator = document.getElementById('connectionStatus');
    const text = document.getElementById('connectionText');
    if (indicator) indicator.className = 'status-indicator status-' + status;
    if (text) text.textContent = message;
}

function updateSyncTime() {
    const lastSync = document.getElementById('lastSync');
    if (lastSync) lastSync.textContent = 'Ultimo sync: ' + new Date().toLocaleTimeString('it-IT');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = 'notification ' + (type || 'info');
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ANALYTICS
function updateAnalytics() {
    const thisMonth = savedQuotes.filter(q => {
        const created = new Date(q.createdAt.split(', ')[0].split('/').reverse().join('-'));
        const now = new Date();
        return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
    });
    const totalRevenue = thisMonth.reduce((sum, q) => sum + q.total, 0);
    const confirmedQuotes = savedQuotes.filter(q => q.status === 'confirmed').length;
    const conversionRate = savedQuotes.length > 0 ? (confirmedQuotes / savedQuotes.length * 100) : 0;
    document.getElementById('monthlyQuotes').textContent = thisMonth.length;
    document.getElementById('estimatedRevenue').textContent = '‚Ç¨ ' + totalRevenue.toFixed(0);
    document.getElementById('conversionRate').textContent = conversionRate.toFixed(1) + '%';
    const equipmentCount = {};
    savedQuotes.forEach(quote => {
        quote.equipment.forEach(item => {
            if (!item.isService) {
                equipmentCount[item.equipment] = (equipmentCount[item.equipment] || 0) + parseInt(item.quantity);
            }
        });
    });
    const mostRequested = Object.keys(equipmentCount).reduce((a, b) => 
        equipmentCount[a] > equipmentCount[b] ? a : b, 'N/A'
    );
    document.getElementById('topEquipment').textContent = mostRequested;
}

// PLACEHOLDER FUNCTIONS FOR FUTURE DEVELOPMENT
function addNewEquipment() {
    showNotification('üîß Funzione in sviluppo: Aggiungi nuova attrezzatura', 'info');
}

function editEquipment(category, name) {
    showNotification('üîß Funzione in sviluppo: Modifica ' + name + ' in ' + category, 'info');
}

function loadQuote() {
    if (savedQuotes.length === 0) {
        showNotification('‚ùå Nessun preventivo salvato!', 'error');
        return;
    }
    showTab('saved');
    document.querySelector('[onclick="showTab(\'saved\')"]').classList.add('active');
    showNotification('üìÇ Seleziona un preventivo dalla lista', 'info');
}

function duplicateQuote() {
    const quoteName = document.getElementById('quoteName').value;
    if (!quoteName) {
        showNotification('‚ùå Nessun preventivo da duplicare!', 'error');
        return;
    }
    document.getElementById('quoteName').value = quoteName + ' - Copia';
    showNotification('üìÑ Preventivo duplicato! Modifica il nome e salva.', 'info');
}

// INITIALIZATION
window.addEventListener('load', function() {
    // Load saved configuration
    const savedApiKey = localStorage.getItem('hubris_api_key');
    const savedSheetsId = localStorage.getItem('hubris_sheets_id');
    
    if (savedApiKey) CONFIG.API_KEY = savedApiKey;
    if (savedSheetsId) CONFIG.SHEETS_ID = savedSheetsId;
    
    if (CONFIG.API_KEY && CONFIG.SHEETS_ID) {
        initializeGoogleAPI();
    } else {
        updateConnectionStatus('offline', 'Configurazione richiesta');
        showNotification('‚öôÔ∏è Clicca su "Config" per configurare le API Google Sheets', 'warning');
    }
    
    // Load quotes from localStorage immediately
    loadQuotesFromSheets();
    
    // Auto-sync every 5 minutes if connected
    setInterval(() => {
        if (isConnected) {
            loadQuotesFromSheets();
            updateSyncTime();
        }
    }, 300000);
});

// Global error handler
window.addEventListener('error', function(e) {
    console.error('Errore globale:', e.error);
    showNotification('‚ùå Si √® verificato un errore. Controlla la console.', 'error');
});

// Prevent accidental page reload
window.addEventListener('beforeunload', function(e) {
    const hasUnsavedChanges = document.getElementById('quoteName').value || 
                           document.querySelectorAll('[id^="row-"]').length > 0;
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
</body>
</html>
